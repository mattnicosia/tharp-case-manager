<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tharp Case Manager</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #root { height: 100%; width: 100%; }
    body { background: #FAFAF8; }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script>
    (function() {
      var SUPABASE_URL = "https://chmcugvjqnrheunsfslr.supabase.co";
      var SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobWN1Z3ZqcW5yaGV1bnNmc2xyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTA2NTIsImV4cCI6MjA4NzYyNjY1Mn0.TRYkXI5fj4zNucDSk_5gluFmDnWmCtmZh-kMN2iSpJc";
      var sb = null;
      if (SUPABASE_URL && SUPABASE_KEY && window.supabase) {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("[Storage] Supabase cloud storage ACTIVE");
      } else {
        console.log("[Storage] Using localStorage only (offline mode)");
      }
      window.storage = {
        get: function(key) {
          if (sb) {
            return sb.from("app_data").select("value").eq("key", key).single()
              .then(function(res) {
                if (res.data && res.data.value) {
                  try { localStorage.setItem(key, JSON.stringify(res.data.value)); } catch(e) {}
                  return { value: JSON.stringify(res.data.value) };
                }
                var v = localStorage.getItem(key);
                return v != null ? { value: v } : null;
              })
              .catch(function(err) {
                console.warn("[Storage] Cloud read failed:", err.message);
                var v = localStorage.getItem(key);
                return v != null ? { value: v } : null;
              });
          }
          var v = localStorage.getItem(key);
          return Promise.resolve(v != null ? { value: v } : null);
        },
        set: function(key, value) {
          try { localStorage.setItem(key, value); } catch(e) {}
          if (sb) {
            var parsed;
            try { parsed = JSON.parse(value); } catch(e) { parsed = value; }
            return sb.from("app_data").upsert({ key: key, value: parsed }, { onConflict: "key" })
              .then(function(res) {
                if (res.error) console.warn("[Storage] Cloud write failed:", res.error.message);
              })
              .catch(function(err) {
                console.warn("[Storage] Cloud write error:", err.message);
              });
          }
          return Promise.resolve();
        }
      };
      window._storageMode = sb ? "cloud" : "local";
      window._sb = sb;
      window._openaiKey = localStorage.getItem("tharp-openai-key") || "";
    })();
  </script>
  <script type="text/babel" data-type="module">
const { useState, useEffect, useCallback } = React;

// ── Google Fonts ──────────────────────────────────────────────────────────────
const fontLink = document.createElement("link");
fontLink.rel = "stylesheet";
fontLink.href = "https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&display=swap";
document.head.appendChild(fontLink);

// ── Design Tokens ─────────────────────────────────────────────────────────────
const T = {
  bg: "#FAFAF8",
  surface: "#FFFFFF",
  surfaceHover: "#F5F4F1",
  border: "#E8E6E1",
  borderStrong: "#D4D0C8",
  text: "#1A1814",
  textMid: "#5C5852",
  textMuted: "#8A867F",
  accent: "#C8942A",
  accentBg: "#FFF8EC",
  accentBorder: "#F0D28A",
  red: "#DC2626",
  redBg: "#FEF2F2",
  redBorder: "#FECACA",
  amber: "#D97706",
  amberBg: "#FFFBEB",
  amberBorder: "#FDE68A",
  blue: "#2563EB",
  blueBg: "#EFF6FF",
  blueBorder: "#BFDBFE",
  green: "#16A34A",
  greenBg: "#F0FDF4",
  greenBorder: "#BBF7D0",
  purple: "#7C3AED",
  purpleBg: "#F5F3FF",
  purpleBorder: "#DDD6FE",
  navBg: "#1A1814",
  navText: "#9E9A93",
  navActive: "#FFFFFF",
  font: "'DM Sans', system-ui, -apple-system, sans-serif",
  mono: "'DM Mono', 'Fira Code', monospace",
  // Shadows
  sh1: "0 1px 2px rgba(0,0,0,0.04), 0 1px 4px rgba(0,0,0,0.03)",
  sh2: "0 2px 8px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04)",
  sh3: "0 8px 24px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04)",
  // Transitions
  fast: "all 0.12s ease",
  med: "all 0.2s ease",
};

// ── Icon System (inline SVG) ─────────────────────────────────────────────────
function Ic({ name, size = 16, color = "currentColor", sw = 1.75, style = {} }) {
  const P = {
    "file-text":    "M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z|M14 2v6h6|M16 13H8|M16 17H8|M10 9H8",
    "folder":       "M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z",
    "dollar":       "M12 1v22|M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6",
    "refresh":      "M23 4v6h-6|M1 20v-6h6|M3.51 9a9 9 0 0114.85-3.36L23 10|M20.49 15a9 9 0 01-14.85 3.36L1 14",
    "mail":         "M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z|M22 6l-10 7L2 6",
    "receipt":      "M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1z|M16 8H8|M16 12H8|M10 16H8",
    "search":       "M19 19l-4.35-4.35|M11 19a8 8 0 100-16 8 8 0 000 16z",
    "camera":       "M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z|M12 13a4 4 0 100-8 4 4 0 000 8z",
    "scale":        "M16 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z|M2 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z|M7 21h10|M12 3v18|M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2",
    "book":         "M4 19.5A2.5 2.5 0 016.5 17H20|M4 19.5A2.5 2.5 0 006.5 22H20V2H6.5A2.5 2.5 0 004 4.5v15z",
    "bar-chart":    "M12 20V10|M18 20V4|M6 20v-4",
    "edit":         "M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7|M18.5 2.5a2.12 2.12 0 013 3L12 15l-4 1 1-4 9.5-9.5z",
    "image":        "M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z|M8.5 10a1.5 1.5 0 100-3 1.5 1.5 0 000 3z|M21 15l-5-5L5 21",
    "zap":          "M13 2L3 14h9l-1 10 10-12h-9l1-10z",
    "settings":     "M12 15a3 3 0 100-6 3 3 0 000 6z|M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z",
    "cloud":        "M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z",
    "key":          "M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.78 7.78 5.5 5.5 0 017.78-7.78zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4",
    "check":        "M20 6L9 17l-5-5",
    "alert":        "M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z|M12 9v4|M12 17h.01",
    "flag":         "M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z|M4 22V15",
    "x":            "M18 6L6 18|M6 6l12 12",
    "map-pin":      "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z|M12 10a3 3 0 100-6 3 3 0 000 6z",
    "shield":       "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z",
    "users":        "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2|M9 11a4 4 0 100-8 4 4 0 000 8z|M23 21v-2a4 4 0 00-3-3.87|M16 3.13a4 4 0 010 7.75",
    "upload":       "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4|M17 8l-5-5-5 5|M12 3v12",
    "chevron-r":    "M9 18l6-6-6-6",
    "clipboard":    "M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2|M9 2h6a1 1 0 011 1v1a1 1 0 01-1 1H9a1 1 0 01-1-1V3a1 1 0 011-1z",
    "trending-up":  "M23 6l-9.5 9.5-5-5L1 18|M17 6h6v6",
    "crosshair":    "M12 22a10 10 0 100-20 10 10 0 000 20z|M22 12h-4|M6 12H2|M12 6V2|M12 22v-4",
  };
  const d = P[name];
  if (!d) return null;
  return (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none"
      stroke={color} strokeWidth={sw} strokeLinecap="round" strokeLinejoin="round"
      style={{ display: "inline-block", verticalAlign: "middle", flexShrink: 0, ...style }}>
      {d.split("|").map((seg, i) => <path key={i} d={seg} />)}
    </svg>
  );
}

// ── Constants ─────────────────────────────────────────────────────────────────
const AUDIT_FLAGS = [
  { id: "blended_rate", label: "Blended labor rate — not actual payroll", risk: "HIGH" },
  { id: "sub_as_labor", label: "Subcontractor billed as direct labor", risk: "HIGH" },
  { id: "overhead_as_material", label: "Overhead items billed as materials", risk: "HIGH" },
  { id: "missing_invoice", label: "Missing or deficient subcontractor invoice", risk: "HIGH" },
  { id: "markup_on_markup", label: "25% markup applied to already-marked-up cost", risk: "HIGH" },
  { id: "duplicate", label: "Possible duplicate billing", risk: "HIGH" },
  { id: "no_timesheet", label: "No timesheet or payroll support for labor hours", risk: "MEDIUM" },
  { id: "rate_anomaly", label: "Labor rate anomaly vs trade classification", risk: "MEDIUM" },
  { id: "no_scope_desc", label: "Invoice lacks scope description or dates", risk: "MEDIUM" },
  { id: "owner_supplied", label: "Owner-supplied material billed incorrectly", risk: "MEDIUM" },
  { id: "co_missing", label: "Change order work billed without signed CO", risk: "MEDIUM" },
  { id: "retainage_error", label: "Retainage calculation error", risk: "LOW" },
];

const OWNER_CLAIMS_INITIAL = [
  { id: 1, description: "Incorrect insulation R38 vs R49 — 10yr energy cost", ownerAmount: 3000, agreedAmount: 0, status: "WAIVED", defense: "Architect failed to distribute revised plans. Owner declined upgrade twice. Consequential damages waived §21.11.", strength: "STRONG" },
  { id: 2, description: "Misplaced electrical switches — too far from doors", ownerAmount: 15000, agreedAmount: 3300, status: "AGREED", defense: "7 switches agreed at actual value $3,300.", strength: "MODERATE" },
  { id: 3, description: "Air return placement — guest room & bedroom 1", ownerAmount: 15000, agreedAmount: 0, status: "DISPUTED", defense: "Existing framing prohibited placement. Weekly architect meetings confirmed soffit locations. Owner refused mechanical engineer.", strength: "STRONG" },
  { id: 4, description: "Fireplace — stone sloppy, blue board showing, chips", ownerAmount: 45000, agreedAmount: 0, status: "DISPUTED", defense: "Manufacturer rep approved photos. Owner selected stone type/color. Durock per spec. Corrective work offered and refused.", strength: "STRONG" },
  { id: 5, description: "Construction delays Nov 2021–May 2023 / rental income", ownerAmount: 26600, agreedAmount: 0, status: "WAIVED", defense: "Consequential damages WAIVED §21.11. 125 COs caused delay. Owner refused to document changes.", strength: "STRONG" },
  { id: 6, description: "Shower glass cannot be installed as one piece", ownerAmount: 3000, agreedAmount: 0, status: "DISPUTED", defense: "Plan A-402 shows 3 equal panes. One-piece requires wall demo + crane. Not in contract documents.", strength: "STRONG" },
  { id: 7, description: "Dining room + kitchen floor replacement", ownerAmount: 25000, agreedAmount: 9719.38, status: "AGREED", defense: "MC acknowledged dining room flood damage. Kitchen floor undamaged. Agreed value = actual replacement cost.", strength: "MODERATE" },
  { id: 8, description: "Re-do roofing — curled/mismatched shingles", ownerAmount: 8500, agreedAmount: 0, status: "DISPUTED", defense: "Manufacturer confirmed common nailing scenario. Minor modifications sufficient. Roofing sub will correct.", strength: "MODERATE" },
  { id: 9, description: "Install two quiet air handlers (upgrade)", ownerAmount: 14000, agreedAmount: 0, status: "DISPUTED", defense: "Upgrade beyond designed system. No MEP spec provided. Installed under budget.", strength: "STRONG" },
  { id: 10, description: "Primary bedroom beams don't match at seam", ownerAmount: 3000, agreedAmount: 600, status: "AGREED", defense: "Replacement beam ordered at no cost. Credit = 2 carpenters × 4 hrs.", strength: "MODERATE" },
  { id: 11, description: "Additional living room insulation to R49", ownerAmount: 2000, agreedAmount: 0, status: "DISPUTED", defense: "Owner declined upgrade twice. Change order work, not base contract.", strength: "STRONG" },
  { id: 12, description: "Painting supply/return covers — wrong color", ownerAmount: 1000, agreedAmount: 1000, status: "AGREED", defense: "Agreed.", strength: "N/A" },
  { id: 13, description: "Kitchen bluestone walkway construction damage", ownerAmount: 1000, agreedAmount: 1000, status: "AGREED", defense: "Agreed.", strength: "N/A" },
  { id: 14, description: "New ceiling fan — primary bedroom", ownerAmount: 800, agreedAmount: 800, status: "AGREED", defense: "Agreed.", strength: "N/A" },
  { id: 15, description: "Re-stain spiral stair treads", ownerAmount: 600, agreedAmount: 600, status: "AGREED", defense: "Agreed.", strength: "N/A" },
  { id: 16, description: "Re-stain step to cow barn and cow barn floor", ownerAmount: 750, agreedAmount: 250, status: "AGREED", defense: "Agreed re-stain step. Cow barn floor adequately installed.", strength: "N/A" },
  { id: 17, description: "Wrong ceiling on kitchen porch", ownerAmount: 900, agreedAmount: 900, status: "AGREED", defense: "Agreed.", strength: "N/A" },
  { id: 18, description: "Front door framing / windows / siding uneven", ownerAmount: 8500, agreedAmount: 2260, status: "AGREED", defense: "MC replacing door trim at no cost. Windows correct. Agreed on siding.", strength: "MODERATE" },
  { id: 19, description: "French drain — basement leaked for months", ownerAmount: 10000, agreedAmount: 0, status: "DISPUTED", defense: "Existing drain installed upside down pre-Montana. No monetary basement damage caused.", strength: "STRONG" },
  { id: 20, description: "Molding around french doors — incorrect measurement", ownerAmount: 3000, agreedAmount: 1140, status: "AGREED", defense: "Agreed concept, corrected value.", strength: "N/A" },
  { id: 21, description: "Lost/stolen Kohler sink", ownerAmount: 99, agreedAmount: 0, status: "DISPUTED", defense: "Client-ordered fixture. Replacement obtained at no cost.", strength: "MODERATE" },
  { id: 22, description: "Repair and paint pantry wall and ceiling", ownerAmount: 1000, agreedAmount: 1000, status: "AGREED", defense: "Agreed.", strength: "N/A" },
  { id: 23, description: "Most doors not hung properly — gaps, rattle", ownerAmount: 3000, agreedAmount: 0, status: "DISPUTED", defense: "Punchlist work — will complete upon receipt of past-due payment.", strength: "MODERATE" },
  { id: 24, description: "12-month warranty escrow for winter systems", ownerAmount: 10000, agreedAmount: 0, status: "DISPUTED", defense: "Warranties issue upon final payment per contract. Owner's withholding creates this condition.", strength: "STRONG" },
];

// Excel CM Tracker line items per req (trade breakdown)
const EXCEL_TRADES = {
  1:  { "Demolition & Protection": 20331.61, "Containers & Waste Removal": 6458.15, "Framing (Material)": 1908.84, "HVAC": 7600.00 },
  2:  { "Demolition & Protection": 17190.00, "Containers & Waste Removal": 2460.63, "Concrete": 7253.00, "Framing (Material)": 30627.23, "Framing (Labor)": 11020.00, "Insulation": 160.40, "Drywall & Carpentry": 678.53, "Electric": 15000.00 },
  3:  { "Concrete": 15849.00, "Framing (Material)": 8055.58, "Framing (Labor)": 10300.00, "Plumbing": 7600.00, "Electric": 20000.00, "Excavation and Fill": 7549.33 },
  4:  { "Demolition & Protection": 12838.39, "Containers & Waste Removal": 1097.88, "Concrete": 3898.00, "Railing (Allowance)": 5250.00, "Framing (Material)": 20606.47, "Composite Roof Shingles": 921.63, "Drywall & Carpentry": 321.72, "Plumbing": 13950.00, "HVAC": 20465.00, "Earthwork": 288.17 },
  5:  { "Masonry": 1945.00, "Framing (Material)": 5551.22, "Framing (Labor)": 23075.00, "Composite Roof Shingles": 9089.77, "Siding and Related Trim": 13462.03, "Windows": 8325.00, "Drywall & Carpentry": 270.92, "Electric": 12000.00, "Excavation and Fill": 2670.00 },
  6:  { "Containers & Waste Removal": 669.76, "Masonry": 3000.00, "Framing (Material)": 1895.43, "Framing (Labor)": -2387.21, "Composite Roof Shingles": 19016.50, "Siding and Related Trim": 4172.95, "Drywall & Carpentry": 10113.86 },
  7:  { "Containers & Waste Removal": 785.94, "Concrete": 24.11, "Masonry": 8910.00, "Railing (Allowance)": 2396.04, "Framing (Material)": 387.21, "Stairs & Railings (Allowance)": 9841.81, "Composite Roof Shingles": 1642.96, "Siding and Related Trim": 4067.88, "Drywall & Carpentry": 12000.00, "HVAC": 10800.00, "Electric": 20948.63 },
  8:  { "Containers & Waste Removal": 694.64, "Railing (Allowance)": 2708.15, "Framing (Material)": 95.49, "Framing (Labor)": 3600.00, "Stairs & Railings (Allowance)": 9841.67, "Composite Roof Shingles": 21393.59, "Siding and Related Trim": 12776.03, "Windows": 825.00, "Drywall & Carpentry": 15000.00, "Tile": 34925.00, "Wood Flooring": 27000.00, "HVAC": 4177.43, "Electric": 20695.00 },
  9:  { "Framing (Material)": 79.87, "Stairs & Railings (Allowance)": 6375.00, "Composite Roof Shingles": 107.29, "Siding and Related Trim": 11897.58, "Tile": 325.00, "Painting": 13565.00, "Cooling": 3102.70 },
  10: { "Materials (GC)": 623.70, "Demolition & Protection": 360.00, "Concrete": 375.00, "Masonry": 20.37, "Framing (Material)": 476.99, "Framing (Labor)": 675.00, "Composite Roof Shingles": 518.82, "Siding and Related Trim": 7740.00, "Doors, Frames & HW": 9113.04, "Drywall & Carpentry": 2446.74, "HVAC": 8735.00 },
  11: { "Containers & Waste Removal": 672.40, "Interior Trim": 19062.47, "Siding and Related Trim": 3431.93, "Drywall & Carpentry": 75.68, "Painting": 18112.50 },
  12: { "Interior Trim": 4639.64, "Gutters & Leaders": 10200.00, "Doors, Frames & HW": 16.03, "Painting": 24580.00 },
  13: { "Concrete": -24.11, "Masonry": -9902.87, "Railing (Allowance)": -2737.85, "Custom Casework": 3975.00, "Framing (Material)": -556.86, "Framing (Labor)": -2400.00, "Stairs & Railings (Allowance)": -720.00, "Interior Trim": 11548.96, "Insulation": 4599.68, "Composite Roof Shingles": 487.68, "Siding and Related Trim": 8300.66, "Doors, Frames & HW": -5151.53, "Windows": -825.00, "Drywall & Carpentry": -7992.49, "Tile": -12100.00, "Wood Flooring": -7325.22, "HVAC": -8545.13, "Electric": -41823.63, "Excavation and Fill": -1200.00 },
  14: { "Masonry": 75.00, "Custom Casework": 2081.25, "Stairs & Railings (Allowance)": 6619.40, "Interior Trim": 1291.71, "Drywall & Carpentry": 11159.69, "Wood Flooring": 20225.22, "Painting": -1997.50, "HVAC": 72615.00 },
  15: { "Railing (Allowance)": 7440.00, "Stairs & Railings (Allowance)": -7440.00, "Siding and Related Trim": 146.31, "Electric": 5015.00 },
  16: { "Foundation Waterproofing": 500.00, "Sawcutting": 8000.00, "Masonry": 20382.13, "Railing (Allowance)": 4943.66, "Custom Casework": 41793.75, "Insulation": 15819.92, "Doors, Frames & HW": 22622.47, "Shower Enclosures": 20000.00, "Windows": 6675.00, "Drywall & Carpentry": 5125.35, "Tile": 2700.00, "Wood Flooring": 1950.00, "Painting": 240.00, "Plumbing": 15450.00, "Electric": 49940.00, "Excavation and Fill": 8192.50, "Cooling": -3102.70 },
};

// ── BACKUP VARIANCE DATA ─────────────────────────────────────────────────────
// amountBilled = Cost of Work including COs (from variance analysis, Column D)
// backupDocs   = Sum of third-party invoices on file (Column E)
// directLabor  = Self-performed work by Montana Contracting (no third-party invoice)
const BACKUP_VARIANCE = {
  1:  { amountBilled: 48298.60,  backupDocs: 48195.09,  directLabor: 0, items: [] },
  2:  { amountBilled: 84389.79,  backupDocs: 77879.79,  directLabor: 6510.00, items: [
    { trade: "2100 Demolition", desc: "Self-Performed Demolition", vendor: "Montana Contracting", amount: 5790.00 },
    { trade: "6400-S Framing Labor", desc: "Self-Performed Framing", vendor: "Montana Contracting", amount: 720.00 },
  ]},
  3:  { amountBilled: 81849.11,  backupDocs: 85453.91,  directLabor: 0, items: [] },
  4:  { amountBilled: 103325.37, backupDocs: 71981.16,  directLabor: 0, items: [] },
  5:  { amountBilled: 76388.94,  backupDocs: 111522.67, directLabor: 0, items: [] },
  6:  { amountBilled: 61164.66,  backupDocs: 55312.79,  directLabor: 11850.00, items: [
    { trade: "CO#20 Framing Changes", desc: "Ceiling Padding — Living Room", vendor: "Montana Contracting", amount: 2700.00 },
    { trade: "CO#20 Framing Changes", desc: "Exterior Wall Height — Gym/Closet", vendor: "Montana Contracting", amount: 2400.00 },
    { trade: "CO#20 Framing Changes", desc: "Reframing and New Wall — Cow Barn 2nd Fl", vendor: "Montana Contracting", amount: 1200.00 },
    { trade: "CO#20 Framing Changes", desc: "Low Voltage Closet — Primary Suite", vendor: "Montana Contracting", amount: 1200.00 },
    { trade: "CO#20 Framing Changes", desc: "Floor Reframing — Powder Room", vendor: "Montana Contracting", amount: 1200.00 },
    { trade: "CO#20 Framing Changes", desc: "Shower Wall Padding — Primary Suite", vendor: "Montana Contracting", amount: 900.00 },
    { trade: "CO#20 Framing Changes", desc: "Door & Wall Relocation — Primary Suite", vendor: "Montana Contracting", amount: 600.00 },
    { trade: "CO#20 Framing Changes", desc: "Attic Plywood Flooring — Gym/Closet", vendor: "Montana Contracting", amount: 450.00 },
    { trade: "CO#20 Framing Changes", desc: "Reframing of Window Opening — Powder Room", vendor: "Montana Contracting", amount: 300.00 },
    { trade: "CO#20 Framing Changes", desc: "Wall Framing Modifications — Mudroom", vendor: "Montana Contracting", amount: 300.00 },
    { trade: "CO#20 Framing Changes", desc: "Laundry Closet — Gym", vendor: "Montana Contracting", amount: 225.00 },
    { trade: "CO#20 Framing Changes", desc: "Minor Modifications Under Tub — Primary Suite", vendor: "Montana Contracting", amount: 150.00 },
    { trade: "CO#20 Framing Changes", desc: "Attic Access Ladder Opening — Gym/Closet", vendor: "Montana Contracting", amount: 150.00 },
    { trade: "CO#20 Framing Changes", desc: "New Window Installation — Powder Room", vendor: "Montana Contracting", amount: 75.00 },
  ]},
  7:  { amountBilled: 72117.01,  backupDocs: 72366.73,  directLabor: 0, items: [] },
  8:  { amountBilled: 153732.00, backupDocs: 161769.79, directLabor: 4860.00, items: [
    { trade: "6400-S Framing Labor", desc: "Self-Performed Framing", vendor: "Montana Contracting", amount: 1200.00 },
    { trade: "7460 Siding", desc: "Self-Performed Siding", vendor: "Montana Contracting", amount: 3660.00 },
  ]},
  9:  { amountBilled: 40289.22,  backupDocs: 39642.74,  directLabor: 0, items: [] },
  10: { amountBilled: 72334.79,  backupDocs: 61384.79,  directLabor: 16230.00, items: [
    { trade: "2100 Demolition", desc: "Self-Performed Demolition (4 hrs; partial realloc → PCCO#68)", vendor: "Montana Contracting", amount: 600.00 },
    { trade: "3100 Concrete", desc: "Self-Performed Concrete Work", vendor: "Montana Contracting", amount: 375.00 },
    { trade: "6400-S Framing Labor", desc: "Self-Performed Framing (38 hrs; partial realloc → PCCO#64, #67)", vendor: "Montana Contracting", amount: 3525.00 },
    { trade: "7460 Siding", desc: "Self-Performed Siding (24 hrs partial realloc → PCCO#66)", vendor: "Montana Contracting", amount: 9180.00 },
    { trade: "9200 Drywall & Carpentry", desc: "Self-Performed Drywall/Install (10 hrs realloc → PCCO#65)", vendor: "Montana Contracting", amount: 2550.00 },
  ]},
  11: { amountBilled: 74121.03,  backupDocs: 62449.13,  directLabor: 0, items: [] },
  12: { amountBilled: 57465.48,  backupDocs: 55871.07,  directLabor: 0, items: [] },
  13: { amountBilled: 147391.18, backupDocs: 147271.75, directLabor: 0, items: [] },
  14: { amountBilled: 205051.14, backupDocs: 192733.58, directLabor: 15862.50, items: [
    { trade: "4200 Masonry", desc: "Self-Performed Masonry", vendor: "Montana Contracting", amount: 75.00 },
    { trade: "6200 Custom Casework", desc: "Self-Performed Casework (partial realloc → PCCO#120)", vendor: "Montana Contracting", amount: 2550.00 },
    { trade: "6400-S Interior Trim", desc: "Self-Performed Trim Work", vendor: "Montana Contracting", amount: 225.00 },
    { trade: "9200 Drywall & Carpentry", desc: "Self-Performed Drywall/Carpentry (partial realloc → Decking CO, PCCO#120, #121)", vendor: "Montana Contracting", amount: 13012.50 },
  ]},
  15: { amountBilled: 5161.31,   backupDocs: 5161.31,   directLabor: 0, items: [] },
  16: { amountBilled: 188369.02, backupDocs: 0,         directLabor: 188369.02, items: [
    { trade: "Base Trade Closeout", desc: "29 base contract lines + OH&P closed to 100% of budget per AIA G702/G703 — Montana's 50% savings share captured here", vendor: "Contractual (AIA continuation sheet)", amount: 202304.38 },
    { trade: "Remaining Approved COs", desc: "18 COs billed to completion (CO#2,4,10,14,16,26,32,34,41,42,48,52,54,58,81,93,99–101,111,118,125)", vendor: "Approved CO Log", amount: 48786.58 },
    { trade: "Base Subcontract Credits", desc: "Plumbing (#8), Electric (#9), Lighting (#11), Excavation (#24), Window (#25) base credits applied", vendor: "Credit to Owner", amount: -35797.90 },
    { trade: "CO#126 Allowance Reconciliation", desc: "Unused allowance credits returned — Railing, Stair, Shutters, Doors & Frames", vendor: "Credit to Owner", amount: -19398.59 },
    { trade: "CO#127 GC/Owner Variance Split", desc: "50/50 base budget savings credit to owner (Contract §3.3.2) — 26 trades reconciled", vendor: "Credit to Owner", amount: -53111.51 },
    { trade: "CO#128 Owner-Supplied Items", desc: "25% markup on owner-provided materials (Contract §3.3) — owner refused to furnish receipts when requested 1/8/2024", vendor: "Various (owner-furnished)", amount: 45586.06 },
  ]},
};

const REQ_DEFAULTS = (i) => ({
  id: i + 1,
  reqNumber: `REQ-${String(i + 1).padStart(2, "0")}`,
  date: "",
  totalBilled: 0,        // PDF / AIA G702 certified amount
  paidAmount: 0,         // Payments received from owner
  architectApproved: 0,
  retainageHeld: 0,
  laborCost: 0,
  materialCost: 0,
  subCost: 0,
  backupStatus: "MISSING",
  flags: [],
  notes: "",
  laborRate: 60,
  hasPayrollSupport: false,
  hasInvoiceSupport: false,
  hasCheckVouchers: false,
  excelTotal: 0,         // Excel CM Tracker total (with fee)
  excelSubtotal: 0,      // Excel pre-fee subtotal
  excelFee: 0,           // Excel 25% OH&P fee
  pdfReqNum: "",         // AIA G702 application number
});

// Excel data per req: [excelTotal, excelSubtotal, excelFee, month, reqNum]
const EXCEL_DATA = [
  [45373.25,  36298.60,   9074.65,  "2022-01-01", "1"],
  [105487.24, 84389.79,  21097.45,  "2022-02-01", "2"],
  [86692.39,  69353.91,  17338.48,  "2022-03-04", "3"],
  [99546.57,  79637.26,  19909.31,  "2022-04-04", "4"],
  [95486.18,  76388.94,  19097.24,  "2022-05-05", "5"],
  [45601.61,  36481.29,   9120.32,  "2022-06-05", "6"],
  [89833.76,  71804.58,  18029.18,  "2022-07-06", "7"],
  [192165.00,153732.00,  38433.00,  "2022-08-06", "8"],
  [44315.55,  35452.44,   8863.11,  "2022-09-06", "9"],
  [38076.20,  30460.96,   7615.24,  "2022-10-07", "10"],
  [51693.73,  41354.98,  10338.75,  "2022-11-07", "11"],
  [49294.59,  39435.67,   9858.92,  "2022-12-08", "12"],
  [-90489.90,-72392.71, -18097.19,  "2023-01-08", "13R1"],
  [140087.21,112069.77,  28017.44,  "2023-04-23", "14"],
  [6451.64,   5161.31,   1290.33,   "2023-05-24", "15"],
  [235461.28, 188369.02, 47092.26,  "2024-01-30", "16"],
];

const REQS_INITIAL = Array.from({ length: 16 }, (_, i) => {
  const base = REQ_DEFAULTS(i);
  const [excelTotal, excelSubtotal, excelFee, month, pdfReqNum] = EXCEL_DATA[i];
  return { ...base, date: month, excelTotal, excelSubtotal, excelFee, pdfReqNum,
    // Auto-flag REQ-13 (negative req) and REQ-08 (largest)
    flags: i === 12 ? ["duplicate", "co_missing"] : [],
    notes: i === 12
      ? "⚠ NEGATIVE REQUISITION (-$90,489.90). REQ-13R1 represents a large credit/reconciliation req. Need to understand what was reversed and why. 19 trade lines show credits including Electric -$41,823.63, Tile -$12,100.00, Masonry -$9,902.87, Wood Flooring -$7,325.22, HVAC -$8,545.13, Drywall -$7,992.49. Possible causes: over-billing correction, disputed work removal, or scope reduction. CRITICAL: Obtain AIA G702 for this req and reconcile each reversal with a specific justification."
      : i === 7
      ? "REQ-08 is the largest single requisition at $192,165. 13 active trade lines including Tile $34,925, Wood Flooring $27,000, Electric $20,695, Composite Roof $21,394, Siding $12,776, Drywall $15,000. High priority for PDF backup review."
      : "",
  };
});

// Override REQ-01 with PDF-derived data (already reviewed)
REQS_INITIAL[0] = {
  ...REQS_INITIAL[0],
  totalBilled: 60373.25,
  paidAmount: 60373.25,
  architectApproved: 60373.25,
  retainageHeld: 0,
  laborCost: 18360.00,
  materialCost: 759.07,
  subCost: 0,
  backupStatus: "PARTIAL",
  laborRate: 60,
  hasPayrollSupport: true,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["blended_rate", "sub_as_labor", "overhead_as_material"],
  notes: `Period: 12/15/21–01/15/22. AIA G702 App No. 1, certified $60,373.25. Excel CM Tracker: $45,373.25.
VARIANCE: +$15,000.00 — Kitchen Radiant CO (PCO#003) billed on G702 but tracked separately in Excel.

LINE ITEMS (G703): Demolition $20,331.61 · Containers $6,458.15 · Framing Material $1,908.84 · HVAC $7,600.00 · OH&P $9,074.65 · CO Kitchen Radiant $15,000.00

LABOR ($18,360 @ $60/hr): Sandoval, Ficucello, Grosso, Yuvienco, Avelino, Falsetti
⚠ DSL Landscaping 3-man crew (24hrs @ $60 = $1,440) — sub billed as direct labor
⚠ DSL Landscaping 2-man crew (16hrs @ $60 = $960) — sub billed as direct labor
⚠ DSL Landscaping multiple days 1/12–1/14 — same issue

MATERIALS: Builders FirstSource $264.65 (framing — OK) · Beckerle tempered hardboard $52.02 (OK)
⚠ Beckerle saw blades $28.11 — tools, §9.3.1 contractor's responsibility
⚠ Beckerle 3M dust masks $22.77 — overhead, §9.3.1 contractor's responsibility
Total overhead-as-materials exposure this req: $50.88 minimum`,
};

// Override REQ-02 with PDF-derived data (Invoice #2.pdf — 30 pages reviewed)
REQS_INITIAL[1] = {
  ...REQS_INITIAL[1],
  totalBilled: 105487.24,
  paidAmount: 105487.24,
  architectApproved: 105487.24,
  retainageHeld: 0,
  laborCost: 11020.00,
  materialCost: 31516.16,
  subCost: 41853.63,
  backupStatus: "PARTIAL",
  laborRate: 60,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["missing_invoice", "overhead_as_material", "no_scope_desc", "no_timesheet"],
  notes: `Period: 02/01/22–02/28/22. AIA G702 App No. 2, Invoice No. 2, certified $105,487.24. Excel CM Tracker: $105,487.24.
VARIANCE: $0.00 — PDF and Excel totals match exactly.

G703 LINE ITEMS (THIS PERIOD):
Demolition $17,190.00 · Containers/Waste $2,460.63 · Concrete $7,253.00 · Framing Material $30,627.23 · Framing Labor $11,020.00 · Insulation $160.40 · Drywall $678.53 · Electric $15,000.00 · OH&P (25%) $21,097.45
CHANGE ORDERS: PCO#001 Basement Boiler Piping $10,000 (0% this period) · PCO#003 Kitchen Radiant $15,000 (100% previous, 0% this period)

BACKUP INVOICES:
Patriot Saw Cuts #23376: $11,400 sawcutting concrete 3 areas (adequate)
Robert Hiep Inc: $523.97+ waste removal 30-yd roll off + dumping (adequate)
Concrete sub est. #1361: $7,253 slab poured (adequate)
Builders FirstSource #57135683: ~$27,381 framing lumber/LVL beams/CDX plywood (adequate)
Builders FirstSource #57244457: $109.46 treated lumber (adequate)
Builders FirstSource: $163.30 treated 2x4s (adequate)
Beckerle Lumber: $50.94 foam insulation R-10 (adequate)
Home Depot: $75.78 masonry nails + Sakrete expansion joints (adequate)
Home Depot: $194.97 Ficucello Thomas (adequate)
Lowe's: $173.49 repair jamb bracket, baseboard end cap, misc (adequate)

⚠ DeLeonardis Electric #2544/2681-T: $15,000 "Mobilization Due With This REQUISITION #01" — DEFICIENT: no scope of work, no hours, no work description. Same job tickets 2544/2681 flagged in priority audit items.
⚠ H&J Improvements #1316: $10,300 "Labor only for framing partial payment" — DEFICIENT: no dates, hours, workers, or scope description. Same deficient invoice format as REQ-01.
Total deficient sub invoices: $25,300

⚠ Beckerle Lumber: $17.34 rock salt (50lb Halite) — overhead per §9.3.1, not a reimbursable cost
⚠ Home Depot: $3.97 Rain-X windshield deicer — overhead per §9.3.1, not a reimbursable cost
Total overhead-as-materials exposure this req: $21.31 minimum

CRITICAL: NO TIMESHEETS or payroll records in entire 30-page backup. Framing Labor $11,020 billed with only H&J Improvements deficient sub invoice as support.`,
};

// Override REQ-03 with PDF-derived data (Invoice #3.pdf — 38 pages reviewed)
REQS_INITIAL[2] = {
  ...REQS_INITIAL[2],
  totalBilled: 102311.39,
  paidAmount: 100511.39,
  architectApproved: 102311.39,
  retainageHeld: 0,
  laborCost: 10300.00,
  materialCost: 8055.58,
  subCost: 51098.33,
  backupStatus: "PARTIAL",
  laborRate: 60,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["duplicate", "missing_invoice", "overhead_as_material", "no_scope_desc", "no_timesheet"],
  notes: `Period: 03/01/22–03/31/22. AIA G702 App No. 3, Invoice No. 3, certified $102,311.39. Excel CM Tracker: $86,692.39.
VARIANCE: +$15,619.00 — Change orders billed on G703 (PCO#006 Gas Main $4,869 + PCO#008 Underground Plumbing $10,750) tracked separately in Excel.

G703 BASE CONTRACT LINE ITEMS (THIS PERIOD $86,692.39):
Concrete $15,849.00 · Framing Material $8,055.58 · Framing Labor $10,300.00 · Plumbing $7,600.00 · Electric $20,000.00 · Excavation and Fill $7,549.33 · OH&P (25%) $17,338.48
CHANGE ORDERS THIS PERIOD ($15,619.00): PCO#006 Gas Main $4,869.00 · PCO#008 Underground Plumbing $10,750.00
CO SUMMARY: 16 PCOs listed (net $69,523.03). Previous COs: $25,000. New this month: $99,592.03 additions / ($55,069.00) deductions.

BACKUP INVOICES:
Echo Stamp Concrete #1784: $15,849 footings/walls (adequate — detailed scope w/ cost codes)
Echo Stamp Concrete #1786: $8,500 repour 26 LF wall per CO 1374 (adequate — CO work)
Builders FirstSource (multiple): ~$3,017 framing lumber/CDX/hardware across 5+ invoices (adequate)
Smith Cooling & Heating: $7,600 plumbing 20% progress on $38K contract (adequate — detailed scope)
Smith Cooling & Heating CO: $3,900 gas main supply/install per CO #2 (adequate — detailed scope)
DeLeonardis Electric REQ.2: $20,000 — shows contract breakdown ($51,835 base + $21,535 CO = $73,370 total), includes retainage calc
Paul Bitts Co #22-52: $8,100 excavation with dated line items (adequate)
Beckerle Lumber #2202-285066: $468.18 2x4 douglas fir (adequate)
Rockland Masonry Depot: $671.38 + $285.95 sand/materials (adequate)
Home Depot (multiple): $79.02 + $353.53 + $39.98 + $84.47

⚠ DUPLICATE: H&J Improvements #1316: $10,300 "Labor only for framing partial payment" — SAME INVOICE NUMBER (#1316) and SAME AMOUNT ($10,300) as REQ-02. Date 2/16/22. Potential duplicate billing across requisitions.
⚠ DeLeonardis Electric: $20,000 — sub invoice shows 10% retainage withheld ($2,000) but G702 shows 0% retainage to owner. Retainage discrepancy.
⚠ H&J Improvements: Still deficient — no dates, hours, workers, or scope description.

⚠ Home Depot overhead-as-materials (§9.3.1):
  11-in-1 multi-bit screwdriver $15.97 · Non-contact voltage tester $19.97 · HDX 55" shingle stripper $62.00 · 4-outlet metal power block $12.74 · 7000 lumen LED work light $218.00 · 14/3 50' extension cord $33.47
Total overhead-as-materials exposure this req: $362.15 minimum

CRITICAL: NO TIMESHEETS or payroll records in entire 38-page backup. Framing Labor $10,300 billed with only H&J Improvements deficient/duplicate sub invoice as support.`,
};

// Override REQ-04 with PDF-derived data (Invoice #4.pdf — 64 pages reviewed)
REQS_INITIAL[3] = {
  ...REQS_INITIAL[3],
  totalBilled: 129156.71,
  paidAmount: 130958.71,
  architectApproved: 129156.71,
  retainageHeld: 0,
  laborCost: 12838.39,
  materialCost: 22137.99,
  subCost: 44660.88,
  backupStatus: "PARTIAL",
  laborRate: 0,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["overhead_as_material", "missing_invoice", "no_timesheet"],
  notes: `Period: 04/01/22–04/30/22. AIA G702 App No. 4, Invoice No. 4, certified $129,156.71. Excel CM Tracker: $99,546.57.
VARIANCE: +$29,610.14 — Change orders billed on G703 this period ($29,610.13): PCO#004 Bed #2 Bath $6,312.50 + PCO#017 Demolition Credit ($8,024.00) + PCO#015 Concrete Winter $2,627.50 + PCO#020 Cow Barn Sewer Camera $468.75 + PCO#021 Framing Changes $28,225.38.
Contract Sum to date: $1,287,878.16 (original $1,183,411 + $104,467.16 COs). Total completed to date: $397,328.59 (30.85%).

G703 BASE CONTRACT THIS PERIOD ($99,546.58):
Demolition $12,838.39 (100% of $12,838.39 — now fully billed) · Containers/Waste $1,097.88 · Concrete $3,898.00 · Balcony Railing $5,250.00 · Framing Material $20,606.47 (⚠ 146.24% of $41,847 scheduled = OVER-BUDGET by $19,351.12) · Roofing $921.63 · Drywall $321.72 · Plumbing $13,950.00 · HVAC $20,465.00 · Excavation $288.17 · OH&P $19,909.32
NOTE: Framing Labor $0 this period (no H&J Improvements). Electric $0 this period (no DeLeonardis).

SUBCONTRACTOR INVOICES:
Echo Stamp Concrete #1793 (4/6/22): $6,400 original, adjusted to $3,898.00 base ($2,102 Winter Conditions + $400 Additional Pier reallocated to COs). ADEQUATE — dated, scoped, amounts reconcile.
Smith Cooling & Heating Invoice 2022-tharp: $27,900 base contract @ 50% = $13,950 + PCCO#2/CCO#1 $10,100 @ 50% = $5,050. Total $19,000. ADEQUATE — detailed fixture-by-fixture scope (Bed 2 Bath, Future Laundry, Power Room, Primary Bath).
Valley Mechanical Services #i1593 (4/29/22): HVAC — Relocate 2nd floor boiler $10,500 @ 33% = $3,465 + CO#2 radiant heat zones $17,000 @ 50% = $8,500 + additional radiant zone. Total $20,465.00. ADEQUATE — detailed scope, progress %, job codes.
Robert Hiep Inc (multiple): Container/waste removal — roll-offs and dumping. $387.81 + $309.24 + other. ADEQUATE.

MATERIAL INVOICES:
Builders FirstSource (10+ invoices): Extensive framing lumber — 2x4s, 2x6s, LVL beams, CDX plywood, T&G plywood, coil nails, joist hangers, treated lumber. All coded 6400M (framing material). Dates 03/22–04/28/22. Totals support the heavy $20,606.47 framing material billing.
Beckerle Lumber (multiple): PL adhesive, galv hardware, sill sealer, mason sand, douglas fir. Coded 6400M and 31000M.
Lowe's: $138.46 — exterior screws and PowerPro interior screws. Materials OK.
Rockland Masonry Depot #503343/3: Bluestone 3/4" bags. Materials OK.

⚠ OVERHEAD-AS-MATERIALS (§9.3.1):
Home Depot 04/14/22: DeWalt 7.8A 1/2" VSR Drill $119.00 + tax = $128.97 — POWER TOOL, clear overhead.
Home Depot 04/07/22: Anvil Plastic Putty Knife 2" $2.94 — tool.
Beckerle #2203-018802: Milwaukee 9" Sawzall Blade $21.47 — consumable tool accessory (borderline).
Total overhead-as-materials exposure this req: $153.38 minimum.

⚠ MISSING INVOICES:
Demolition $12,838.39 (100% of budget): No demolition sub invoice in backup. Robert Hiep invoices are container/roll-off only ($387-$388). Demolition appears self-performed with no labor documentation.
Balcony Railing $5,250.00: No railing sub invoice found in 64-page backup.

⚠ FRAMING MATERIAL OVER-BUDGET: $20,606.47 this period brings cumulative Framing Material to $61,198.12 vs $41,847 scheduled value = 146.24%. Over-billed by $19,351.12 against schedule of values. While individual BFS material invoices appear legitimate, the total billing exceeds the contract allocation.

CRITICAL: NO TIMESHEETS or payroll records in entire 64-page backup. Demolition $12,838.39 appears self-performed with zero labor documentation. No payroll, no time records, no crew lists.`,
};

// Override REQ-05 with PDF-derived data (Invoice #5.pdf — 44 pages reviewed)
REQS_INITIAL[4] = {
  ...REQS_INITIAL[4],
  totalBilled: 95486.18,
  paidAmount: 95486.18,
  architectApproved: 95486.18,
  retainageHeld: 0,
  laborCost: 31400.00,
  materialCost: 30318.94,
  subCost: 14670.00,
  backupStatus: "PARTIAL",
  laborRate: 75,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["overhead_as_material", "no_scope_desc", "no_timesheet", "sub_as_labor"],
  notes: `REQ-05 AUDIT — Invoice #5.pdf (44 pages) — Period: 05/01/22-05/31/22
PDF Total: $95,486.18 | Excel: $95,486.18 | Variance: $0.00
No Change Orders billed this period — all CO lines show $0.

G702 COVER SHEET:
Application No: 5 | Period: 05/01/22-05/31/22
Original Contract: $1,183,411.00 | Net COs: $104,467.16 | Contract Sum: $1,287,878.16
Total Completed to Date: $492,814.77 | Previous: $397,328.59 | This Period: $95,486.18
Retainage: $0.00

G703 BASE CONTRACT LINES THIS PERIOD:
- Masonry: $1,945.00 (NEW — 7.96% of $24,437)
- Framing Material: $5,551.22 (cumulative $66,749.34 = 159.51% of $41,847 — ⚠ OVER-BUDGET)
- Framing Labor: $23,075.00 (cumulative $44,395 = 115.61% of $38,400 — ⚠ OVER-BUDGET)
- Roofing: $9,089.77 (NEW — 21.76% of $41,773)
- Siding: $13,462.03 (NEW — 24.09% of $55,872)
- Window Installation: $8,325.00 (NEW — 55.50% of $15,000)
- Drywall: $270.92 (2.58% of $10,500)
- Electric: $12,000.00 (46.18% of $25,976 cumulative — DeLeonardis)
- Excavation: $2,670.00 (60.04% of $4,447 cumulative — Paul Bitts)
- OH&P: $19,097.24 (38.03% of $50,226)

COST BREAKDOWN:
Labor: $31,400.00 (H&J Improvements — Framing Labor $23,075 + Window Installation $8,325)
Materials: $30,318.94 (Masonry $1,945 + Framing Mat $5,551.22 + Roofing $9,089.77 + Siding $13,462.03 + Drywall $270.92)
Subs: $14,670.00 (Electric $12,000 + Excavation $2,670)
Check: $31,400 + $30,318.94 + $14,670 = $76,388.94 = Excel subtotal ✓
OH&P: $76,388.94 × 25% = $19,097.24 → Total = $95,486.18 ✓

SUBCONTRACTOR REVIEW:
1. H&J Home Improvements Corp. Invoice #1335 (5/11/22) — $31,400 total (DEFICIENT):
   Framing Labor $23,075 + Window Installation $8,325 = $31,400. Multiple copies/allocations in backup (pp.29-32).
   "Labor only for framing 5/10/22-5/16/22, 5/17/22-5/23/22" — same deficient pattern as #1316 (REQ-02/03).
   No worker names, no hours breakdown per worker, no task descriptions. Billed through G703 labor lines = sub_as_labor.
   Additional allocation: 5/3/22-5/7/22 102 hrs @ $75 = $7,650 + CO work 16 hrs @ $75 = $1,200.

2. DeLeonardis Electric #2544/2681-T (5/20/22) — $12,000 (ADEQUATE):
   Contract: Original $51,835 + CO#001 $21,535 + CO#002 $9,500 = $82,870.
   Cumulative: REQ#01 $15,000 + REQ#02 $20,000 + REQ#03 $12,000 = $47,000 = G703 Electric ✓.
   Detailed contract progression with retainage schedule (10% held by Montana, but owner billed at 0% retainage).

3. Roofing Labor Sub (p.37) — $1,912.50 (ADEQUATE):
   515 N Midland Ave Nyack. Jan 31: 2 Man × 2.5 Hrs @ $75 = $375. May 3: 2 Man × 8 Hrs + 1 Man × 4.5 Hrs = 20.5 × $75 = $1,537.50.
   Detailed worker counts, hours, rates, specific descriptions — meets documentation requirements.

4. Paul Bitts Co. Invoice #21-59 (6/5/22) — $2,670.00 (ADEQUATE):
   "Grade off fill and complete." $1,200 CCO 001 + $1,470 SC 2150-12 = $2,670 = G703 Excavation ✓.

MATERIAL SUPPLIERS:
- Masonry Depot NY (Rockland): #538115/3 Eldorado stone veneer $1,244.36 + #539904/3 bluestone $700.64 = $1,945 = G703 Masonry ✓
- Builders FirstSource: Multiple invoices (BFS) coded 6400M — LSL studs, joist hangers, ZIP tape, OSB, shims, framing lumber. Total ~$3,096.
- Beckerle Lumber: Bev Primed Paulownia $92.00 (6400M)
- ABC Supply: Alum Trim Coil $135.00 (6400M) + siding/roofing materials $1,842.38
- Copper Roofing Supply (National): Berger copper drip edge + valley flashing $5,243.18 (7300S) — PO: THARP/BUMGARDNER
- BFS: Henry Eaveguard roofing underlayment $84.62 (7300S)
- Siding Supply Invoice: $13,462.03 = G703 Siding exactly ✓
- Home Depot: Multiple receipts — housewrap, construction screws, PL adhesive, roofing nails, deck screws, silicone, strapping, Tyvek tape

HOME DEPOT RECEIPTS — Multiple Buyers:
- FICUCELLO THOMAS (card 2167): 05/05, 05/10, 05/11, 05/12 — primary buyer
- LANGE CHRIS: 05/20, 05/27 — PO/JOB: THARP
- SANDOVAL VIDAL: 05/24 — ⚠ PRO XTRA JOB NAME: "DARK" (not THARP). Cost coding stamp shows JOB: 2021-50 Tharp. Potential wrong-job allocation.

⚠ OVERHEAD AS MATERIALS ($182.88 total — §9.3.1 violations):
- Caulk Gun: $27.28 (05/05 HD receipt)
- Stanley Classic 99 Knife: $8.97 (05/10 HD receipt)
- Arrow HT50 Hammer Tackers (2×$34.27): $68.54 (05/10 HD receipt)
- Diet Coke: $2.18 (05/12 HD receipt — PERSONAL ITEM)
- Titanium Bi-Metal Utility blade: $34.97 (05/12 HD receipt)
- Carbide Multi-Purpose Universal blade: $29.97 (05/12 HD receipt)
- Diablo 6-1/2" Framing CSB: $10.97 (05/24 HD receipt)

⚠ FRAMING OVER-BUDGET ESCALATION:
Framing Material: cumulative $66,749.34 vs $41,847 scheduled = 159.51% (up from 146.24% in REQ-04). Over-billed by $24,902.34.
Framing Labor: cumulative $44,395 vs $38,400 scheduled = 115.61%. Over-billed by $5,995.
Combined framing over-billing: $30,897.34 above scheduled values.

⚠ H&J IMPROVEMENTS PATTERN (REQ-02/03/04/05):
REQ-02: #1316 $10,300 "labor only for framing" — DEFICIENT
REQ-03: #1316 $10,300 — DUPLICATE of REQ-02 (same invoice number)
REQ-05: #1335 $31,400 "labor only for framing" — same deficient pattern, new invoice number.
No worker names, no detailed hours, no task descriptions across any H&J invoice.

CRITICAL: NO TIMESHEETS or payroll records in entire 44-page backup. H&J $31,400 represents 100% of labor this period with sub-grade documentation. Zero payroll for any Montana direct labor.`,
};

// Override REQ-06 with PDF-derived data (Invoice #6.pdf — 40 pages reviewed)
REQS_INITIAL[5] = {
  ...REQS_INITIAL[5],
  totalBilled: 76455.82,
  paidAmount: 76455.82,
  architectApproved: 76455.82,
  retainageHeld: 0,
  laborCost: -2387.21,
  materialCost: 35198.74,
  subCost: 3669.76,
  backupStatus: "PARTIAL",
  laborRate: 0,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["overhead_as_material", "no_scope_desc", "no_timesheet"],
  notes: `REQ-06 AUDIT — Invoice #6.pdf (40 pages) — Period: 07/01/22-07/30/22
PDF Total: $76,455.82 | Excel: $45,601.61 | Variance: +$30,854.21 (COs)
6 Change Orders billed this period totaling $30,854.21.

G702 COVER SHEET:
Application No: 6 | Period: 07/01/22-07/30/22 | Application Date: 7/20/2022
Original Contract: $1,183,411.00 | Net COs: $161,899.23 | Contract Sum: $1,345,310.23
Total Completed to Date: $569,270.59 | Previous: $492,814.77 | This Period: $76,455.82
Retainage: $0.00 | Balance to Finish: $776,039.64
Change Order Summary: Previous Adds $159,819.68/Deducts ($55,352.52); This Month Adds $77,954.29/Deducts ($20,522.22)

G703 BASE CONTRACT LINES THIS PERIOD:
- Containers/Waste Removal: $669.76 (cumulative $10,686.42 = 71.24%)
- Masonry: $3,000.00 (cumulative $4,945 = 20.22% of $24,450)
- Framing Material: $1,895.43 (cumulative $68,644.77 = 164.04% of $41,847 — ⚠ OVER-BUDGET)
- Framing Labor: $(2,387.21) CREDIT (cumulative $42,007.79 = 109.40% of $38,400 — still over but reduced)
- Roofing: $19,016.50 (cumulative $29,027.90 = 63.10% of $46,000)
- Siding: $4,172.95 (cumulative $17,634.98 = 31.56% of $55,875)
- Drywall: $10,113.86 (cumulative $11,385.03 = 23.14% of $49,200)
- OH&P: $9,120.32 (cumulative $95,637.46 = 42.04% of $227,474)
BASE CONTRACT TOTALS: $1,183,411 | prev $432,585.64 | $45,601.61 this | $478,187.25 total (40.41%)

G703 CHANGE ORDERS BILLED THIS PERIOD:
- PCO#023 Framing Changes 04.26.2022-05.23.2022: $17,796.51 (100%)
- PCO#024 Additional Stone Veneer at Living Room Exterior: $5,625.00 (100%)
- PCO#022 Brick Finish Removal: $3,013.75 (36.88% of $8,171.88)
- PCO#031 Generator Pad: $79.31 (10.44% of $759.41)
- PCO#032 Exhaust Fans Upgrade: $2,122.14 (100%)
- PCO#030 Additional Insulation: $2,217.50 (100%)
CO TOTALS: $161,899.23 | prev $60,229.13 | $30,854.21 this | $91,083.34 total (56.26%)

COST BREAKDOWN:
Labor: $(2,387.21) — Framing Labor CREDIT only. No positive labor charges this period. No H&J invoice.
Materials: $35,198.74 (Framing Mat $1,895.43 + Roofing $19,016.50 + Siding $4,172.95 + Drywall $10,113.86)
Subs: $3,669.76 (Containers $669.76 + Masonry $3,000)
Check: $(-2,387.21) + $35,198.74 + $3,669.76 = $36,481.29 = Excel subtotal ✓
OH&P: $36,481.29 × 25% = $9,120.32 → Total = $45,601.61 ✓

SUBCONTRACTOR REVIEW:
1. Robert Hiep, Inc. Invoice #60922 (6/9/22) — $669.76 (ADEQUATE):
   E/R 30 Yard Roll Off $225 + Dumping 3.20 Tons @ $115 = $368 + Fuel $25 + Tax $51.76.
   Cost Code: 21500. Containers/waste removal.

2. Coppola & Sons Construction Co., Inc. — $8,128.13 total (DEFICIENT):
   "Labor and Materials" $7,500 lump sum + Tax $628.13. Project: Tharp, 515 North Midland.
   ⚠ NO BREAKDOWN between labor and materials. No scope of work, no dates of work, no worker details.
   Lump sum "Labor and Materials" is deficient — same pattern as H&J. Allocated partially to G703 Masonry $3,000 + COs.

3. Eastern Contractor Services Invoice #14094211 (7/18/2022) — $2,055.00 (ADEQUATE):
   Insulation sub. Base Price $1,232.89 + Option $650. Cost Code: PCO#30 (Additional Insulation).
   SC/PO#: 21-50-13 CCO#002. Coded by MN, REQ #6.

4. Dyer Drywall, LLC — Drywall sub (materials billed through Drywall Center Inc.):
   Invoice #190557: $9,059.25 (multiple drywall types — Fire Code, Ultra-Lite, Mold Tough Ultralight USG).
   Invoice #190662: $702.95 (USG Durock Cement Board). Total: $9,762.20.
   Breakdown: PO 2150-06 base: $8,569.59 + CCO 001: $1,192.61.
   ⚠ Materials billed TO Dyer Drywall LLC but shipped to Montana/Tharp job. Montana billing these as reimbursable costs.

5. AeroPure Fans (2 orders via Lumens.com) — $1,697.71 total:
   Order 1: $591.73 (with Alex Dufek discount -$234).
   Order 2: $1,105.98 (Slim Fit Bathroom Exhaust Fan, 2-Day Express shipping $201.51).
   Related to PCO#032 Exhaust Fans Upgrade ($2,122.14).

MATERIAL SUPPLIERS:
- ABC Supply Invoice #23695690 (06/29/22): DaVinci Slate Multiwidth Aberdeen 141 BD + accessories. $17,546.94 + tax. Cost Code 7300S (roofing). PO 2150-01: $17,530 / PO 2150-07: $1,486.50. ADEQUATE.
- Builders FirstSource: Multiple invoices (6400M framing material) — $529.29, $98.07, $204.83. ADEQUATE.
- Dykes Lumber #2207-217693: $1,754.59 (7400S siding). ADEQUATE.
- Congers Store/Beckerle: Multiple small receipts — $932.79, $271.36, $183.59. Various materials.
- Home Depot: Construction screws $43.32 (07/01), AZEK Trim $99.64 (07/06, 7400S), 3M Fire Barrier Foam $29.87 (06/22, 9200S). FICUCELLO THOMAS. No overhead items on HD receipts this period.

⚠ OVERHEAD AS MATERIALS ($31.90 — §9.3.1 violation):
- 3M 2 Strap Dust Mask w/ Cool Flow Valve Box 10PC: $31.90 (on Drywall Center invoice #190557, billed to Dyer Drywall)
Note: Overhead exposure this period is minimal ($31.90) compared to prior REQs.

⚠ NOTABLE: NO H&J IMPROVEMENTS INVOICE THIS PERIOD
After billing $10,300 (REQ-02), $10,300 duplicate (REQ-03), and $31,400 (REQ-05), H&J is absent from REQ-06.
Framing Labor shows a $(2,387.21) CREDIT — suggesting a correction or adjustment to prior H&J billings.
This is the first period with no H&J involvement since REQ-01.

⚠ COPPOLA & SONS — DEFICIENT "LABOR AND MATERIALS" PATTERN:
Coppola "Labor and Materials" $7,500 lump sum mirrors H&J's deficient invoicing pattern.
No breakdown between labor and materials, no scope, no dates, no worker details.
New sub exhibiting same documentation deficiencies as H&J.

⚠ SCHEDULED VALUE CHANGES FROM REQ-05 TO REQ-06:
Multiple G703 line items show significantly different scheduled values:
- Demolition: $12,838.39 → $50,360 (previous billing also increased to match)
- Drywall: $10,500 → $49,200
- Electric: appeared lower → $101,775
This suggests a formal contract reallocation or budget revision occurred between periods.

CRITICAL: NO TIMESHEETS or payroll records in entire 40-page backup. Framing Labor credit $(2,387.21) is the only labor activity — no positive labor charges, no payroll, no timesheets.`,
};

// ── REQ-07 override (Invoice #7.pdf, 34 pages) ──────────────────────────────
REQS_INITIAL[6] = {
  ...REQS_INITIAL[6],
  totalBilled: 90146.26,
  paidAmount: 90192.96,
  architectApproved: 90146.26,
  retainageHeld: 0,
  laborCost: 0,
  materialCost: 4577.82,
  subCost: 67226.76,
  backupStatus: "PARTIAL",
  laborRate: 0,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["overhead_as_material", "no_timesheet"],
  notes: `REQ-07 AUDIT — Invoice #7.pdf (34 pages) — Period: 07/01/22-07/30/22
APPLICATION #7 | Contract Date 11/15/2021
Original Contract $1,183,411.00 | Net COs $172,894.89 | Contract Sum $1,356,305.89

PDF TOTAL: $90,146.26 | EXCEL: $89,833.76 | VARIANCE: +$312.50 (PCO#035 TRX Bracket)
Base contract this period: $89,833.76 | CO billing: $312.50

COST BREAKDOWN (Base Contract $89,833.76):
  Subtotal: $71,804.58 | OH&P (25%): $18,029.18
  Labor: $0.00 | Materials: $4,577.82 | Subs: $67,226.76

NO DIRECT LABOR THIS PERIOD — First REQ with $0 labor. No H&J Improvements invoice (absent since REQ-06). Framing Labor $0.00 on G703 (cumulative still 109.40% over-budget at $42,007.79 vs $38,400).

ACTIVE G703 LINES THIS PERIOD (Base Contract):
  Containers/Waste: $785.94 | Concrete: $24.11 | Masonry: $8,910.00
  Balcony Railing: $2,396.04 | Framing Material: $387.21 (cumul 164.96% OVER)
  Spiral Stair: $9,841.81 (NEW) | Roofing: $1,642.96 | Siding: $4,067.88
  Drywall: $12,000.00 | Electric: $20,948.63 | HVAC: $10,800.00 | OH&P: $18,029.18

CO BILLING: $312.50 — PCO#035 TRX Bracket only (Pauli D's Mobile Welding $250 + 25% markup)
New COs appearing: PCO#029 Addtl Drywall Material $1,490.76, PCO#033 Interior Doors $1,658.16, PCO#034 Drywall Scope Changes $9,025, PCO#035 TRX Bracket $312.50

SUBCONTRACTOR INVOICES:
  1. Robert Hiep Inc. #71822 (7/18/22) — Roll-off + dumping $785.94 — ADEQUATE
  2. Ecoblast NJ (7/12/22 + 7/25/22) — Sandblast/resurface brick 1523SF $8,910 — ADEQUATE (deposit $2,411 included DIESEL=overhead but absorbed in sub lump sum)
  3. Paragon Stairs #292828-001 (7/22/22) — 6'6" forged iron spiral stair + railings/balusters $25,099.65 total, 50% deposit $12,550 billed (split: Spiral Stair $9,841.81 + Balcony Railing $2,708.19) — ADEQUATE (detailed manufacturer invoice, shipped to job site)
  4. Quatrochi & Sons Roofing #0622-082 (7/23/22) — Various repairs: copper window ledge, roof vents $1,544.34 (split SC2150-17 $487.68 + CCO#001 $1,056.66) — ADEQUATE (dates, hours, crew counts)
  5. Dyer Drywall LLC (7/28/22) — Partial payment $12,000 of $27,000 labor contract for 13,500SF sheetrock + durarock installation — ADEQUATE (scope, SF, contract value, partial payment rationale from Tony Dyer)
  6. DeLeonardis Electric #2544/2681-T (7/20/22) — Progress billing $20,948.63 (SC2150-06 $5,318 + CCO#001 $8,458.25 + CCO#002 $9,500 = $23,276.25 less 10% retainage = $20,948.63) — ADEQUATE but retainage discrepancy continues
  7. HVAC Sub Invoice #i1672 (7/28/22) — A/C install 75% ($7,800) + furnace/coil replacement CO ($3,000) = $10,800 — ADEQUATE (scope, progress %, CO separated)
  8. Pauli D's Mobile Welding #0054 — TRX exercise bracket fabrication $250 (verbal authorization "Tom") — MINIMAL documentation (handwritten, verbal only)

MATERIAL PURCHASES:
  Framing (6400M): Dykes Lumber $127.20 (2x4 Douglas Fir) + Beckerle #2207-117626 $187.32 + BFS #62300735 $57.25 (CDX plywood) = $371.77
  Roofing (7300M): ABC Supply #28738805 $91.00 (Broan roof caps)
  Siding (7400S): Beckerle $20.63 + $21.61 + $51.43 + $151.27 + Dykes $1,122.11 + Dykes ~$530 (AZEK PVC) + Ontime $281.67 + HD $136.94 + HD $69.26 = multiple receipts
  Masonry: Bluestone 50# bags $22.25 (PCCO#028)
  Concrete: $24.11 (minor overage)

OVERHEAD AS MATERIALS (§9.3.1 violations — $751.49 TOTAL, HIGHEST YET):
  DeWalt SDS Max Rotary Hammer D25614K-DW (Ontime Supply): $599.95 — MAJOR (power tool)
  Dremel Wood Flush Cut 3PC MM480BU (HD 7/26): $29.97
  Diablo 6-1/2" 40T Finish Saw Blade (HD 7/26): $33.94
  Lenox 6" Hole Saw (Beckerle 7/21): $49.31
  Lenox Hole Saw Arbor (Beckerle 7/21): $23.27
  Norton 4-1/2" Metal Cut Off Wheels x3 (Beckerle 7/11): $6.99
  Freud Saw Blade 12" (Beckerle 7/11): $8.06
  The $599.95 hammer drill alone exceeds cumulative overhead from REQ-01 through REQ-06 combined.

RETAINAGE PATTERN: DeLeonardis Electric cost code stamp shows $23,276.25 work value but invoices $20,948.63 (difference = 10% retainage held). Montana bills owner at 0% retainage. Pattern continues from prior REQs.

FRAMING MATERIAL STILL OVER-BUDGET: $69,031.98 cumulative = 164.96% of $41,847 scheduled (up from 164.04% in REQ-06). Additional $387.21 this period.

RECURRING PATTERNS:
  - H&J Improvements: ABSENT again (second consecutive REQ without H&J, since REQ-06 framing labor credit)
  - DeLeonardis: Continued billing on same job tickets 2544/2681, now includes CCO#002 ($9,500 new component)
  - NO TIMESHEETS: Zero payroll records across 34 pages (pattern continues REQ-02 through REQ-07)
  - Multiple Beckerle/Dykes/HD buyers: FICUCELLO TOMMY still primary buyer
  - Dyer Drywall: Second appearance (first was REQ-06 via Drywall Center material invoices, now direct labor invoice)
  - New subs this period: Ecoblast NJ, Paragon Stairs, Quatrochi & Sons, Pauli D's Mobile Welding

CRITICAL: NO TIMESHEETS in 34 pages. $0 direct labor. All work through subcontractors this period. $751.49 in overhead billed as materials (dominated by $599.95 DeWalt SDS Max hammer drill from Ontime Supply — a power tool clearly covered by §9.3.1).`,
};

// ── REQ-08 override (Invoice #8.pdf, 34 pages) ──────────────────────────────
REQS_INITIAL[7] = {
  ...REQS_INITIAL[7],
  totalBilled: 192165.00,
  paidAmount: 192165.00,
  architectApproved: 192165.00,
  retainageHeld: 0,
  laborCost: 4425.00,
  materialCost: 12871.52,
  subCost: 136435.48,
  backupStatus: "PARTIAL",
  laborRate: 75,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["overhead_as_material", "sub_as_labor", "no_timesheet", "blended_rate"],
  notes: `REQ-08 AUDIT — Invoice #8.pdf (34 pages) — Period: 08/01/22-08/31/22
APPLICATION #8 | Contract Date 11/15/2021
Original Contract $1,183,411.00 | Net COs $252,402.93 | Contract Sum $1,435,813.93
Net COs jumped $79,508.04 from REQ-07 ($172,894.89 → $252,402.93) — significant new change orders scheduled.

PDF TOTAL: $192,165.00 | EXCEL: $192,165.00 | VARIANCE: $0.00 (MATCH)
Base contract this period: $192,165.00 | CO billing: $0.00
LARGEST SINGLE REQUISITION in the entire project.

COST BREAKDOWN (Base Contract $192,165.00):
  Subtotal: $153,732.00 | OH&P (25%): $38,433.00
  Labor: $4,425.00 | Materials: $12,871.52 | Subs: $136,435.48
  Check: $4,425 + $12,871.52 + $136,435.48 = $153,732.00 ✓

ACTIVE G703 LINES THIS PERIOD (Base Contract):
  Containers: $694.64 | Balcony Railing: $2,708.15 | Framing Material: $95.49 (cumul 165.19% OVER)
  Framing Labor: $3,600.00 (cumul 118.77% OVER — BACK after $0 in REQ-07)
  Spiral Stair: $9,841.67 | Roofing: $21,393.59 (cumul 113.18% NOW OVER)
  Siding: $12,776.03 | Window Installation: $825.00 (NEW trade)
  Drywall: $15,000.00 | Tile Installation: $34,925.00 (cumul 135.11% MASSIVELY OVER)
  Wood Flooring: $27,000.00 (NEW trade) | Electric: $20,695.00 | HVAC: $4,177.43
  OH&P: $38,433.00

OVER-BUDGET LINES (cumulative % of scheduled value):
  Framing Material: 165.19% ($69,127.47 vs $41,847) — persistent since REQ-04
  Framing Labor: 118.77% ($45,607.79 vs $38,400) — resumed after $0 in REQ-07
  Roofing: 113.18% ($52,063.59 vs $46,000) — NEWLY over-budget this period
  Tile Installation: 135.11% ($34,925 vs $25,850) — MASSIVELY over in first billing period

CO SECTION: $0.00 billed this period. All COs scheduled but none billed.
  CO Scheduled: $202,203.34 | Previous CO: $73,402.47 | This Period CO: $0.00
  Notable new CO: PCO#047 "Additional Framing Subcontractor Labor 06.21.2022 through 08.31.2022" $3,225

SUBCONTRACTOR INVOICES:
  1. Robert Hiep Inc. #80922 (8/9/22) — Roll-off $225 — Containers — ADEQUATE
  2. Quatrochi & Sons #0822-086 (8/11/22) — $12,000 on-account roofing labor — ADEQUATE
  3. Quatrochi & Sons #0822-083 — $8,000 on-account roofing labor (code 7300S) — ADEQUATE
     Total Quatrochi this period: $20,000 (on-account partial payments)
  4. H&J HOME IMPROVEMENTS CORP #1383 (8/31/22) — $3,225 — ⚠ H&J IS BACK (absent REQ-06/07)
     Framing labor 6/21-6/27: 32 hrs × $75 = $2,400 (reframe wall/header, pad out balcony ceiling)
     Window work 7/12-7/25: 11 hrs × $75 = $825
     $75/hr rate NOW EXPLICIT — confirms sub_as_labor pattern. Still "labor only" — no crew names.
     Date range starts JUNE (billed in August period). Split: CCO#004 $2,400 + CCO#001 $825.
  5. Dyer Drywall LLC (8/30/22) — $15,000 — ADEQUATE (excellent documentation:
     Base $19,780 prev $8,825 this $10,955 + CO#1 $7,220 prev $3,175 this $4,045. Code SC2150-14)
  6. Tile vendor (handwritten) — $3,350 — Code 9300M — MINIMAL (handwritten, minimal vendor ID)
  7. Carpet World — $27,000 DEPOSIT for wood flooring (sand, stain, finish + 6 steps)
     Code 9400S, split SC2150-20 $19,674.78 + CCO 001 Lines 1&2
     ⚠ LARGE DEPOSIT — advance payment, not completed-work invoice
  8. DeLeonardis Electric Inc. "Tharp-xtra1" (8/4/22) — EXTRAS ROUGH IN (Not Part Of Original Contract)
     Period 1 (12/23/21-6/6/22): Labor $7,425 + Material $3,150 = $10,575
     Period 2 (6/7/22-7/20/22): Labor $8,000 + Material $3,020 = $11,020
     CREDIT: -$900 for six fans not installed. Net before tax: $20,695.
     Code SC2150-06 CCO#003. T&M basis for rough-in changes.
     ⚠ Coded to CCO#003 but G703 shows $20,695 under BASE contract Electric, not CO section.
  9. Paragon Stairs #292828-002 (9/15/22) — $25,099.65 total, 50% balance $12,549.82
     Split: Spiral Stair $9,841.67 (6500S) + Balcony Railing $2,708.15 (5510S)
     Second half payment (first 50% in REQ-07). PO2150-09. ADEQUATE.
  10. Sunbelt Rentals #128973166-0001 — $3,854.59 — ⚠ MAJOR OVERHEAD
      2x portable AC/dehumidifier ($1,790) + dehumidifier ($500) + delivery/pickup/fees
      4 weeks 8/03/22-8/30/22. Code SC2150-23 (mapped to HVAC on G703).
      §9.3.1: Temporary facilities/equipment = contractor overhead, NOT reimbursable.
      LARGEST SINGLE OVERHEAD ITEM in any REQ ($3,854.59 exceeds all prior REQ overhead combined).

MATERIAL PURCHASES:
  Framing (6400M): Beckerle Lumber #2208-146877 (2x4 Douglas Fir + screws) + BFS #60623098 (2x4/2x8 lumber) + HD $13.74 (door pull, spring)
  Roofing (7300M): ABC Supply #29637651 $1,042 (4x copper sheet 3'x10' 16oz) + BFS $153.96 felt + $89.93 nails
  Siding (7400S): Dykes Lumber $843.61 (AZEK PVC + CDX) + $319.44 (AZEK trim/drip cap) + $7,952.98 (768 LF Clear FJ Beveled Cedar Primed) + Lowe's $60.85 (plywood/insulation)

LABOR HOUR LOG (Page 7) — FIRST TIMESHEETS SINCE REQ-01:
  Workers: Michael Laubauskas, Thomas Ficucello, Vidal Sandoval
  Cost codes: 06-000-6-400-L (Framing), 07-000-7-400-L (Siding)
  ⚠ HOURS ONLY — no dollar amounts, no rates, no payroll data. ~20 framing hours visible.
  Does NOT satisfy §15.3.2 documentation requirements.

OVERHEAD AS MATERIALS (§9.3.1 violations — $3,854.59 TOTAL, NEW RECORD):
  Sunbelt Rentals portable AC/dehumidifier rental: $3,854.59 (4-week equipment rental)
  This single item exceeds all prior REQ overhead combined (~$1,503.12 through REQ-07).
  Temporary climate control equipment is clearly contractor's responsibility per §9.3.1.

RETAINAGE: $0.00 — continues zero retainage pattern. DeLeonardis extras invoice shows T&M billing but retainage relationship unclear on extras vs base contract.

TILE INSTALLATION MASSIVELY OVER-BUDGET: First billing at $34,925 vs $25,850 scheduled = 135.11%.
$9,075 over-budget in a single period. Backup shows only $3,350 tile material invoice — remaining $31,575 is tile installation labor with minimal documentation.

RECURRING PATTERNS:
  - H&J Improvements: RETURNED after 2-period absence. $75/hr rate now explicitly stated on invoice.
  - DeLeonardis: Extras invoice covers work dating back to 12/23/21. Retainage pattern continues.
  - NO PAYROLL: Labor hour log is improvement over zero documentation but still lacks rates/payroll.
  - Dyer Drywall: Third consecutive REQ (REQ-06 materials, REQ-07 labor, REQ-08 continued).
  - Paragon Stairs: Second payment (50% balance). Clean split across Spiral Stair + Railing lines.
  - New vendors: Carpet World (wood flooring), tile vendor (handwritten), Sunbelt Rentals (equipment).

CRITICAL: LARGEST REQ at $192,165. Four over-budget lines (Framing Mat 165%, Framing Labor 119%, Roofing 113%, Tile 135%). $3,854.59 Sunbelt equipment rental is biggest single overhead item across all REQs. Tile $9,075 over-budget in first billing. H&J returns with explicit $75/hr rate confirming sub_as_labor. Labor hours present but no payroll data.`,
};

// ─── REQ-09 Override (Invoice #9.pdf — 26 pages) ─────────────────────────────
REQS_INITIAL[8] = {
  ...REQS_INITIAL[8],
  totalBilled: 50381.66,
  paidAmount: 57523.35,
  architectApproved: 50361.29,
  retainageHeld: 0,
  laborCost: 687.50,
  materialCost: 11397.24,
  subCost: 23367.70,
  backupStatus: "PARTIAL",
  laborRate: 55,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["sub_as_labor", "rate_anomaly", "no_timesheet", "blended_rate", "co_missing"],
  notes: `REQ-09 AUDIT — Invoice #9.pdf (26 pages) — Period: 10/01/22-10/30/22

G702 COVER SHEET:
  Application No: 9 | Period To: 10/30/22
  Original Contract: $1,183,411.00 | Net COs: $279,690.67 (up $27,287.74)
  Revised Contract: $1,463,101.67 | Total Completed: $901,943.14
  Previous Certified: $851,581.85 | Current Payment Due: $50,361.29
  Retainage: $0.00

G703 SCHEDULE OF VALUES — BASE CONTRACT THIS PERIOD ($44,315.55):
  Item 9  Framing Material:   $79.87  (cumul 165.38% — OVER BUDGET)
  Item 11 Spiral Stair:       $6,375.00 (cumul 130.29% — OVER BUDGET)
  Item 14 Roofing:            $107.29 (cumul 113.42% — OVER BUDGET)
  Item 15 Siding:             $11,897.58 (cumul 83.00%)
  Item 22 Tile Installation:  $325.00 (cumul 136.36% — OVER BUDGET)
  Item 25 Painting:           $13,565.00 (NEW trade — 24.89% complete)
  Item 30 OH&P (25%):         $8,863.11
  Item 31 Cooling:            $3,102.70 (NEW — $0 scheduled, 100% OVER)

G703 CHANGE ORDER LINES ($6,045.74):
  PCO#049 Living Room Fireplace Demolition: $1,340.30
  PCO#052 Wet Area Balcony Railings: $3,496.29
  ⚠ MATH NOTE: Base $44,315.55 + visible COs $4,836.59 = $49,152.14.
  G702 shows $50,361.29 — difference $1,209.15 suggests additional CO line(s) on G703 pages 4-5.

COST BREAKDOWN (base subtotal $35,452.44):
  laborCost $687.50: H&J siding labor only
  materialCost $11,397.24: Framing Mat $79.87 + Roofing $107.29 + Siding mat $11,210.08
  subCost $23,367.70: Paragon $6,375 + Stone Surfaces $325 + K&S Painting $13,565 + Cooling $3,102.70

EXCEL vs PDF VARIANCE: +$6,045.74 (COs in PDF not tracked in Excel base total)

BACKUP DOCUMENTS (Pages 7-23, pages 24-26 blank):
  1. MJ Group #2022-M136 (9/28/22) — demo crew labor 9/16 (L&J) $560 — Code 2100S
     NEW vendor. Supports PCO#049 (Fireplace Demolition) partially.
  2. Roll-off container — 12 YARD ROLL OFF cinder box/brick — $695 + fuel $25 + tax $60.30 = $780.30
     Demolition debris disposal. Supports PCO#049.
  3. Balcony railing material — 2x Modern Cable Faux Balcony Bronze-Tone — $2,850 — Code 5510M, PCCO#049
     ⚠ Coding says PCCO#049 but PCO#049 is fireplace demo. Should be PCO#052 (Wet Area Balcony Railings). MISCODED.
  4. HD receipt (09/29/22) — 2X4 Douglas Fir $58.24 + Sheetrock $15.46 = $73.70 — Code 6400M
     Buyer: FICUCELLO TOMMY. Framing material. ADEQUATE.
  5. Paragon Stairs coding slip — Code 6500S — SC2150-28: $5,655 + CCO 001: $720 = $6,375.00
     Matches G703 Item 11 exactly. Split between base and CO.
  6. Beckerle Lumber #2209-179834 (9/26/22) — Cedar shingles $21 + more = SubTotal $117.88 + tax $9.87 = $127.75
     Buyer: FICUCELLO TOMMY. Roofing/siding material.
  7. Dykes Lumber #2209-283630 (9/23/22) — Clear Beveled Cedar — siding material. Supports Item 15.
  8. HD receipt — additional material purchases, various codes. Buyer: FICUCELLO THOMAS.
  9. H&J Home Improvements #1390 (9/21/22) — "Labor only for siding" — 12.5 hrs × $55.00/hr = $687.50
     Code 7400S (Siding), SC2150-25.
     ⚠ RATE ANOMALY: $55/hr for siding vs $75/hr for framing in REQ-08. Inconsistent H&J rates across trades.
  10. Stone Surfaces Commercial (9/28/22) — 4 pcs 3/4 Royal Reef Quartz — $325 — Tile material
      Handwritten invoice. Matches G703 Item 22 exactly.
  11. Korth & Shannahan Painting Co. — $13,565.00 — Code 9900S
      SC2150-27: $7,527.50 + SC2150-28: $6,037.50. NEW sub vendor. Matches Item 25 exactly.
  12. HD receipt (09/09/22) — 6x6 Square Drain Tile-In Grate $63.22 — Code 22400M (plumbing material)
      ⚠ No Plumbing line on G703 — where is this billed?

KEY FINDINGS:
  1. H&J RATE ANOMALY: $55/hr siding vs $75/hr framing — inconsistent pricing across trades.
  2. COOLING LINE ($3,102.70): $0 scheduled, 100% over-budget. No backup invoice found in 26-page document.
  3. MISCODED CO: Balcony railing material ($2,850) coded to PCO#049 (fireplace) instead of PCO#052 (railings).
  4. NEW VENDORS: MJ Group (demolition), Korth & Shannahan (painting).
  5. FIVE OVER-BUDGET LINES: Framing Mat 165%, Spiral Stair 130%, Roofing 113%, Tile 136%, Cooling ∞%.
  6. CO MATH DISCREPANCY: Visible CO lines total $4,836.59 but G702 implies $6,045.74 in COs. $1,209.15 gap.
  7. PLUMBING MATERIAL ($63.22): Coded 22400M but no Plumbing line exists on G703. Orphaned cost code.
  8. NO PAYROLL: H&J invoice only — no Montana payroll, no timesheets this period.`,
};

// ─── REQ-10 Override (Invoice #10.pdf — 38 pages) ─────────────────────────────
REQS_INITIAL[9] = {
  ...REQS_INITIAL[9],
  totalBilled: 90418.49,
  paidAmount: 84016.30,
  architectApproved: 90418.49,
  retainageHeld: 0,
  laborCost: 1035.00,
  materialCost: 17869.22,
  subCost: 11556.74,
  backupStatus: "PARTIAL",
  laborRate: 75,
  hasPayrollSupport: false,
  hasInvoiceSupport: true,
  hasCheckVouchers: false,
  flags: ["sub_as_labor", "no_timesheet", "blended_rate", "missing_invoice", "rate_anomaly"],
  notes: `REQ-10 AUDIT — Invoice #10.pdf (38 pages) — Period: 10/01/22-10/30/22
⚠ SAME BILLING PERIOD AS REQ-09 — both cover 10/01/22-10/30/22. Application Date: 11/1/2022.

G702 COVER SHEET:
  Application No: 10 | Period To: 10/30/22
  Original Contract: $1,183,411.00 | Net COs: $361,702.71 (up $82,012.04 from REQ-09)
  Revised Contract: $1,545,113.71 | Total Completed: $992,382.00
  Retainage: $0.00

G703 SCHEDULE OF VALUES — BASE CONTRACT THIS PERIOD ($38,076.20):
  Item 1  Demolition:         $360.00  (cumul 100.71% — OVER BUDGET)
  Item 3  Concrete:           $375.00  (cumul 101.48% — OVER BUDGET)
  Item 6  Masonry:            $20.37   (cumul 56.83%)
  Item 9  Framing Material:   $476.99  (cumul 166.52% — OVER BUDGET)
  Item 10 Framing Labor:      $675.00  (cumul 120.53% — OVER BUDGET)
  Item 14 Roofing:            $518.82  (cumul 114.54% — OVER BUDGET)
  Item 15 Siding:             $7,740.00 (cumul 96.85%)
  Item 18 Doors & Frames:     $9,113.04 (NEW trade — 34.26%)
  Item 21 Drywall:            $2,446.74 (cumul 82.99%)
  Item 28 HVAC:               $8,735.00 (cumul 48.71%)
  Item 30 OH&P (25%):         $7,615.24

G703 CHANGE ORDER LINES ($41,873.83 per CO subtotal):
  PCO#067 Living Room Fireplace CMU & Interior Framing Labor: $3,300.00
  PCO#068 Medicine Cabinets & Vanities Installation Labor: $750.00
  PCO#069 Primary/Kitchen Siding: $1,440.00
  PCO#070 Cricket/Scupper Framing: $600.00
  PCO#071 Basement Wall Demolition: $240.00
  PCO#073 Sheathing Repair & Additional Studs: $179.09
  PCO#074 Copper Pipe Flashing, Caps & Crickets: $2,925.00
  Plus additional CO lines from G703 pages 4-6 (many new COs scheduled this period).
  ⚠ MATH NOTE: Base $38,076.20 + CO $41,873.83 = $79,950.03 but G703 Grand Total shows $90,418.49.
  Gap of $10,468.46 — possible additional CO lines on pages 4-6 not fully captured.

GRAND TOTAL THIS PERIOD: $90,418.49 (from G703 Grand Totals line)

COST BREAKDOWN (base subtotal $30,460.96):
  laborCost $1,035.00: Framing Labor $675 + Demolition $360
  materialCost $17,869.22: Framing Mat $476.99 + Masonry $20.37 + Roofing $518.82 + Doors $9,113.04 + Siding $7,740
  subCost $11,556.74: HVAC $8,735 + Drywall $2,446.74 + Concrete $375

EXCEL vs PDF VARIANCE: +$52,342.29 (Excel $38,076.20 vs PDF $90,418.49 — massive CO component)

BACKUP DOCUMENTS (Pages 8-35, pages 36-38 blank):
  1. Masonry receipt $20.37 (TOMMY FICUCELLO, Code 4100M) — matches Item 6 exactly.
  2. C & F Steel Design Inc. #1692 (10/27/22) — steel fabrication. NEW vendor.
     Bill To: Montana Contracting, John Torres. Project: 515 N Midland Ave.
  3. BFS invoice (7/20/22) — framing studs + CDX plywood — Code 6400M + PCCO#070 (Cricket/Scupper CO).
  4. BFS invoice — $476.99 total (Buyer: GREGG PLATT) — matches Item 9 Framing Material exactly.
  5. BFS invoice #61988817 (10/12/22) — 3-5/8" Track $107 — Code 6400M (additional framing).
  6. ABC Supply — roofing material $460.59 (subtotal $425 + tax $35.59).
  7. BFS (10/4/22) — Foamular insulation $53.73.
  8. ⚠ ANONYMOUS ROOFING SUB — copper pipe flashings & crickets labor.
     "One man three hours $75.00 X 3" = $225 + "Three men $75.00/hr X Twelve" = $2,700
     Total $2,925 — Code 7300S, PCCO#071. Matches PCO#074 exactly.
     NO VENDOR NAME on invoice. $75/hr rate continues. Tax exempt (Capital Improvement N/A).
  9. Dykes Lumber #2210-299275 (10/13/22) — MASSIVE 7-page door order.
     Multiple REEB-INT Single Doors ($227-$348 each). Code 8100M. Supports Item 18 ($9,113.04).
  10. Beckerle Lumber #2210-203252 (10/24/22) — siding/roofing material.
  11. BFS — drywall material $646.74 (Sales $596.76 + tax $49.98). Code 9200M. Buyer: GREGG PLATT.
  12. HD receipts — small items (holesaw $17.37, hole cover $5.47, misc $35.70). Code 9200M.
  13. ⚠ MASON LIT FIREBOX KIT 49" — $15,000.00! Code 10300S, SC2150-21.
      Major fireplace unit purchase. Tax exempt. PrePaid terms.
  14. Valley Mechanical Services Inc (Congers, NY) — HVAC sub.
      Balance Due: $13,935 (adjusted down from original $30,935).
      Change Order: guest bathroom heat from Runtal to in-floor radiant = $3,200.
      NEW HVAC sub vendor. First appearance.

KEY FINDINGS:
  1. DUPLICATE BILLING PERIOD: Both REQ-09 and REQ-10 cover 10/01/22-10/30/22.
     Two separate requisitions in the same month is highly unusual and needs investigation.
  2. MASSIVE CO EXPANSION: Net COs jumped $82K to $361,702 (up 29% in one REQ).
     Many new PCOs (#050-#074) added to schedule, most with $0 prior billing.
  3. FIREBOX KIT $15,000: Major purchase coded to 10300S — no corresponding base contract line visible.
  4. VALLEY MECHANICAL: New HVAC sub at $13,935 (was $30,935 — reduced by $17,000).
  5. ANONYMOUS ROOFING SUB: $2,925 invoice has NO company name. $75/hr rate.
  6. FRAMING LABOR $675: Billed with NO backup invoice in 38-page document.
  7. SEVEN OVER-BUDGET LINES: Demo 101%, Concrete 101%, Framing Mat 167%, Framing Labor 121%, Roofing 115%, plus prior Tile 136%, Spiral Stair 130%.
  8. DOORS & FRAMES: NEW trade — $9,113.04 first billing backed by 7-page Dykes door order.
  9. G703 MATH GAP: Base + CO subtotals = $79,950 but Grand Total = $90,418. $10,468 unexplained.`,
};

// ── REQ-11 (Invoice #11) — Application #11, Period 11/01/22-11/30/22 ────────
REQS_INITIAL[10] = {
  ...REQS_INITIAL[10],
  totalBilled: 92651.29,
  paidAmount: 92651.29,
  architectApproved: 92651.29,
  retainageHeld: 0,
  laborCost: 3431.93,
  materialCost: 7313.15,
  subCost: 30609.90,
  backupStatus: "PARTIAL",
  hasPayrollSupport: true,
  hasInvoiceSupport: true,
  flags: ["sub_as_labor", "blended_rate", "overhead_as_material", "co_missing", "rate_anomaly"],
  notes: `REQ-11 — APPLICATION #11 — Period 11/01/22 to 11/30/22
G702: Contract Sum $1,632,483.77 | Total Completed $1,085,033.29 | Retainage $0
Net Change Orders: $449,072.77 (up $87,370 from REQ-10 — third consecutive massive CO expansion)

G703 BASE CONTRACT THIS PERIOD: $51,693.73 (matches Excel exactly)
  Item 2  Containers/Waste Removal      $672.40    — Robert Hiep Inc. #112122B (11/21/22)
  Item 12 Interior Trim                 $19,062.47 — NEW trade first billing. Dykes Lumber ceiling planks $5,311.35,
          pine trim $2,035.20, plus $9,825 carpentry progress payment (no labor/material breakdown)
  Item 15 Siding                        $3,431.93  — Employee labor (Sandoval, Laubauskas timecards) + PVC trim materials
  Item 21 Drywall                       $75.68     — Small material purchase
  Item 25 Painting                      $18,112.50 — Korth & Shannahan Painting Co. (base portion of $49,450 total contract)
  Item 30 OH&P                          $10,338.75 — 25% of $41,354.98 base cost ✓

G703 CHANGE ORDERS THIS PERIOD: $32,766.05
  PCO#046 Guest Bathroom Layout Change   $1,000.00
  PCO#075 Additional Painting           $21,050.00 — Korth & Shannahan CO portion
  PCO#077 LR Fireplace Chimney Framing   $2,305.67
  PCO#078 Misc Carpentry November 2022   $6,858.53
  PCO#079 Additional Drywall Labor       $1,500.00
  PCO#080 Hinges for Millwork Doors         $51.85

G703 GRAND TOTAL THIS PERIOD: $92,651.29
  MATH CHECK: Base $51,693.73 + CO $32,766.05 = $84,459.78
  GAP: $8,191.51 = exactly 25% of CO total ($32,766.05)
  This confirms HIDDEN OH&P MARKUP on change orders not shown as separate G703 line.

VARIANCE: $92,651.29 (G703) - $51,693.73 (Excel) = +$40,957.56 (all CO billing)

BACKUP DOCUMENTATION (38 pages):
  Pages 8-9: TIMECARDS — FIRST REQ WITH ACTUAL TIMECARDS
    Thomas Ficucello — Project Supervision (01-000-1-200-L), 7-9 hrs/day, coded "Billable: Yes"
    Jose Palacios — General Conditions Labor (01-000-1-100-L), 8 hrs, coded "Billable: Yes"
    Vidal Sandoval — Siding (07-000-7-400-L) & Drywall (09-000-9-200-L), 8 hrs
    Michael Laubauskas — Siding (07-000-7-400-L), 8 hrs
    *** AUDIT FLAG: Ficucello supervision + Palacios general conditions = OVERHEAD under §9.3.1 ***
    *** These are coded "Billable: Yes" but should be absorbed in 25% OH&P fee ***
  Page 10: Robert Hiep Inc. #112122B — waste removal $672.40 ✓ matches G703 Item 2
  Page 11: BFS lumber — framing material $249.65, coded 6400M, PCCO#074
  Page 12: H&J Home Improvements #1414 (11/9/22) — "Labor only for fireplace surround on roof" $2,000 lump sum
  Pages 13-16: BFS invoices — builder shims, radiata pine trim, PVC trim (various small materials)
  Pages 17-18: Dykes Lumber — Armstrong Woodhaven ceiling planks $5,311.35 (10/24/22 — October date!),
    pine trim $1,017.60 × 2, delivery charges
  Page 19: Home Depot — X-Board, tape, screws $200.32
  Page 21: Progress Payment #9798 (11/11/22) — "carpentry work at Tharp Bumgardner Residence"
    $9,825.00 Labor & Materials combined — NO BREAKDOWN between labor and materials
  Pages 22-25: Beckerle Lumber — PVC trim, fasteners, small materials
  Page 29: Invoice $165.60 coded 7400M (Siding Material) to PCCO#075 (Painting CO) — MISCODED
  Page 31: CASH purchase — 8x8x12 treated post $152.80 (includes delivery)
  Page 35: Dykes drywall board $215.45 coded 9200M to PCCO#075 (Painting CO) — MISCODED
  Page 38: Korth & Shannahan Painting Co. — MASTER PAINTING INVOICE $49,450.00 total
    Split: $18,112.50 base (SC2150-28) + $21,050 CO (PCCO#072/PCO#075)
    Remaining $10,287.50 = prior period billings or future billing

KEY FINDINGS:
  1. FIRST REQ WITH TIMECARDS: Employee timecards finally included, BUT supervision and general
     conditions labor (Ficucello, Palacios) coded as "Billable" — these are OVERHEAD per §9.3.1.
  2. HIDDEN CO OH&P: $8,191.51 gap = exactly 25% of CO total. Contractor is applying markup to
     change orders but not showing it as a separate G703 line item. Systematic pattern.
  3. MISCODING TO PAINTING CO: Multiple receipts (siding material 7400M, drywall 9200M) coded to
     PCCO#075 "Additional Painting" — inflating the painting CO while understating base trade lines.
  4. CARPENTRY PROGRESS PAYMENT: $9,825 with NO labor/material breakdown. Violates §15.3.2
     documentation requirements for cost-plus billing.
  5. CO EXPANSION CONTINUES: Net COs now $449,073 — up $87,370 from REQ-10. Third consecutive
     REQ with massive CO growth ($57K → $82K → $87K).
  6. TILE OVER-BUDGET: Item 22 Tile Installation at 136.36% — $9,400 over scheduled value with
     no change order to cover the overage.
  7. OCTOBER-DATED RECEIPTS: Several material purchases dated October 2022 billed in November REQ.`,
};

// ── REQ-12 (Invoice #12) — Application #12, Period 12/01/22-12/31/22 ────────
REQS_INITIAL[11] = {
  ...REQS_INITIAL[11],
  totalBilled: 71831.85,
  paidAmount: 71831.85,
  architectApproved: 71831.85,
  retainageHeld: 0,
  laborCost: 0,
  materialCost: 4655.67,
  subCost: 34780.00,
  backupStatus: "PARTIAL",
  hasInvoiceSupport: true,
  flags: ["sub_as_labor", "blended_rate", "missing_invoice", "co_missing", "rate_anomaly"],
  notes: `REQ-12 — APPLICATION #12 — Period 12/01/22 to 12/31/22
G702: Contract Sum $1,660,408.23 | Total Completed $1,156,865.14 | Retainage $0
Net Change Orders: $476,997.23 (up $27,924 from REQ-11 — smallest CO increase in months)

G703 BASE CONTRACT THIS PERIOD: $49,294.58 (matches Excel within $0.01)
  Item 12 Interior Trim                 $4,639.64  — Beckerle lumber $7,190.53, BFS materials, HD supplies
  Item 17 Gutters & Leaders            $10,200.00  — NEW trade first billing. AJ Reliable (7700S base SC2150-32)
  Item 18 Doors & Frames                  $16.02   — HD hinge $16.03 (Ficucello 12/08/22)
  Items 21-29 (various trades)         $24,580.00   — Includes drywall, painting, and other trades
  Item 25 Painting                     $24,580.00   — Korth & Shannahan Painting Co. (9900S, SC2150-27)
  Item 30 OH&P                          $9,858.92  — 25% of $39,435.67 base cost ✓

G703 CHANGE ORDERS THIS PERIOD: $18,029.81
  PCO#072 West Side Leader Drainage     $6,250.00  — Sub invoice coded 31000S / PCCO#069 (CO# discrepancy with G703)
  PCO#082 Gym Cedar Material #1         $3,174.48
  PCO#083 Cow Barn Mech Room Door Slab    $247.98  — Boards & Beams estimate (NOT invoice)
  PCO#084 Dining Room Stairs Revised       $440.80 — BFS cement board $153.36 coded 9200M
  PCO#085 Additional Gutter Work           $200.00 — AJ Reliable addon (coding correction: "PCCO #82 not 85")
  PCO#086 Primary BR Decorative Beams   $5,933.53  — Boards & Beams LLC ESTIMATES used as backup
  PCO#087 Fireplace Enclosure Cement Bd    $208.02
  PCO#088 Misc Carpentry December 2022  $1,575.00

G703 GRAND TOTAL THIS PERIOD: $71,831.85
  MATH CHECK: Base $49,294.58 + CO $18,029.81 = $67,324.39
  GAP: $4,507.46 = exactly 25% of CO total ($18,029.81)
  THIRD CONSECUTIVE REQ with hidden CO OH&P — systematic pattern now fully confirmed.

VARIANCE: $71,831.85 (G703) - $49,294.59 (Excel) = +$22,537.26 (all CO billing)

BACKUP DOCUMENTATION (34 pages):
  Pages 8-9: Beckerle Lumber — $7,190.53 material order. One receipt dated 1/4/2023 (AFTER Dec period).
    Signed by FALSETTI, ANTHONY — new employee name not seen in prior REQs.
  Page 11: BFS small materials $213.61
  Pages 13-18: Boards & Beams, LLC — MULTIPLE PAGES OF ESTIMATES (not invoices!)
    Estimate #E2022-25800, E2022-25801. Documents labeled "Estimate" with disclaimer
    "prices may change over time." Using estimates as backup violates §15.3.2 requirement
    for "receipted invoices" in cost-plus documentation.
  Page 21: Beckerle Lumber — $7,190.53 (subtotal $6,634.86 + tax $555.67)
  Pages 22-25: Home Depot — X-Board floor protection $163.47 (11/30/22 — prior period date),
    hinge $16.03 (12/08/22), both purchased by Ficucello Thomas
  Page 27: AJ Reliable — gutters & leaders $10,400 total ($10,200 base + $200 CO)
    Handwritten correction: "PCCO #82 not 85" — coding correction on CO reference
  Page 33: Korth & Shannahan Painting — $24,580.00 (9900S, SC2150-27)
  Page 34: Drainage sub — $6,250.00 (31000S, SC2150-31 / PCCO#069)

KEY FINDINGS:
  1. ESTIMATES AS INVOICES: Boards & Beams LLC submitted ESTIMATES (not invoices) as backup for
     decorative beam charges totaling $5,933.53+. Documents explicitly labeled "Estimate" with
     price-change disclaimer. Violates §15.3.2 documentation requirements.
  2. HIDDEN CO OH&P CONFIRMED: $4,507.46 gap = exactly 25% of CO total. THIRD consecutive REQ
     with this pattern. Cumulative hidden CO OH&P: REQ-10 ($10,468) + REQ-11 ($8,191.51) + REQ-12 ($4,507.46).
  3. POST-PERIOD RECEIPT: Beckerle Lumber receipt dated 1/4/2023 included in December 2022 billing.
  4. CO NUMBER DISCREPANCY: Drainage sub backup coded PCCO#069 but G703 lists as PCO#072.
     AJ Reliable gutter CO coded PCCO#085 with handwritten correction to #082.
  5. NO TIMECARDS: Unlike REQ-11 which had timecards, REQ-12 has NO employee timecards.
  6. PRIOR-PERIOD RECEIPT: HD floor protection dated 11/30/22 billed in December REQ.
  7. KORTH PAINTING CONTINUES: $24,580 base billing. Combined with REQ-11 ($18,112.50 base +
     $21,050 CO), Korth total now $63,742.50 of $49,450 contract — OVER-BILLED by $14,292.50.`,
};

// ── REQ-13R1 (Invoice #13R1) — Application #13 R1 (REVISED), Period 01/01/23-03/23/23 ──
REQS_INITIAL[12] = {
  ...REQS_INITIAL[12],
  totalBilled: 184238.97,
  paidAmount: 184238.97,
  architectApproved: 184238.97,
  retainageHeld: 0,
  laborCost: 0,
  materialCost: 4782.53,
  subCost: 67610.18,
  backupStatus: "PARTIAL",
  hasInvoiceSupport: true,
  flags: ["sub_as_labor", "blended_rate", "missing_invoice", "co_missing", "duplicate", "rate_anomaly", "markup_on_markup"],
  notes: `REQ-13R1 — APPLICATION #13 R1 (REVISED) — Period 01/01/23 to 03/23/23 (nearly 3 months)
G702: Contract Sum $1,734,690.49 | Total Completed $1,341,104.11 | Retainage $0
Net Change Orders: $551,279.49 (up $74,282 from REQ-12 — massive CO increase)
Excel This Period: -$90,489.90 (NEGATIVE — credit/reversal requisition)
G703 Grand Total This Period: $184,238.97 (net positive)
VARIANCE: $184,238.97 - (-$90,489.90) = +$274,728.87 (LARGEST variance of all REQs)

THIS IS A REVISED REQUISITION (R1) — corrects/replaces original REQ-13. The massive
discrepancy between Excel's negative figure and G703's positive Grand Total indicates
the Excel tracks ONLY the base contract credits while G703 captures both credits AND
new CO billing in the same period.

BASE CONTRACT CREDITS (REVERSALS) — This Period:
  Item 3  Concrete:        ($24.11)
  Item 6  Masonry:         ($9,902.87)
  Item 7  Balcony Railing: ($2,737.85)
  Item 20 Windows:         ($825.00)
  Item 21 Drywall:         ($7,992.49)
  Item 22 Tile:            ($12,100.00)
  Item 23 Wood Flooring:   ($7,325.22)
  Item 25 Painting:        at 103.22% — OVER BUDGET (exceeded $49,450 contract)
  Item 27 Electric:        ($41,823.63) — MASSIVE single-line credit
  Item 28 HVAC:            ($8,545.13)
  Item 29 Excavation:      ($1,200.00)
  Base Credits Total:      ~($92,476.30)

CREDIT CHANGE ORDERS (Base Sub Credits — restructuring):
  PCO#009 HVAC Base Sub Credit:        ($11,725.00) SV
  PCO#010 Plumbing Base Sub Credit:    ($4,550.00)
  PCO#011 Electrical Base Sub Credit:  ($16,270.00)
  PCO#013 Lighting Fixture Credit:     ($14,500.00)
  PCO#017 Demolition Budget Credit:    ($8,024.00)
  PCO#026 Excavation Base Credit:      ($5,208.63)
  PCO#027 Window Install Base Credit:  ($4,218.75)

  PATTERN: Systematic BASE-TO-CO CONVERSION — base contract amounts reduced via credits
  while NEW change orders created for the same/similar work. This potentially generates
  additional 25% OH&P markup on work originally in the base contract scope.

SIGNIFICANT POSITIVE CO BILLING THIS PERIOD:
  PCO#007  Low Voltage Wiring:            $25,572.81
  PCO#014  Electrical Service Relocation: $11,875.00
  PCO#022  Brick Finish Removal:          $5,158.13
  PCO#025  Insulation Scope Changes:      $32,205.36 (115.12% — OVER BUDGET)
  PCO#029  Additional Drywall Material:   $1,490.76
  PCO#031  Generator Pad:                 $680.10
  PCO#046  Guest Bathroom:                $4,582.44
  PCO#047  Additional Framing Sub Labor:  $4,031.25
  PCO#048  Additional Siding Material:    $9,709.05
  PCO#050  Front Porch Ceiling:           $773.48
  PCO#064  Primary BR Balcony:            $11,460.60
  PCO#066  October Minor Repairs:         $281.25
  PCO#081  Fireplace Stone Veneer:        $10,574.69
  PCO#097  Interior Door Hardware:        $2,990.35
  PCO#098  Additional Stone Material:     $1,215.63
  PCO#099  Brick Finish Removal Addtl:    $2,965.63
  PCO#100  Temporary Air Conditioning:    $5,221.79
  PCO#101  Balcony Decking Material:      $2,196.23
  PCO#103  LR Fireplace Stone Labor:      $14,625.00 (65% complete)
  PCO#107  Fireplace Stone Samples:       $560.16

BACKUP DOCUMENTATION (56 pages — pages 10-66):
  Pages 11-12: Beckerle Lumber $26.82 brad nails + $54.56 misc, buyer Ficucello Tommy
  Pages 14,17: Dykes Lumber — SAME invoice #2302-079368 appears TWICE (pages 14 & 17)
    POTENTIAL DUPLICATE BILLING — same invoice number on two separate backup pages
  Page 20: HD receipt 01/13/23 — Diablo saw blades $119.91, Falsetti Anthony
  Page 23: Korth & Shannahan Painting $26,200 ($8,575 base SC2150-26 + $17,625 CO PCCO#073)
    Korth cumulative now ~$89,942.50 against $49,450 contract — OVER-BILLED by $40,492.50
  Page 23: Eastern Contractor Services — invoice dated 7/12/2022 — SIX MONTHS before billing
    period. Blatant out-of-period charge violating period-based billing requirements.
  Pages 26-28: A Touch of Glass — $6,650 shower enclosure invoice BUT coding allocations
    total $14,775 across multiple cost codes — exceeds invoice by $8,125 (POTENTIAL OVERBILLING).
    Also: ESTIMATE #17965 ($6,850 Guest Bath) labeled "Estimate" with 30-day validity —
    §15.3.2 violation, same pattern as Boards & Beams in REQ-12.
  Page 29: Online order $466.86 coded 9200M (Drywall), international courier
  Page 31: DeLeonardis Electric $8,829.62 for "REQ.5". Original contract $51,835 + CO#001
    $21,535 + CO#002 $9,500 = $82,870 total sub contract.
  Pages 34-35: C&F Steel Design $4,771.95 current / $10,368.48 total ornamental balcony
    with ($1,200) painting backcharge = $9,168.48 net. Coded 5100S/PCCO#061
  Pages 37-38: Dykes Lumber (Closter NJ) cedar & pine 1/11/23, plus small $265 invoice
  Pages 44-47: Build.com Order #84479949 — Baldwin door hardware $2,392.28 (PCCO#094)
  Page 49: Nyack Lumber — handwritten receipt, Alex DuFek (new vendor, informal receipt)
  Pages 53-54: Beckerle misc + Glen Rock Stair Corp invoice #59548 (new vendor)
  Page 63: HD Pro Xtra 2023 spend report through 03/01: $15,748.78 cumulative
  Page 65: Masonry Depot #560239/3 — natural thin stone (Ashlar) $413.50, 4100M/PCCO#104

KEY FINDINGS:
  1. BASE-TO-CO CONVERSION PATTERN: Systematic reduction of base contract values via
     credits while creating new COs for equivalent work. Base credits ~$92K while CO
     billing far exceeds, potentially generating additional 25% OH&P on restructured work.
  2. GLASS COMPANY OVERBILLING: A Touch of Glass invoice $6,650 but cost code allocations
     total $14,775 — $8,125 excess allocation across multiple cost codes.
  3. ESTIMATES AS INVOICES (AGAIN): A Touch of Glass submitted Estimate #17965 ($6,850)
     as backup. Same §15.3.2 violation pattern found in REQ-12 (Boards & Beams).
  4. POTENTIAL DUPLICATE INVOICE: Dykes Lumber invoice #2302-079368 appears on BOTH
     page 14 and page 17 of backup documentation.
  5. EXTREME OUT-OF-PERIOD: Eastern Contractor Services invoice dated 7/12/2022 billed
     in Jan-March 2023 period — 6+ months out of period.
  6. KORTH PAINTING CRITICAL: $26,200 this period brings Korth cumulative to ~$89,942.50
     against $49,450 contract — OVER-BILLED by $40,492.50 (182% of contract value).
  7. NO TIMECARDS: Zero employee timecards in 56 pages of backup for 3-month period.
  8. 66-PAGE REQUISITION: Largest document in the series — 3-month billing period unusual
     for monthly AIA process. Possible catch-up billing or delayed submission.`,
};

// ── REQ-14 (Invoice #14) — Application #14, Period 04/01/23-04/30/23 ────────
REQS_INITIAL[13] = {
  ...REQS_INITIAL[13],
  totalBilled: 256313.93,
  paidAmount: 0,
  architectApproved: 256313.93,
  retainageHeld: 0,
  laborCost: 0,
  materialCost: 3856.42,
  subCost: 108213.35,
  backupStatus: "PARTIAL",
  hasInvoiceSupport: true,
  flags: ["sub_as_labor", "blended_rate", "missing_invoice", "co_missing", "duplicate", "rate_anomaly", "markup_on_markup"],
  notes: `REQ-14 — APPLICATION #14 — Period 04/01/23 to 04/30/23
G702: Contract Sum $1,819,824.47 | Total Completed $1,597,418.04 | Retainage $0
Net Change Orders: $636,413.47 (up $85,134 from REQ-13R1 — largest CO jump)
70 pages — second-largest document in the series.

G703 GRAND TOTAL THIS PERIOD: $256,313.93
EXCEL TP: $140,087.21
VARIANCE: $256,313.93 - $140,087.21 = +$116,226.72

SIGNIFICANT BASE CONTRACT THIS PERIOD:
  Item 6  Masonry:        $75.00
  Item 21 Drywall:        $11,159.69
  Item 23 Wood Flooring:  $20,225.22 (now 100.00% — fully billed)
  Item 25 Painting:       ($1,997.50) — CREDIT this period
  Item 28 HVAC:           $72,615.00 (108.98% — OVER BUDGET by $9,547.30)
  HVAC is the dominant base line item — single trade at $72K+ in one month.

OVER-BUDGET G703 LINES:
  Item 1  Demolition:     100.71%
  Item 3  Concrete:       101.39%
  Item 28 HVAC:           108.98% ($9,547 over)
  PCO#025 Insulation:     118.90% ($4,230 over)

NEW CHANGE ORDERS FIRST APPEARING IN REQ-14 (many billing 100% immediately):
  PCO#113 Diffuser Upgrade:                 $1,221.65 (100%)
  PCO#114 Basement Handrail & Wall Sealing: $97.32 (24.49%)
  PCO#115 Fireplace Door:                   $1,874.34 (100%)
  PCO#116 Sewer Line Snaking & Camera:      $1,850.00 (100%)
  PCO#117 Additional Wood Floor Finishing:   $3,814.79 (100%)
  PCO#118 Returned Flooring Credit:         ($650.25) — CREDIT
  PCO#119 Chimney Exterior Brick Veneer:    $1,079.42 (100%)
  PCO#120 Decking Labor + Addtl Material:   $1,900.29 (100%)
  PCO#121 Addtl & Returned Door Hardware:   $1,166.56 (96.31%)
  PATTERN: 7 of 9 new COs billing at 100% on first appearance.

BACKUP DOCUMENTATION (60 pages — pages 11-70):
  Pages 11-12: Dykes Lumber $1,325.64 cedar + RETURN receipt ($1,183.20 credit, replaced
    with cheaper $298.80 Red Cedar grade). Net credit not clearly reflected.
  Pages 13-14: Glen Rock Stair Corp #58852 — dated 10/4/2022 — SIX MONTHS before April
    2023 billing period. Total $6,375 (6500S, SC2150-28 $5,655 + CCO 001 $720).
  Pages 26-27: Glen Rock Stair Corp #59548 — dated 2/8/2023 — SAME invoice # appeared
    in REQ-13 backup. POTENTIAL DUPLICATE BILLING across two requisitions.
  Page 27: HD receipt $97.19 painting supplies, Falsetti Anthony, 04/21/23
  Pages 29-30: Carpet World + HVAC Services invoice #i1869 — $17,000 for Radiant Heating
    at Living Room & Cow Barn. CRITICAL: Invoice states "Payment was previously rejected
    by Montana Contracting due to disagreements with client. Montana agreed to release
    this payment in exchange for sending crews to complete work." Transaction date 5/2/2023
    — POST-PERIOD (after April 30 billing end). Disputed payment included in billing.
  Page 31: HVAC invoice #i1... — $15,850 (relocate boiler $8,400 + A/C $5,200 + air
    handlers $2,250). Balance due $8,400 after $7,450 prior payments. Coded 23000S/PCCO#003.
  Pages 33-34: C&F Steel Design #1738 — $4,771.95 ornamental balcony (5100S/PCCO#061).
    Uses ESTIMATE format with completion percentages.
  Pages 36-70: KORTH & SHANNAHAN Painting — MASSIVE 6-page Invoice #9922 (2/27/2023):
    CRITICAL FINDINGS:
    a) CARPENTRY BILLED AS PAINTING: Majority of line items are CARPENTRY work (door
       modifications, ceiling beams, shelving, window casing, staircase risers) billed
       by a PAINTING subcontractor. Cross-trade billing indicates potential scope confusion
       or cost allocation manipulation.
    b) RECONCILIATION INVOICE: Credits prior invoices #9798 (-$9,825), #9853 (-$24,580),
       #9888 (-$26,200) plus deposit (-$7,527.50). These were billed in REQ-11, 12, 13
       — verify no double-counting of underlying charges.
    c) MULTIPLE INCLUSIONS: Same Invoice #9922 appears to be included 2-3 times in backup.
    d) CODED TO NON-PAINTING TRADE: One section coded PCCO#108 / 2900S (not painting 9900S).
    e) Balance Due: $3,500 after all credits applied.
    f) Subtotal before credits: $26,252.50 across painting + carpentry.
  Page 45: Buildmart LLC (McAllen, Texas) — out-of-state vendor, PAID stamp 03/21/2023.
  Page 51: Mike's Drain Service — handwritten receipt for sewer work (PCO#116).
  Page 59: Build.com — Baldwin door hardware $1,166.56 (PCO#121), 04/19/23.
  Page 61: HD Pro Xtra cumulative spend $27,672.35 (up $12K from REQ-13's $15,749).

KEY FINDINGS:
  1. HVAC PAYMENT DISPUTE: $17,000 HVAC invoice explicitly states payment was "previously
     rejected due to disagreements with client" and released conditionally. Billing disputed
     work to owner requires documentation of resolution. Post-period date (5/2/2023).
  2. HVAC OVER-BUDGET: $72,615 TP brings HVAC to 108.98% of $108,300 scheduled value —
     $9,547 over budget in a single period. Combined with $17K disputed payment.
  3. KORTH CROSS-TRADE BILLING: Painting subcontractor billing primarily for carpentry
     work (doors, beams, shelving, windows, stairs). Challenges cost allocation integrity.
  4. KORTH RECONCILIATION RISK: Invoice #9922 credits $60,605 of prior invoices (9798,
     9853, 9888) while re-billing $26,252.50. Prior invoices were already in REQ-11/12/13.
  5. GLEN ROCK STAIR DUPLICATE: Invoice #59548 appears in both REQ-13 and REQ-14 backup.
  6. GLEN ROCK OUT-OF-PERIOD: Invoice #58852 dated 10/4/2022 billed in April 2023 — 6 months late.
  7. NO TIMECARDS: Zero employee timecards in 60 pages of backup.
  8. MANY NEW COs AT 100%: 7 of 9 new change orders billing at 100% immediately — no
     progress billing, suggesting COs created retroactively after work completed.`,
};

REQS_INITIAL[14] = {
  ...REQS_INITIAL[14],
  totalBilled: 6451.64,
  paidAmount: 0,
  architectApproved: 6451.64,
  retainageHeld: 0,
  laborCost: 0,
  materialCost: 146.31,
  subCost: 5015.00,
  backupStatus: "PARTIAL",
  hasInvoiceSupport: true,
  flags: ["sub_as_labor", "blended_rate", "co_missing", "rate_anomaly"],
  notes: `REQ-15 — APPLICATION #15 — Period 12/01/23 to 12/30/23
G702: Contract Sum $1,729,186.84 | Total Completed $1,603,869.68 | Retainage $0
Net Change Orders: $545,775.84 (DECREASED $90,637.63 from REQ-14 — COs removed/credited)
Application Date: 1/17/2024 (filed in January 2024)
12 pages — smallest requisition in the series. 7-MONTH GAP from REQ-14 (April to December 2023).
G703 GRAND TOTAL THIS PERIOD: $6,451.64
EXCEL TP: $6,451.64
VARIANCE: $0.00 — ONLY REQUISITION WITH ZERO VARIANCE (G703 matches Excel perfectly)

COST BREAKDOWN:
  ABC Supply #26601108: $135.00 + $11.31 tax = $146.31 (aluminum trim — dated 05/16/2022, 19 MONTHS out of period)
  DeLeonardis Electric #2544/2681-T: $5,015.00 of $11,674.72 balance due (dated 7/18/2023, 5 months out of period)
  Total Cost: $5,161.31 | OH&P (25%): $1,290.33 | Grand Total: $6,451.64

G703 NOTABLE:
  CO Totals: $545,775.84 SV vs $604,234.33 completed = 110.71% (collectively OVER BUDGET)
  Over-budget lines: Demolition 100.71%, Concrete 101.39%, HVAC 108.98%, Insulation 115.12%
  New COs added: PCO#122-130 (8 new since REQ-14). CO total DECREASED — unprecedented.
  Balcony Railing TP $7,440 + Electric TP $5,015 = $12,455 gross positive TPs
  Negative TPs on other lines from CO restructuring offset to net $5,161.31 cost + $1,290.33 OH&P

KEY FINDINGS:
  1. MASSIVE UNAPPLIED CREDITS ($135,385+): Seven credit COs at 0% completion — owner never received:
     PCO#010 Plumbing Base Sub Credit ($4,550), PCO#011 Electrical Base Sub Credit ($16,270),
     PCO#013 Lighting Fixture Credit to Owner ($14,500), PCO#026 Excavation Credit ($5,208.63),
     PCO#027 Window Install Credit ($4,218.75), PCO#129 Allowance Reconciliation ($24,248.24),
     PCO#130 GC Owner Variance Split ($66,389.39). These credits are ON the G703 schedule
     but at 0% — Montana acknowledged them but never applied them.
  2. PCO#130 "GC OWNER VARIANCE SPLIT" ($66,389.39): Largest single unapplied credit. Name
     suggests Montana acknowledged a variance/overcharge owed to owner but never credited it.
     This is potentially the most significant single finding in the entire audit.
  3. PCO#129 ALLOWANCE RECONCILIATION ($24,248.24): Allowance credits that should have been
     returned to owner per standard AIA allowance procedures. Never applied.
  4. CO DECREASE ANOMALY: Net COs dropped $90,637 from REQ-14 ($636,413 to $545,776) —
     unprecedented in this project. Credit COs added but mostly not applied.
     PCO#123 Interior Trim Reconciliation ($11,695.31) WAS applied (100%),
     but PCO#129 and PCO#130 (the largest credits) remain at 0%.
  5. PCO#127 ELECTRICAL EXTRAS: $42,400 CO for 9 months of work (07/21/22-04/17/23)
     billed at 100% immediately. No itemized breakdown provided.
  6. ELECTRIC SUB vs G703 DISCREPANCY: DeLeonardis contract is $82,870 ($51,835 base +
     $31,035 in COs). Sub received $71,195 (86%), but G703 base Electric only at 50.93%.
     The $101,775 G703 SV vs $82,870 sub contract = $18,905 discrepancy.
  7. OUT-OF-PERIOD: ABC Supply dated 05/16/2022 (19 months before billing period).
     DeLeonardis dated 7/18/2023 (5 months before billing period).
     BOTH backup invoices are out of period.
  8. THINNEST BACKUP: Only 2 pages of backup for entire requisition. No backup for
     $7,440 Balcony Railing TP shown on G703 line item.
  9. NO TIMECARDS: Zero employee timecards (consistent with all prior REQs).
  10. 7-MONTH GAP: No requisitions from May through November 2023. REQ-15 bills
      only $6,451.64. Combined with $135K in unapplied credits and the CO decrease,
      strongly suggests project relationship deteriorated before termination.`,
};

REQS_INITIAL[15] = {
  ...REQS_INITIAL[15],
  totalBilled: 235461.28,
  paidAmount: 0,
  architectApproved: 235461.28,
  retainageHeld: 0,
  laborCost: 0,
  materialCost: 47236.35,
  subCost: 141136.63,
  backupStatus: "PARTIAL",
  hasInvoiceSupport: true,
  flags: ["sub_as_labor", "markup_on_markup", "co_missing", "rate_anomaly", "no_timesheet"],
  notes: `REQ-16 — APPLICATION #16 — Period 01/01/24 to 01/30/24
G702: Original Contract $1,183,411.00 | Net COs $602,758.41 | Contract Sum $1,786,169.41
Total Completed to Date: $1,839,330.96 | Retainage $0 | Previous Certificates: $1,603,869.68
CURRENT PAYMENT DUE: $235,461.28 | Balance to Finish: -$53,161.55
Architect Certified: $235,461.28

G703 GRAND TOTAL THIS PERIOD: $235,461.28
Contract lines TP: $252,880.48 | CO lines TP: -$17,419.20 | Net: $235,461.28

MAJOR LINE ITEMS THIS PERIOD:
  Electric: $49,940.00 (billed $101,775 / $101,775 SV = 100%)
  Custom Casework: $41,793.75 (billed $97,125 / $62,500 SV = 155.40% — OVER BUDGET)
  OH&P (25%): $27,487.80
  Doors & Frames: $22,622.47 (billed $25,275 / $25,275 SV = 100%)
  Masonry: $20,382.13 (billed $67,000 / $45,000 SV = 148.89% — OVER BUDGET)
  Shower Enclosures: $20,000.00 (100% billed this period, new line)
  Insulation: $15,819.92 (billed $30,000 / $15,000 SV = 200.00% — MASSIVELY OVER BUDGET)
  Plumbing: $15,450.00 (billed $95,850 / $95,850 SV = 100%)
  Excavation: $8,192.50 (billed $28,000 / $28,000 SV = 100%)
  Sawcutting: $8,000.00 (100% billed this period, new line)
  Window Install: $6,675.00
  Drywall: $5,125.35
  Balcony Railing: $4,943.66
  Tile: $2,700.00
  Flooring: $1,950.00
  Cooling: -$3,102.70 (credit)

OVER-BUDGET G703 LINES (cumulative):
  Framing Material: 165.19% ($69,281 vs $41,945 SV) — over by $27,336
  Custom Casework: 155.40% ($97,125 vs $62,500 SV) — over by $34,625
  Spiral Stair: 122.59% ($24,559 vs $20,033 SV) — over by $4,526
  Insulation: 200.00% ($30,000 vs $15,000 SV) — over by $15,000
  Siding: 118.11% ($65,999 vs $55,878 SV) — over by $10,121
  Roofing: 115.60% ($53,178 vs $46,000 SV) — over by $7,178
  Interior Trim: 113.14% ($36,543 vs $32,300 SV) — over by $4,243
  Framing Labor: 114.28% ($44,483 vs $38,925 SV) — over by $5,558
  Concrete: 101.39% ($27,424 vs $27,043 SV) — over by $381
  HVAC: 108.98% ($73,815 vs $67,736 SV) — over by $6,079

CHANGE ORDER STATUS:
  131 PCOs on schedule ($602,758.41 total)
  COs increased from $545,776 (REQ-15) to $602,758 — added $56,983 in new COs
  CO completion: $586,815.13 of $602,758.41 = 97.36%
  $135,385 in unapplied credit COs STILL at 0% (carried from REQ-15)

KEY FINDINGS:
  1. LARGEST SINGLE REQUISITION: $235,461 exceeds REQ-08 ($192,165) as the biggest bill.
  2. PROJECT OVER-BILLED: Total completed $1,839,331 vs contract sum $1,786,169 = 102.97% ($53,162 over).
  3. INSULATION AT 200%: Billed $30,000 on a $15,000 line item — double the budgeted amount.
  4. CUSTOM CASEWORK AT 155%: $34,625 over budget with no CO to cover the overage.
  5. FRAMING MATERIAL AT 165%: $27,336 over budget — largest dollar overbilling.
  6. UNAPPLIED CREDITS PERSIST: Same $135,385 in credit COs at 0% from REQ-15 remain unapplied.
  7. NEW CO ADDITIONS: $56,983 in new COs added (net) since REQ-15 but credits still not applied.
  8. NO TIMECARDS: Zero employee timecards (consistent with all prior REQs).
  9. OH&P: $27,487.80 charged this period. Applied to all lines including over-budget ones.
  10. NEGATIVE BALANCE: Project at -$53,162 balance. MC billed beyond contract + COs.`,
};

// ── Storage ───────────────────────────────────────────────────────────────────
async function storageGet(key) {
  try { const r = await window.storage.get(key); return r ? JSON.parse(r.value) : null; }
  catch { return null; }
}
async function storageSet(key, val) {
  try { await window.storage.set(key, JSON.stringify(val)); } catch {}
}

// ── File Storage (Supabase Storage bucket) ───────────────────────────────────
async function fileUpload(file, path) {
  const sb = window._sb;
  if (!sb) { console.warn("[Files] No Supabase client — file upload skipped"); return null; }
  const { data, error } = await sb.storage.from("case-files").upload(path, file, { upsert: true });
  if (error) { console.error("[Files] Upload failed:", error.message); return null; }
  return data.path;
}

function fileGetUrl(path) {
  const sb = window._sb;
  if (!sb || !path) return null;
  const { data } = sb.storage.from("case-files").getPublicUrl(path);
  return data?.publicUrl || null;
}

async function fileDelete(path) {
  const sb = window._sb;
  if (!sb || !path) return false;
  const { error } = await sb.storage.from("case-files").remove([path]);
  if (error) { console.error("[Files] Delete failed:", error.message); return false; }
  return true;
}

function formatFileSize(bytes) {
  if (!bytes || bytes === 0) return "0 B";
  const units = ["B", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return (bytes / Math.pow(1024, i)).toFixed(i > 0 ? 1 : 0) + " " + units[i];
}

function getMimeIcon(mime, size = 16, color = T.textMid) {
  if (!mime) return <Ic name="file-text" size={size} color={color} />;
  if (mime.startsWith("image/")) return <Ic name="image" size={size} color={color} />;
  if (mime === "application/pdf") return <Ic name="book" size={size} color={color} />;
  if (mime.includes("sheet") || mime.includes("excel") || mime.includes("xlsx")) return <Ic name="bar-chart" size={size} color={color} />;
  if (mime.includes("word") || mime.includes("doc")) return <Ic name="edit" size={size} color={color} />;
  return <Ic name="file-text" size={size} color={color} />;
}

// ── Auto-Categorization Engine ───────────────────────────────────────────────
const REQ_PATTERN = /req[quistion]*[- _.]?#?(\d{1,2})/i;
const INVOICE_PATTERN = /inv(oice)?[- _#.]?\d*/i;
const CO_PATTERN = /c\.?o\.?[- _#.]?\d+|change[- _]?order/i;
const INSPECTION_PATTERN = /inspect|report|punchlist|punch[- ]?list|deficienc/i;
const LEGAL_PATTERN = /arbitrat|aaa|demand|filing|legal|attorney|lien|affidavit/i;
const PHOTO_PATTERN = /\.(jpg|jpeg|png|gif|bmp|tiff|heic|webp)$/i;
const CONTRACT_PATTERN = /contract|aia|a101|a110|a201|agreement|scope/i;

const COST_CODE_MAP = {
  "01": "General Conditions", "02": "Site Work", "03": "Concrete", "04": "Masonry",
  "05": "Metals / Steel", "06": "Carpentry", "07": "Thermal / Moisture", "08": "Doors & Windows",
  "09": "Finishes", "10": "Specialties", "11": "Equipment", "12": "Furnishings",
  "13": "Special Construction", "14": "Conveying Systems", "15": "Mechanical / Plumbing",
  "16": "Electrical",
};

const VENDOR_MAP = [
  "Korth", "Liberty", "Pinnacle", "Lakeland", "Adirondack", "Catskill", "Hudson",
  "Valley", "Empire", "Precision", "Summit", "Rockland", "Heritage", "Alpine",
  "Northeast", "Premier", "Quality", "Superior", "Sterling", "Patriot",
  "Nyack", "Haverstraw", "Highland", "Bear Mountain", "Stony Point",
];

function autoClassifyFile(fileName) {
  const result = { category: "other", status: "received", tags: [], linkedReqs: [], vendor: null, costCode: null };
  const name = fileName || "";
  const lower = name.toLowerCase();

  // Detect linked REQs
  const reqMatch = name.match(new RegExp(REQ_PATTERN.source, "gi"));
  if (reqMatch) {
    reqMatch.forEach(m => {
      const num = m.match(/(\d{1,2})/);
      if (num) {
        const reqId = "REQ-" + num[1].padStart(2, "0");
        if (!result.linkedReqs.includes(reqId)) result.linkedReqs.push(reqId);
        if (!result.tags.includes(reqId)) result.tags.push(reqId);
      }
    });
    result.category = "requisition";
  }

  // Detect category from filename patterns
  if (PHOTO_PATTERN.test(name)) result.category = "photo";
  else if (LEGAL_PATTERN.test(lower)) result.category = result.category === "other" ? "arbitration" : result.category;
  else if (CONTRACT_PATTERN.test(lower)) result.category = result.category === "other" ? "contract" : result.category;
  else if (CO_PATTERN.test(lower)) result.category = result.category === "other" ? "change_order" : result.category;
  else if (INVOICE_PATTERN.test(lower)) result.category = result.category === "other" ? "invoice" : result.category;
  else if (INSPECTION_PATTERN.test(lower)) result.category = result.category === "other" ? "inspection" : result.category;

  // Auto-assign status based on category
  const STATUS_BY_CATEGORY = {
    requisition: "submitted",   // MC submitted requisitions to owner
    invoice: "received",        // invoices received from subs/vendors
    change_order: "active",     // COs are active until resolved
    contract: "active",         // contracts are active documents
    correspondence: "received", // letters/emails received
    inspection: "filed",        // inspection reports are filed
    photo: "filed",             // photos are filed as evidence
    arbitration: "filed",       // legal filings
    other: "received",          // default for unknown
  };
  result.status = STATUS_BY_CATEGORY[result.category] || "received";

  // Refine status from filename keywords
  if (/final|executed|signed|closed/i.test(lower)) result.status = "final";
  else if (/draft/i.test(lower)) result.status = "draft";
  else if (/disput|reject/i.test(lower)) result.status = "disputed";
  else if (/approv|confirm|accept/i.test(lower)) result.status = "confirmed";

  // Detect cost codes (e.g., "01-" prefix in filename)
  const ccMatch = name.match(/\b(\d{2})[- ]/);
  if (ccMatch && COST_CODE_MAP[ccMatch[1]]) {
    result.costCode = ccMatch[1] + " — " + COST_CODE_MAP[ccMatch[1]];
    result.tags.push(COST_CODE_MAP[ccMatch[1]]);
  }

  // Detect vendors
  for (const vendor of VENDOR_MAP) {
    if (lower.includes(vendor.toLowerCase())) {
      result.vendor = vendor;
      if (!result.tags.includes(vendor)) result.tags.push(vendor);
      break;
    }
  }

  // File extension tag
  const ext = name.split(".").pop()?.toUpperCase();
  if (ext && ext.length <= 5 && ext !== name.toUpperCase()) {
    result.tags.push(ext);
  }

  return result;
}

// ── File Parsing (PDF & XLSX) ────────────────────────────────────────────────
async function extractPdfText(fileUrl) {
  if (!window.pdfjsLib) { console.warn("[Parse] pdf.js not loaded"); return null; }
  try {
    const pdf = await window.pdfjsLib.getDocument(fileUrl).promise;
    let text = "";
    const maxPages = Math.min(pdf.numPages, 10);
    for (let i = 1; i <= maxPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(item => item.str).join(" ") + "\n";
    }
    return text.slice(0, 3000);
  } catch (err) {
    console.warn("[Parse] PDF extraction failed:", err.message);
    return null;
  }
}

async function extractXlsxData(file) {
  if (!window.XLSX) { console.warn("[Parse] SheetJS not loaded"); return null; }
  try {
    const buf = await file.arrayBuffer();
    const wb = window.XLSX.read(buf, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = window.XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
    const text = rows.slice(0, 50).map(r => r.join(" | ")).join("\n");
    return text.slice(0, 3000);
  } catch (err) {
    console.warn("[Parse] XLSX extraction failed:", err.message);
    return null;
  }
}

function extractTagsFromText(text) {
  if (!text) return [];
  const tags = [];
  // Dollar amounts
  const dollars = text.match(/\$[\d,]+\.?\d*/g);
  if (dollars) dollars.slice(0, 5).forEach(d => { if (!tags.includes(d)) tags.push(d); });
  // REQ references in text
  const reqs = text.match(/req[quistion]*[- _.]?#?\d{1,2}/gi);
  if (reqs) reqs.forEach(r => {
    const num = r.match(/(\d{1,2})/);
    if (num) { const id = "REQ-" + num[1].padStart(2, "0"); if (!tags.includes(id)) tags.push(id); }
  });
  // CO references
  const cos = text.match(/c\.?o\.?[- _#.]?\d+/gi);
  if (cos) cos.slice(0, 3).forEach(c => { if (!tags.includes(c.toUpperCase())) tags.push(c.toUpperCase()); });
  // Vendor matches
  for (const v of VENDOR_MAP) {
    if (text.toLowerCase().includes(v.toLowerCase()) && !tags.includes(v)) tags.push(v);
  }
  return tags.slice(0, 15);
}

// ── Helpers ───────────────────────────────────────────────────────────────────
function computeRisk(req) {
  if (!req.flags.length) return "CLEAR";
  const hasHigh = req.flags.some(f => AUDIT_FLAGS.find(a => a.id === f)?.risk === "HIGH");
  if (hasHigh) return "HIGH";
  return req.flags.length >= 2 ? "MEDIUM" : "LOW";
}

const riskStyle = r => ({
  HIGH:   { color: T.red,    bg: T.redBg,    border: T.redBorder },
  MEDIUM: { color: T.amber,  bg: T.amberBg,  border: T.amberBorder },
  LOW:    { color: T.blue,   bg: T.blueBg,   border: T.blueBorder },
  CLEAR:  { color: T.green,  bg: T.greenBg,  border: T.greenBorder },
}[r] || { color: T.textMuted, bg: T.surfaceHover, border: T.border });

const statusStyle = s => ({
  DISPUTED: { color: T.red,    bg: T.redBg,    border: T.redBorder },
  AGREED:   { color: T.green,  bg: T.greenBg,  border: T.greenBorder },
  WAIVED:   { color: T.purple, bg: T.purpleBg, border: T.purpleBorder },
  PENDING:  { color: T.amber,  bg: T.amberBg,  border: T.amberBorder },
}[s] || { color: T.textMuted, bg: T.surfaceHover, border: T.border });

const strengthStyle = s => ({
  STRONG:   { color: T.green,     bg: T.greenBg },
  MODERATE: { color: T.amber,     bg: T.amberBg },
  WEAK:     { color: T.red,       bg: T.redBg },
  "N/A":    { color: T.textMuted, bg: T.surfaceHover },
}[s] || { color: T.textMuted, bg: T.surfaceHover });

// ── Money formatting ──────────────────────────────────────────────────────────
// Returns { dollars: "264,373", cents: "75" }
function parseMoney(n) {
  const abs = Math.abs(n || 0);
  const str = abs.toFixed(2);
  const [whole, dec] = str.split(".");
  return { dollars: parseInt(whole).toLocaleString("en-US"), cents: dec, negative: n < 0 };
}

// The main Money display component — split dollar/cents with muted prefix
function Money({ amount = 0, color = T.text, size = "md", neg = false }) {
  const { dollars, cents, negative } = parseMoney(amount);
  const isNeg = neg || negative;
  const sizes = {
    xs:  { sym: 9,  main: 12, dec: 10 },
    sm:  { sym: 10, main: 14, dec: 11 },
    md:  { sym: 11, main: 16, dec: 12 },
    lg:  { sym: 13, main: 22, dec: 14 },
    xl:  { sym: 15, main: 28, dec: 17 },
  };
  const s = sizes[size] || sizes.md;
  return (
    <span style={{ display: "inline-flex", alignItems: "baseline", gap: 1, fontFamily: T.num, fontVariantNumeric: "tabular-nums", color }}>
      {isNeg && <span style={{ fontSize: s.sym, color, opacity: 0.6, marginRight: 1 }}>–</span>}
      <span style={{ fontSize: s.sym, opacity: 0.45, fontWeight: 500, letterSpacing: 0 }}>$</span>
      <span style={{ fontSize: s.main, fontWeight: 600, letterSpacing: -0.5 }}>{dollars}</span>
      <span style={{ fontSize: s.dec, opacity: 0.4, fontWeight: 500, letterSpacing: 0 }}>.{cents}</span>
    </span>
  );
}

// Legacy inline string formatter (used in text/labels only)
const $ = (n) => "$" + (Math.abs(n || 0)).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

// ── Shared Components ─────────────────────────────────────────────────────────
function Badge({ label, style: { color, bg, border } }) {
  return (
    <span style={{ display: "inline-flex", alignItems: "center", fontSize: 11, fontWeight: 500, letterSpacing: 0.2, padding: "3px 10px", borderRadius: 6, background: bg, color, border: `1px solid ${border}`, fontFamily: T.font, whiteSpace: "nowrap", lineHeight: 1.4 }}>
      {label}
    </span>
  );
}

function Mono({ children, color = T.text, size = 13 }) {
  return <span style={{ fontFamily: T.mono, fontSize: size, color, letterSpacing: -0.3 }}>{children}</span>;
}

function SectionTitle({ title, subtitle }) {
  return (
    <div style={{ marginBottom: 24 }}>
      <h2 style={{ margin: 0, fontSize: 24, fontWeight: 700, color: T.text, fontFamily: T.font, letterSpacing: -0.5, lineHeight: 1.2 }}>{title}</h2>
      {subtitle && <p style={{ margin: "6px 0 0", fontSize: 13, color: T.textMid, fontFamily: T.font, lineHeight: 1.5 }}>{subtitle}</p>}
    </div>
  );
}

function Card({ children, style = {}, padding = 20 }) {
  return (
    <div style={{ background: T.surface, border: `1px solid ${T.border}`, borderRadius: 10, padding, boxShadow: T.sh1, overflow: "hidden", ...style }}>
      {children}
    </div>
  );
}

function CardLabel({ label }) {
  return <div style={{ fontSize: 11, fontWeight: 600, letterSpacing: 0.8, color: T.textMuted, textTransform: "uppercase", marginBottom: 12, fontFamily: T.font }}>{label}</div>;
}

function KPI({ label, value, sub, color = T.text, accent = false, isMoney = false, rawAmount = 0 }) {
  return (
    <Card style={{ borderTop: accent ? `3px solid ${T.accent}` : undefined, overflow: "visible" }}>
      <div style={{ fontSize: 11, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, textTransform: "uppercase", marginBottom: 10, fontFamily: T.font }}>{label}</div>
      <div style={{ marginBottom: 4 }}>
        {isMoney
          ? <Money amount={rawAmount} color={color} size="xl" />
          : <span style={{ fontFamily: T.font, fontSize: 28, fontWeight: 700, color, letterSpacing: -1 }}>{value}</span>
        }
      </div>
      {sub && <div style={{ fontSize: 12, color: T.textMuted, fontFamily: T.font, marginTop: 4 }}>{sub}</div>}
    </Card>
  );
}

function TextInput({ label, value, onChange, type = "text" }) {
  const [focused, setFocused] = useState(false);
  return (
    <div style={{ marginBottom: 14 }}>
      <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.3, marginBottom: 5, fontFamily: T.font }}>{label}</label>
      <input type={type} value={value ?? ""} onChange={e => onChange(type === "number" ? parseFloat(e.target.value) || 0 : e.target.value)}
        onFocus={() => setFocused(true)} onBlur={() => setFocused(false)}
        style={{ width: "100%", background: T.bg, border: `1px solid ${focused ? T.accent : T.border}`, borderRadius: 8, padding: "8px 12px", color: T.text, fontSize: 13, outline: "none", boxSizing: "border-box", fontFamily: type === "number" ? T.mono : T.font, transition: T.fast }} />
    </div>
  );
}

function SegmentControl({ options, value, onChange, colorFn }) {
  return (
    <div style={{ display: "flex", gap: 4, background: T.bg, borderRadius: 8, padding: 3 }}>
      {options.map(opt => {
        const active = value === opt;
        const col = colorFn ? colorFn(opt) : { color: T.text, bg: T.surface, border: T.border };
        return (
          <button key={opt} onClick={() => onChange(opt)} style={{
            flex: 1, padding: "6px 8px", borderRadius: 6, border: active ? `1px solid ${col.border}` : "1px solid transparent",
            background: active ? col.bg : "transparent", color: active ? col.color : T.textMuted,
            fontSize: 11, fontWeight: active ? 600 : 400, cursor: "pointer", fontFamily: T.font, transition: T.fast,
            boxShadow: active ? T.sh1 : "none",
          }}>{opt}</button>
        );
      })}
    </div>
  );
}

// ── DASHBOARD ─────────────────────────────────────────────────────────────────
function Dashboard({ reqs, claims }) {
  const totalBilled = reqs.reduce((s, r) => s + (r.totalBilled || 0), 0);
  const totalPaid = reqs.reduce((s, r) => s + (r.paidAmount || 0), 0);
  const highRisk = reqs.filter(r => computeRisk(r) === "HIGH").length;
  const totalOwner = claims.reduce((s, c) => s + c.ownerAmount, 0);
  const totalAgreed = claims.reduce((s, c) => s + c.agreedAmount, 0);
  const openBalance = totalBilled - totalPaid;
  const totalWaived = claims.filter(c => c.status === "WAIVED").reduce((s, c) => s + c.ownerAmount, 0);
  const totalDisputed = claims.filter(c => c.status === "DISPUTED").reduce((s, c) => s + c.ownerAmount, 0);

  const riskDist = { HIGH: 0, MEDIUM: 0, LOW: 0, CLEAR: 0 };
  reqs.forEach(r => riskDist[computeRisk(r)]++);

  return (
    <div>
      <SectionTitle title="Case Dashboard" subtitle="Tharp/Bumgardner · 515 N. Midland Ave, Upper Nyack NY · AIA A110-2021 Cost-Plus · AAA Arbitration" />

      <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 12, marginBottom: 12 }}>
        <KPI label="Total Billed" isMoney rawAmount={totalBilled} sub="16 payment applications" accent color={T.accent} />
        <KPI label="Open Balance" isMoney rawAmount={openBalance} sub="Billed minus payments received" color={T.amber} />
        <KPI label="High Risk Reqs" value={`${highRisk}/16`} sub="Require mitigation" color={highRisk > 0 ? T.red : T.green} />
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 20 }}>
        <KPI label="Owner's Total Claims" isMoney rawAmount={totalOwner} sub="Gross claimed damages" color={T.red} />
        <KPI label="MC Agreed Credits" isMoney rawAmount={totalAgreed} sub="Documented concessions" color={T.amber} />
        <KPI label="Active Disputed" isMoney rawAmount={totalDisputed} sub="Needs arbitration" color={T.red} />
        <KPI label="Barred by §21.11" isMoney rawAmount={totalWaived} sub="Consequential waiver" color={T.purple} />
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 16 }}>
        <Card>
          <CardLabel label="Requisition Risk Distribution" />
          {["HIGH", "MEDIUM", "LOW", "CLEAR"].map(level => {
            const s = riskStyle(level);
            const pct = Math.round((riskDist[level] / 16) * 100);
            return (
              <div key={level} style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 14 }}>
                <Badge label={level} style={s} />
                <div style={{ flex: 1, height: 10, background: T.border, borderRadius: 5, overflow: "hidden" }}>
                  <div style={{ height: 10, background: s.color, width: `${pct}%`, borderRadius: 5, transition: "width 0.4s ease" }} />
                </div>
                <span style={{ fontFamily: T.mono, fontSize: 13, color: T.textMid, minWidth: 32, textAlign: "right" }}>{riskDist[level]}</span>
              </div>
            );
          })}
        </Card>

        <Card>
          <CardLabel label="Net Position Summary" />
          {[
            { label: "Owner's Gross Demand", val: totalOwner, color: T.red, neg: false },
            { label: "Barred — §21.11 Consequential", val: totalWaived, color: T.purple, neg: true },
            { label: "Disputed w/ Strong Defense", val: totalDisputed, color: T.blue, neg: true },
            { label: "MC Agreed Credits", val: totalAgreed, color: T.amber, neg: false },
          ].map(row => (
            <div key={row.label} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "9px 0", borderBottom: `1px solid ${T.border}` }}>
              <span style={{ fontSize: 13, color: T.textMid, fontFamily: T.font }}>{row.label}</span>
              <Money amount={row.val} color={row.color} size="sm" neg={row.neg} />
            </div>
          ))}
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "12px 0 0", marginTop: 4 }}>
            <span style={{ fontSize: 13, fontWeight: 600, color: T.text, fontFamily: T.font }}>Settlement Target</span>
            <Money amount={totalAgreed} color={T.accent} size="lg" />
          </div>
        </Card>
      </div>

      {/* Priority Items */}
      <Card>
        <CardLabel label="Priority Audit Items — Mitigate Before Arbitration" />
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10 }}>
          {[
            { n: 1, text: "Reconcile $60/hr labor rate vs actual burdened payroll records (W-2s, payroll register, WC audit)" },
            { n: 2, text: "DSL Landscaping billed at skilled trade rate as direct labor — reclassify or document actual rates" },
            { n: 3, text: "Identify all overhead items billed as materials (masks, tarps, rock salt, flashlights) — calculate exposure" },
            { n: 4, text: "Obtain compliant revised invoice from H&J Improvements #1316 — add date, scope, location, hourly vs lump" },
            { n: 5, text: "Obtain full subcontract and scope from DeLeonardis Electric — job tickets 2544/2681, original CO #001" },
            { n: 6, text: "Document all 125 change orders with signed COs to support delay causation defense" },
          ].map(item => (
            <div key={item.n} style={{ display: "flex", gap: 10, padding: 12, background: T.redBg, border: `1px solid ${T.redBorder}`, borderRadius: 8 }}>
              <span style={{ fontFamily: T.mono, fontSize: 11, color: T.red, fontWeight: 500, flexShrink: 0, marginTop: 1 }}>{item.n}.</span>
              <span style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, lineHeight: 1.55 }}>{item.text}</span>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
}

// ── REQUISITIONS ──────────────────────────────────────────────────────────────
function Requisitions({ reqs, updateReq, docs = [], updateDoc, addDoc }) {
  const [sel, setSel] = useState(null);
  const [uploading, setUploading] = useState([]);
  const [uploadSummary, setUploadSummary] = useState(null);
  const editing = sel ? reqs.find(r => r.id === sel) : null;
  const reqDocs = editing ? docs.filter(d => (d.linkedReqs || []).includes(editing.reqNumber)) : [];
  const backupData = editing ? BACKUP_VARIANCE[editing.id] : null;

  const processReqFiles = async (files) => {
    if (!files || files.length === 0) return;
    if (!window._sb) { alert("File upload requires cloud mode (Supabase)."); return; }
    const fileArr = Array.from(files);
    setUploading(fileArr.map(f => ({ name: f.name, progress: 0, status: "pending" })));
    for (let i = 0; i < fileArr.length; i++) {
      const file = fileArr[i];
      setUploading(prev => prev.map((u, j) => j === i ? { ...u, status: "uploading", progress: 30 } : u));
      const classify = autoClassifyFile(file.name);
      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
      const storagePath = classify.category + "/" + Date.now() + "-" + safeName;
      const path = await fileUpload(file, storagePath);
      if (!path) { setUploading(prev => prev.map((u, j) => j === i ? { ...u, status: "error", progress: 100 } : u)); continue; }
      setUploading(prev => prev.map((u, j) => j === i ? { ...u, progress: 60, status: "parsing" } : u));
      let extractedText = null; let textTags = [];
      const mime = file.type || "";
      if (mime === "application/pdf") { const url = fileGetUrl(path); if (url) extractedText = await extractPdfText(url); }
      else if (mime.includes("sheet") || mime.includes("excel") || file.name.match(/\.xlsx?$/i)) { extractedText = await extractXlsxData(file); }
      if (extractedText) textTags = extractTagsFromText(extractedText);
      const allLinkedReqs = [...new Set([editing.reqNumber, ...classify.linkedReqs, ...textTags.filter(t => t.match(/^REQ-\d{2}$/))])];
      const allFileTags = [...new Set([...classify.tags, ...textTags, editing.reqNumber])];
      setUploading(prev => prev.map((u, j) => j === i ? { ...u, progress: 90, status: "saving" } : u));
      const id = "doc-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 6);
      addDoc({ id, category: classify.category || "requisition", name: file.name.replace(/\.[^.]+$/, "").replace(/[_-]/g, " "),
        date: new Date().toISOString().slice(0, 10), description: `Uploaded from ${editing.reqNumber}`, parties: classify.vendor || "MC",
        status: classify.status || "submitted", notes: "", storagePath: path, fileName: file.name, fileSize: file.size, mimeType: mime,
        tags: allFileTags, linkedReqs: allLinkedReqs, extractedText, vendor: classify.vendor, costCode: classify.costCode });
      if (window._openaiKey && extractedText) {
        analyzeUploadedDoc({ id }, extractedText, docs).then(u => { if (u) updateDoc(id, u); }).catch(() => {});
      }
      setUploading(prev => prev.map((u, j) => j === i ? { ...u, progress: 100, status: "done" } : u));
    }
    setUploadSummary({ total: fileArr.length }); setTimeout(() => setUploading([]), 3000); setTimeout(() => setUploadSummary(null), 6000);
  };

  const toggleFlag = (reqId, flagId) => {
    const req = reqs.find(r => r.id === reqId);
    const flags = req.flags.includes(flagId) ? req.flags.filter(f => f !== flagId) : [...req.flags, flagId];
    updateReq(reqId, { flags });
  };
  const totals = { billed: 0, approved: 0, retainage: 0 };
  reqs.forEach(r => { totals.billed += r.totalBilled || 0; totals.retainage += r.retainageHeld || 0; });

  const ThStyle = { padding: "10px 14px", textAlign: "left", fontSize: 11, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, fontFamily: T.font, borderBottom: `1px solid ${T.border}`, background: T.bg };
  const TdStyle = { padding: "11px 14px", fontSize: 13, fontFamily: T.font, color: T.text, borderBottom: `1px solid ${T.border}` };

  return (
    <div style={{ display: "grid", gridTemplateColumns: editing ? "1fr 480px" : "1fr", gap: 20, alignItems: "start" }}>
      <div>
        <SectionTitle title="Requisition Catalog" subtitle="16 payment applications · Click any row to enter data and set audit flags" />
        <Card padding={0}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr>
                {["REQ #", "DATE", "BILLED", "RETAINAGE", "BACKUP", "RISK", "FLAGS"].map(h => (
                  <th key={h} style={ThStyle}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {reqs.map(req => {
                const risk = computeRisk(req);
                const rs = riskStyle(risk);
                const active = sel === req.id;
                return (
                  <tr key={req.id} onClick={() => setSel(active ? null : req.id)}
                    style={{ cursor: "pointer", background: active ? T.accentBg : "transparent", transition: "background 0.1s" }}
                    onMouseEnter={e => { if (!active) e.currentTarget.style.background = T.surfaceHover; }}
                    onMouseLeave={e => { if (!active) e.currentTarget.style.background = "transparent"; }}>
                    <td style={{ ...TdStyle, fontFamily: T.mono, fontWeight: 500, color: T.accent }}>{req.reqNumber}</td>
                    <td style={{ ...TdStyle, color: T.textMuted }}>{req.date || "—"}</td>
                    <td style={TdStyle}>{req.totalBilled ? <Money amount={req.totalBilled} size="sm" /> : <span style={{ color: T.textMuted }}>—</span>}</td>
                    <td style={TdStyle}>{req.retainageHeld ? <Money amount={req.retainageHeld} color={T.red} size="sm" /> : <span style={{ color: T.textMuted }}>—</span>}</td>
                    <td style={TdStyle}>
                      <Badge label={req.backupStatus} style={
                        req.backupStatus === "COMPLETE" ? { color: T.green, bg: T.greenBg, border: T.greenBorder } :
                        req.backupStatus === "PARTIAL" ? { color: T.amber, bg: T.amberBg, border: T.amberBorder } :
                        { color: T.red, bg: T.redBg, border: T.redBorder }
                      } />
                    </td>
                    <td style={TdStyle}><Badge label={risk} style={rs} /></td>
                    <td style={{ ...TdStyle, color: req.flags.length > 0 ? T.red : T.textMuted, fontFamily: T.mono, fontSize: 12 }}>
                      {req.flags.length > 0 ? `${req.flags.length}` : "—"}
                    </td>
                  </tr>
                );
              })}
            </tbody>
            <tfoot>
              <tr style={{ background: T.bg }}>
                <td colSpan={2} style={{ ...TdStyle, fontSize: 11, fontWeight: 600, color: T.textMuted, letterSpacing: 0.5, borderBottom: "none" }}>TOTALS</td>
                <td style={{ ...TdStyle, borderBottom: "none" }}><Money amount={totals.billed} size="sm" /></td>
                <td style={{ ...TdStyle, borderBottom: "none" }}><Money amount={totals.approved} color={T.green} size="sm" /></td>
                <td style={{ ...TdStyle, borderBottom: "none" }}><Money amount={totals.retainage} color={T.red} size="sm" /></td>
                <td colSpan={3} style={{ borderBottom: "none" }} />
              </tr>
            </tfoot>
          </table>
        </Card>
      </div>

      {editing && (
        <div style={{ position: "sticky", top: 16 }}>
          <Card>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16, paddingBottom: 14, borderBottom: `1px solid ${T.border}` }}>
              <span style={{ fontSize: 14, fontWeight: 600, color: T.text, fontFamily: T.font }}>{editing.reqNumber}</span>
              <button onClick={() => setSel(null)} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", fontSize: 20, lineHeight: 1, padding: 2 }}>×</button>
            </div>
            <div style={{ maxHeight: "75vh", overflowY: "auto", paddingRight: 4 }}>
              <TextInput label="Date" value={editing.date} onChange={v => updateReq(editing.id, { date: v })} type="date" />
              <TextInput label="Total Billed ($)" value={editing.totalBilled} onChange={v => updateReq(editing.id, { totalBilled: v })} type="number" />
              <TextInput label="Retainage Held ($)" value={editing.retainageHeld} onChange={v => updateReq(editing.id, { retainageHeld: v })} type="number" />
              <TextInput label="Labor Cost ($)" value={editing.laborCost} onChange={v => updateReq(editing.id, { laborCost: v })} type="number" />
              <TextInput label="Material Cost ($)" value={editing.materialCost} onChange={v => updateReq(editing.id, { materialCost: v })} type="number" />
              <TextInput label="Subcontractor Cost ($)" value={editing.subCost} onChange={v => updateReq(editing.id, { subCost: v })} type="number" />
              <TextInput label="Billed Labor Rate ($/hr)" value={editing.laborRate} onChange={v => updateReq(editing.id, { laborRate: v })} type="number" />

              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 6, fontFamily: T.font }}>BACKUP STATUS</label>
                <SegmentControl options={["COMPLETE", "PARTIAL", "MISSING"]} value={editing.backupStatus} onChange={v => updateReq(editing.id, { backupStatus: v })}
                  colorFn={s => s === "COMPLETE" ? { color: T.green, bg: T.greenBg, border: T.greenBorder } : s === "PARTIAL" ? { color: T.amber, bg: T.amberBg, border: T.amberBorder } : { color: T.red, bg: T.redBg, border: T.redBorder }} />
              </div>

              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 8, fontFamily: T.font }}>DOCUMENTATION ON FILE</label>
                {[{ f: "hasPayrollSupport", l: "Payroll / timesheets" }, { f: "hasInvoiceSupport", l: "Receipted invoices" }, { f: "hasCheckVouchers", l: "Check vouchers" }].map(cb => (
                  <label key={cb.f} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 7, cursor: "pointer" }}>
                    <input type="checkbox" checked={editing[cb.f]} onChange={e => updateReq(editing.id, { [cb.f]: e.target.checked })} style={{ accentColor: T.accent, width: 14, height: 14 }} />
                    <span style={{ fontSize: 13, color: editing[cb.f] ? T.text : T.textMuted, fontFamily: T.font }}>{cb.l}</span>
                  </label>
                ))}
              </div>

              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 8, fontFamily: T.font }}>AUDIT FLAGS</label>
                {AUDIT_FLAGS.map(flag => {
                  const active = editing.flags.includes(flag.id);
                  const col = flag.risk === "HIGH" ? T.red : flag.risk === "MEDIUM" ? T.amber : T.blue;
                  return (
                    <label key={flag.id} style={{ display: "flex", alignItems: "flex-start", gap: 8, marginBottom: 8, cursor: "pointer", padding: "6px 8px", borderRadius: 6, background: active ? (flag.risk === "HIGH" ? T.redBg : T.amberBg) : "transparent", transition: "background 0.1s" }}>
                      <input type="checkbox" checked={active} onChange={() => toggleFlag(editing.id, flag.id)} style={{ accentColor: col, marginTop: 2, flexShrink: 0 }} />
                      <div>
                        <span style={{ fontSize: 12, color: active ? col : T.textMid, fontFamily: T.font, lineHeight: 1.4, display: "block" }}>{flag.label}</span>
                        <span style={{ fontSize: 10, color: T.textMuted, fontFamily: T.mono }}>{flag.risk}</span>
                      </div>
                    </label>
                  );
                })}
              </div>

              <div>
                <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>NOTES</label>
                <textarea value={editing.notes} onChange={e => updateReq(editing.id, { notes: e.target.value })}
                  rows={3} style={{ width: "100%", background: T.bg, border: `1px solid ${T.border}`, borderRadius: 6, padding: "8px 10px", color: T.text, fontSize: 13, outline: "none", resize: "vertical", boxSizing: "border-box", fontFamily: T.font, lineHeight: 1.6 }} />
              </div>

              {/* ── LINKED DOCUMENTS ── */}
              <div style={{ marginTop: 20, paddingTop: 16, borderTop: `1px solid ${T.border}` }}>
                <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 8, fontFamily: T.font }}>
                  DOCUMENTS ({reqDocs.length})
                </label>
                {reqDocs.length === 0 && (
                  <div style={{ fontSize: 12, color: T.textMuted, fontFamily: T.font, padding: "8px 0" }}>
                    No documents linked to {editing.reqNumber}
                  </div>
                )}
                {reqDocs.map(doc => {
                  const hasFile = !!doc.storagePath;
                  return (
                    <div key={doc.id} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 10px",
                      borderRadius: 6, background: T.bg, border: `1px solid ${T.border}`, marginBottom: 6,
                      cursor: hasFile ? "pointer" : "default" }}
                      onClick={() => { if (hasFile) { const url = fileGetUrl(doc.storagePath); if (url) window.open(url, "_blank"); } }}>
                      <span style={{ flexShrink: 0 }}>{hasFile ? getMimeIcon(doc.mimeType, 18, T.accent) : <Ic name="file-text" size={18} color={T.textMuted} />}</span>
                      <div style={{ flex: 1, overflow: "hidden" }}>
                        <div style={{ fontSize: 12, fontWeight: 500, fontFamily: T.font, color: T.text,
                          overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{doc.name}</div>
                        <div style={{ fontSize: 10, color: T.textMuted, fontFamily: T.font }}>
                          {doc.date}{hasFile ? ` \u00b7 ${formatFileSize(doc.fileSize)}` : ""}
                        </div>
                      </div>
                      {hasFile && <span style={{ fontSize: 10, color: T.accent, fontFamily: T.font, flexShrink: 0 }}>View</span>}
                    </div>
                  );
                })}
                {/* Upload drop zone */}
                <div onDragOver={e => e.preventDefault()}
                  onDrop={e => { e.preventDefault(); processReqFiles(e.dataTransfer.files); }}
                  onClick={() => document.getElementById(`req-upload-${editing.id}`)?.click()}
                  style={{ border: `1.5px dashed ${T.border}`, borderRadius: 8, padding: "12px 14px", textAlign: "center",
                    cursor: "pointer", background: T.bg, marginTop: 6 }}>
                  {uploading.length === 0 ? (
                    <>
                      <Ic name="upload" size={18} color={T.textMuted} />
                      <div style={{ fontSize: 11, color: T.textMid, fontFamily: T.font, marginTop: 4 }}>
                        Drop files or <span style={{ color: T.accent, textDecoration: "underline" }}>browse</span> — auto-links to {editing.reqNumber}
                      </div>
                      <input id={`req-upload-${editing.id}`} type="file" multiple style={{ display: "none" }}
                        onChange={e => { processReqFiles(e.target.files); e.target.value = ""; }} />
                    </>
                  ) : (
                    <div style={{ textAlign: "left" }}>
                      {uploading.map((u, i) => (
                        <div key={i} style={{ display: "flex", alignItems: "center", gap: 8, padding: "3px 0" }}>
                          <span style={{ fontSize: 11, fontFamily: T.font, color: T.textMid, flex: 1,
                            overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{u.name}</span>
                          <div style={{ width: 60, height: 3, borderRadius: 2, background: T.border, flexShrink: 0 }}>
                            <div style={{ width: u.progress + "%", height: "100%", borderRadius: 2,
                              background: u.status === "error" ? T.red : u.status === "done" ? T.green : T.accent }} />
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                {uploadSummary && (
                  <div style={{ fontSize: 11, color: T.green, fontFamily: T.font, marginTop: 6, textAlign: "center" }}>
                    {uploadSummary.total} file(s) uploaded and linked to {editing.reqNumber}
                  </div>
                )}
              </div>

              {/* ── BACKUP VARIANCE ── */}
              {backupData && (
                <div style={{ marginTop: 16, paddingTop: 14, borderTop: `1px solid ${T.border}` }}>
                  <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 8, fontFamily: T.font }}>
                    BACKUP VARIANCE
                  </label>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 6, marginBottom: 10 }}>
                    {[{ label: "BILLED", val: backupData.amountBilled, color: T.text },
                      { label: "BACKUP", val: backupData.backupDocs, color: T.green },
                      { label: "DIRECT LABOR", val: backupData.directLabor, color: backupData.directLabor > 0 ? T.amber : T.textMuted }
                    ].map(c => (
                      <div key={c.label} style={{ padding: "8px 8px", borderRadius: 6, background: T.bg, border: `1px solid ${T.border}` }}>
                        <div style={{ fontSize: 9, color: T.textMuted, fontFamily: T.font, letterSpacing: 0.3 }}>{c.label}</div>
                        <div style={{ fontSize: 12, fontWeight: 600, fontFamily: T.mono, color: c.color }}>
                          ${c.val.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                        </div>
                      </div>
                    ))}
                  </div>
                  {(() => {
                    const gap = backupData.amountBilled - backupData.backupDocs - backupData.directLabor;
                    return Math.abs(gap) > 1 ? (
                      <div style={{ padding: "6px 10px", borderRadius: 6, marginBottom: 10,
                        background: gap > 0 ? T.redBg : T.greenBg, border: `1px solid ${gap > 0 ? T.redBorder : T.greenBorder}`,
                        fontSize: 11, fontFamily: T.font, color: gap > 0 ? T.red : T.green }}>
                        {gap > 0 ? "Unsubstantiated gap" : "Over-documented by"}: ${Math.abs(gap).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                      </div>
                    ) : (
                      <div style={{ padding: "6px 10px", borderRadius: 6, marginBottom: 10,
                        background: T.greenBg, border: `1px solid ${T.greenBorder}`,
                        fontSize: 11, fontFamily: T.font, color: T.green }}>
                        Fully substantiated
                      </div>
                    );
                  })()}
                  {backupData.items.length > 0 && (
                    <div>
                      <div style={{ fontSize: 10, fontWeight: 600, color: T.textMuted, fontFamily: T.font, letterSpacing: 0.3, marginBottom: 6 }}>
                        LINE ITEMS ({backupData.items.length})
                      </div>
                      {backupData.items.map((item, idx) => (
                        <div key={idx} style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start",
                          padding: "6px 8px", borderRadius: 4, background: idx % 2 === 0 ? T.bg : "transparent", fontSize: 11, fontFamily: T.font }}>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <div style={{ fontWeight: 500, color: T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{item.desc}</div>
                            <div style={{ fontSize: 9, color: T.textMuted }}>{item.trade}</div>
                          </div>
                          <div style={{ fontFamily: T.mono, fontSize: 11, color: item.amount < 0 ? T.red : T.amber,
                            fontWeight: 500, flexShrink: 0, marginLeft: 8 }}>
                            {item.amount < 0 ? "-" : ""}${Math.abs(item.amount).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          </Card>
        </div>
      )}
    </div>
  );
}

// ── AUDIT RISK ────────────────────────────────────────────────────────────────
function AuditRisk({ reqs }) {
  const freq = {};
  AUDIT_FLAGS.forEach(f => { freq[f.id] = 0; });
  reqs.forEach(r => r.flags.forEach(f => { if (freq[f] !== undefined) freq[f]++; }));
  const flagged = reqs.filter(r => r.flags.length > 0);

  return (
    <div>
      <SectionTitle title="Audit Risk Analysis" subtitle={`${flagged.length} of 16 requisitions flagged — mitigate before arbitration`} />
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 16 }}>
        <Card>
          <CardLabel label="Flag Frequency Across All Requisitions" />
          {AUDIT_FLAGS.filter(f => freq[f.id] > 0).length === 0 && (
            <p style={{ fontSize: 13, color: T.textMuted, fontFamily: T.font, margin: 0 }}>No flags set. Go to Requisitions to flag risks per req.</p>
          )}
          {AUDIT_FLAGS.filter(f => freq[f.id] > 0).sort((a, b) => freq[b.id] - freq[a.id]).map(flag => {
            const col = flag.risk === "HIGH" ? T.red : flag.risk === "MEDIUM" ? T.amber : T.blue;
            return (
              <div key={flag.id} style={{ marginBottom: 12 }}>
                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 5 }}>
                  <span style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, maxWidth: "80%", lineHeight: 1.3 }}>{flag.label}</span>
                  <span style={{ fontFamily: T.mono, fontSize: 12, color: col }}>{freq[flag.id]}</span>
                </div>
                <div style={{ height: 10, background: T.border, borderRadius: 5 }}>
                  <div style={{ height: 10, borderRadius: 5, background: col, width: `${(freq[flag.id] / 16) * 100}%` }} />
                </div>
              </div>
            );
          })}
        </Card>

        <Card>
          <CardLabel label="Flagged Requisitions" />
          {flagged.length === 0 && <p style={{ fontSize: 13, color: T.textMuted, fontFamily: T.font, margin: 0 }}>No requisitions flagged yet.</p>}
          {flagged.map(req => {
            const risk = computeRisk(req);
            const rs = riskStyle(risk);
            return (
              <div key={req.id} style={{ display: "flex", gap: 12, padding: "10px 0", borderBottom: `1px solid ${T.border}` }}>
                <div>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                    <span style={{ fontFamily: T.mono, fontSize: 12, fontWeight: 500, color: T.accent }}>{req.reqNumber}</span>
                    <Badge label={risk} style={rs} />
                    {req.totalBilled > 0 && <Money amount={req.totalBilled} color={T.textMuted} size="xs" />}
                  </div>
                  <div style={{ fontSize: 11, color: T.textMuted, fontFamily: T.font, lineHeight: 1.4 }}>
                    {req.flags.map(fid => AUDIT_FLAGS.find(a => a.id === fid)?.label).filter(Boolean).join(" · ")}
                  </div>
                </div>
              </div>
            );
          })}
        </Card>
      </div>

      <Card>
        <CardLabel label="Mitigation Playbook" />
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12 }}>
          {[
            { risk: "Blended Labor Rate", severity: "HIGH", action: "Pull W-2s, payroll registers, and workers' comp audit for all billed employees. Calculate true burdened rate: wage + FICA + WC + benefits. Document that $60/hr equals actual burdened cost. If gap exists, calculate delta and consider proactive credit." },
            { risk: "DSL Landscaping as Direct Labor", severity: "HIGH", action: "Either reclassify as subcontractor with proper invoice (scope, rates, dates, location), or obtain DSL payroll records proving $60/hr is their actual burdened rate. Landscaping at skilled trade rates unexplained is a clean target for opposing counsel." },
            { risk: "Overhead Billed as Materials", severity: "HIGH", action: "Identify every overhead line: masks, flashlights, tarps, spray paint, markers, rock salt, deicer. Total the amount. Per §9.3.1 these are contractor's responsibility. Proactively credit — better to offer than have an arbitrator award it with interest." },
            { risk: "Deficient Subcontractor Invoices", severity: "HIGH", action: "Contact H&J Improvements and DeLeonardis Electric immediately. Get revised invoices including: project address, dates of work, scope description, hourly vs lump sum basis, number of workers, total contract value, payment history. Required under §15.3.2." },
            { risk: "Markup Transparency", severity: "HIGH", action: "Review each req for 25% applied to already-marked-up sub invoices. Cost-plus markup applies to actual cost only — not to marked-up subcontractor pricing. Document the markup methodology clearly and consistently across all 16 reqs." },
            { risk: "Missing Timesheets", severity: "MEDIUM", action: "Reconstruct using daily superintendent logs, field photos with timestamps, delivery tickets, and sub pay stubs. Contemporaneous text messages between PMs can establish crew presence. Even partial documentation reduces arbitrator skepticism significantly." },
          ].map(item => (
            <div key={item.risk} style={{ padding: 14, background: item.severity === "HIGH" ? T.redBg : T.amberBg, border: `1px solid ${item.severity === "HIGH" ? T.redBorder : T.amberBorder}`, borderRadius: 8 }}>
              <div style={{ fontSize: 11, fontWeight: 600, color: item.severity === "HIGH" ? T.red : T.amber, letterSpacing: 0.3, marginBottom: 6, fontFamily: T.font }}>
                {item.risk}
              </div>
              <div style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, lineHeight: 1.6 }}>{item.action}</div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
}

// ── CLAIMS ────────────────────────────────────────────────────────────────────
function Claims({ claims, updateClaim }) {
  const [sel, setSel] = useState(null);
  const editing = sel ? claims.find(c => c.id === sel) : null;
  const totalOwner = claims.reduce((s, c) => s + c.ownerAmount, 0);
  const totalAgreed = claims.reduce((s, c) => s + c.agreedAmount, 0);
  const ThStyle = { padding: "10px 14px", textAlign: "left", fontSize: 11, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, fontFamily: T.font, borderBottom: `1px solid ${T.border}`, background: T.bg };
  const TdStyle = { padding: "10px 14px", fontSize: 13, fontFamily: T.font, color: T.text, borderBottom: `1px solid ${T.border}` };

  return (
    <div style={{ display: "grid", gridTemplateColumns: editing ? "1fr 380px" : "1fr", gap: 20, alignItems: "start" }}>
      <div>
        <SectionTitle title="Owner Claims" subtitle={`${claims.length} claims · Gross: ${$(totalOwner)} · MC Agreed: ${$(totalAgreed)}`} />
        <Card padding={0}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr>
                {["#", "Description", "Owner Amt", "MC Agreed", "Status", "Defense"].map(h => (
                  <th key={h} style={ThStyle}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {claims.map(claim => {
                const ss = statusStyle(claim.status);
                const sg = strengthStyle(claim.strength);
                const active = sel === claim.id;
                return (
                  <tr key={claim.id} onClick={() => setSel(active ? null : claim.id)}
                    style={{ cursor: "pointer", background: active ? T.accentBg : "transparent", transition: "background 0.1s" }}
                    onMouseEnter={e => { if (!active) e.currentTarget.style.background = T.surfaceHover; }}
                    onMouseLeave={e => { if (!active) e.currentTarget.style.background = "transparent"; }}>
                    <td style={{ ...TdStyle, color: T.textMuted, fontFamily: T.mono, fontSize: 12 }}>{claim.id}</td>
                    <td style={{ ...TdStyle, maxWidth: 280, fontSize: 12 }}>{claim.description}</td>
                    <td style={TdStyle}><Money amount={claim.ownerAmount} color={T.red} size="sm" /></td>
                    <td style={TdStyle}>
                      {claim.agreedAmount > 0 ? <Money amount={claim.agreedAmount} color={T.amber} size="sm" /> : <span style={{ color: T.textMuted, fontFamily: T.font, fontSize: 13 }}>—</span>}
                    </td>
                    <td style={TdStyle}><Badge label={claim.status} style={ss} /></td>
                    <td style={TdStyle}><Badge label={claim.strength} style={{ color: sg.color, bg: sg.bg, border: sg.bg }} /></td>
                  </tr>
                );
              })}
            </tbody>
            <tfoot>
              <tr style={{ background: T.bg }}>
                <td colSpan={2} style={{ ...TdStyle, fontSize: 11, fontWeight: 600, color: T.textMuted, borderBottom: "none" }}>TOTALS</td>
                <td style={{ ...TdStyle, borderBottom: "none" }}><Money amount={totalOwner} color={T.red} size="sm" /></td>
                <td style={{ ...TdStyle, borderBottom: "none" }}><Money amount={totalAgreed} color={T.amber} size="sm" /></td>
                <td colSpan={2} style={{ borderBottom: "none" }} />
              </tr>
            </tfoot>
          </table>
        </Card>
      </div>

      {editing && (
        <div style={{ position: "sticky", top: 16 }}>
          <Card>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14, paddingBottom: 14, borderBottom: `1px solid ${T.border}` }}>
              <span style={{ fontSize: 13, fontWeight: 600, color: T.text, fontFamily: T.font }}>Claim #{editing.id}</span>
              <button onClick={() => setSel(null)} style={{ background: "none", border: "none", color: T.textMuted, cursor: "pointer", fontSize: 20 }}>×</button>
            </div>
            <div style={{ fontSize: 12, color: T.textMid, lineHeight: 1.6, marginBottom: 14, padding: 10, background: T.bg, borderRadius: 6, fontFamily: T.font }}>
              {editing.description}
            </div>
            <TextInput label="Owner Amount ($)" value={editing.ownerAmount} onChange={v => updateClaim(editing.id, { ownerAmount: v })} type="number" />
            <TextInput label="MC Agreed Amount ($)" value={editing.agreedAmount} onChange={v => updateClaim(editing.id, { agreedAmount: v })} type="number" />

            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 6, fontFamily: T.font }}>STATUS</label>
              <SegmentControl options={["DISPUTED", "AGREED", "WAIVED", "PENDING"]} value={editing.status} onChange={v => updateClaim(editing.id, { status: v })} colorFn={s => statusStyle(s)} />
            </div>

            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 6, fontFamily: T.font }}>DEFENSE STRENGTH</label>
              <SegmentControl options={["STRONG", "MODERATE", "WEAK", "N/A"]} value={editing.strength} onChange={v => updateClaim(editing.id, { strength: v })}
                colorFn={s => { const sg = strengthStyle(s); return { color: sg.color, bg: sg.bg, border: sg.bg }; }} />
            </div>

            <div>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>DEFENSE NOTES</label>
              <textarea value={editing.defense} onChange={e => updateClaim(editing.id, { defense: e.target.value })}
                rows={5} style={{ width: "100%", background: T.bg, border: `1px solid ${T.border}`, borderRadius: 6, padding: "8px 10px", color: T.text, fontSize: 12, outline: "none", resize: "vertical", boxSizing: "border-box", fontFamily: T.font, lineHeight: 1.6 }} />
            </div>
          </Card>
        </div>
      )}
    </div>
  );
}

// ── STRATEGY ──────────────────────────────────────────────────────────────────
function Strategy({ claims }) {
  const totalAgreed = claims.reduce((s, c) => s + c.agreedAmount, 0);
  const waivedClaims = claims.filter(c => c.status === "WAIVED").reduce((s, c) => s + c.ownerAmount, 0);
  const strongDisputed = claims.filter(c => c.status === "DISPUTED" && c.strength === "STRONG");

  return (
    <div>
      <SectionTitle title="Arbitration Strategy" subtitle="Pre-mediation positioning · AIA A110-2021 · AAA Construction Industry Rules · Elizabeth Parks as Initial Decision Maker" />
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 16 }}>
        <Card>
          <CardLabel label="Montana's Strongest Defenses" />
          {[
            { title: "§21.11 Consequential Damages Waiver", detail: `Bars $26,600 delay/rental income claim and 10-yr energy cost estimates. Mutual waiver — applies equally to both parties. Clean statutory bar. Value: ${$(waivedClaims)}.` },
            { title: "125 Change Orders → Delay Causation", detail: "Owner cannot simultaneously demand 125+ changes and claim delay damages. Every day beyond 240 has a CO-driven cause. Need signed CO log with dates." },
            { title: "Owner Refused Mechanical Engineer", detail: "HVAC design-build was owner's choice. Without MEP drawings, Montana cannot be held to an unspecified design standard. Document all written requests." },
            { title: "Architect Plan Failure (R-38 vs R-49)", detail: "Montana built to the plans it received. Architect never distributed revised R-49 drawings. Owner declined upgrade twice in writing." },
            { title: "Manufacturer Approval — Fireplace", detail: "Stone supplier's rep reviewed photos and approved workmanship. Owner selected stone type, shape, color. Durock used per spec. Corrective work offered and refused." },
            { title: "Shower Glass Governed by Plan A-402", detail: "Three panes shown on contract drawing A-402. One-piece would require unspecified wall demolition and crane rigging not in any contract document." },
          ].map((item, i) => (
            <div key={i} style={{ padding: "11px 0", borderBottom: `1px solid ${T.border}` }}>
              <div style={{ display: "flex", alignItems: "flex-start", gap: 8, marginBottom: 4 }}>
                <span style={{ color: T.green, fontSize: 13, flexShrink: 0, marginTop: 1 }}>✓</span>
                <span style={{ fontSize: 13, fontWeight: 500, color: T.text, fontFamily: T.font }}>{item.title}</span>
              </div>
              <div style={{ fontSize: 12, color: T.textMuted, fontFamily: T.font, lineHeight: 1.55, paddingLeft: 21 }}>{item.detail}</div>
            </div>
          ))}
        </Card>

        <Card>
          <CardLabel label="Owner's Weakest Claims" />
          {strongDisputed.concat(claims.filter(c => c.status === "WAIVED")).map(c => (
            <div key={c.id} style={{ padding: "10px 0", borderBottom: `1px solid ${T.border}` }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 5 }}>
                <span style={{ fontSize: 12, color: T.text, fontFamily: T.font, maxWidth: "72%", lineHeight: 1.4 }}>{c.description}</span>
                <Money amount={c.ownerAmount} color={T.red} size="sm" />
              </div>
              <div style={{ display: "flex", gap: 6, marginBottom: 5 }}>
                <Badge label={c.status} style={statusStyle(c.status)} />
                <Badge label={c.strength} style={{ color: strengthStyle(c.strength).color, bg: strengthStyle(c.strength).bg, border: strengthStyle(c.strength).bg }} />
              </div>
              <div style={{ fontSize: 11, color: T.textMuted, fontFamily: T.font, lineHeight: 1.4 }}>{c.defense}</div>
            </div>
          ))}
        </Card>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        <Card>
          <CardLabel label="Pre-Arbitration Checklist" />
          {[
            "Pull W-2s and payroll registers for all employees across all 16 requisition periods",
            "Reconcile DSL Landscaping — reclassify as subcontractor or document actual rates",
            "Identify all overhead items billed as materials — total, then proactively credit",
            "Get compliant revised invoice from H&J Improvements Corp. (Invoice #1316)",
            "Get full subcontract scope from DeLeonardis Electric — job tickets 2544 and 2681",
            "Compile all 125 change orders with signed documents, scope, and pricing",
            "Document all owner refusals to hire mechanical engineer (email/letter trail)",
            "Secure record of two instances owner declined R-49 insulation upgrade",
            "Get stone manufacturer rep's written approval of fireplace photos",
            "Compile weekly meeting minutes confirming HVAC soffit locations",
            "Document all subcontractor payment records to rebut non-payment narrative",
            "Assess LAN Associates plumbing audit — confirm no additional claims from 2\" main finding",
          ].map((item, i) => (
            <label key={i} style={{ display: "flex", gap: 10, padding: "9px 0", borderBottom: `1px solid ${T.border}`, alignItems: "flex-start", cursor: "pointer" }}>
              <input type="checkbox" style={{ accentColor: T.accent, marginTop: 2, flexShrink: 0, width: 14, height: 14 }} />
              <span style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, lineHeight: 1.5 }}>{item}</span>
            </label>
          ))}
        </Card>

        <Card>
          <CardLabel label="Key Contract Sections — Quick Reference" />
          {[
            ["§15.3.2", "Cost-plus documentation required: payrolls, petty cash, receipted invoices, check vouchers"],
            ["§9.3.1", "Contractor pays for tools, equipment, facilities — NOT billable to owner as materials"],
            ["§9.3.3", "Substitutions require owner consent + architect evaluation + formal contract modification"],
            ["§8.3", "Owner's right to carry out work after 10-day notice of contractor default"],
            ["§8.4", "Non-disparagement — mutual. Bars telling subs 'owners don't pay bills'"],
            ["§9.4", "Contractor warranty — work free from defects, conforming to contract documents"],
            ["§21.11", "Mutual waiver of consequential damages — BARS delay and rental income claims"],
            ["§20.2", "Owner termination for cause — requires architect certification of sufficient cause"],
            ["§15.4.3", "Architect may withhold certificate for defective work not remedied"],
            ["§11.2", "Contractor must notify owner and architect of all subcontractors — audit compliance"],
            ["§15.5.1", "Pay subs within 7 days of receiving owner payment — audit all 16 reqs"],
            ["§2.3.1", "Substantial completion: 240 calendar days — exceeded by 419 days (125 COs)"],
          ].map(([sec, desc]) => (
            <div key={sec} style={{ display: "flex", gap: 14, padding: "9px 0", borderBottom: `1px solid ${T.border}` }}>
              <span style={{ fontFamily: T.mono, fontSize: 12, fontWeight: 500, color: T.accent, minWidth: 56, flexShrink: 0 }}>{sec}</span>
              <span style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, lineHeight: 1.5 }}>{desc}</span>
            </div>
          ))}
        </Card>
      </div>
    </div>
  );
}

// ── RECONCILIATION ────────────────────────────────────────────────────────────
function Reconciliation({ reqs }) {
  const [expanded, setExpanded] = useState(null);

  const excelGrand = EXCEL_DATA.reduce((s, r) => s + r[0], 0);
  const pdfGrand = reqs.slice(0, 15).reduce((s, r) => s + (r.totalBilled || 0), 0);
  const totalVariance = pdfGrand - excelGrand;

  const ThStyle = { padding: "10px 14px", textAlign: "left", fontSize: 11, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, fontFamily: T.font, borderBottom: `1px solid ${T.border}`, background: T.bg, whiteSpace: "nowrap" };
  const TdStyle = { padding: "10px 14px", fontSize: 13, fontFamily: T.font, color: T.text, borderBottom: `1px solid ${T.border}` };

  const varColor = (v) => v === 0 ? T.green : Math.abs(v) < 500 ? T.amber : T.red;

  return (
    <div>
      <SectionTitle
        title="Excel vs PDF Reconciliation"
        subtitle="CM Tracker (Excel) compared to AIA G702 certified amounts (PDF) · Variance = PDF − Excel"
      />

      {/* Summary KPIs */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 20 }}>
        <KPI label="Excel CM Tracker Total" isMoney rawAmount={excelGrand} sub="15 reqs · Book1.xlsx" color={T.blue} />
        <KPI label="PDF Certified Total" isMoney rawAmount={pdfGrand} sub="G702 amounts entered" color={pdfGrand > 0 ? T.text : T.textMuted} />
        <KPI label="Total Variance" isMoney rawAmount={Math.abs(totalVariance)} sub={totalVariance > 0 ? "PDF > Excel (over-billed?)" : totalVariance < 0 ? "Excel > PDF (under-certified?)" : "Balanced"} color={varColor(totalVariance)} />
        <KPI label="REQ-13R1 Credit" isMoney rawAmount={90489.90} sub="Large negative — needs scrutiny" color={T.red} />
      </div>

      {/* REQ-13 Warning */}
      <div style={{ background: T.redBg, border: `1px solid ${T.redBorder}`, borderRadius: 10, padding: 16, marginBottom: 20, display: "flex", gap: 14 }}>
        <span style={{ fontSize: 20, flexShrink: 0 }}>⚠</span>
        <div>
          <div style={{ fontSize: 13, fontWeight: 600, color: T.red, marginBottom: 4, fontFamily: T.font }}>REQ-13R1 — Negative Requisition Requires Explanation</div>
          <div style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, lineHeight: 1.6 }}>
            REQ-13R1 shows <strong>-$90,489.90</strong> in the Excel tracker — the largest single-req swing in the project. This is a reconciliation or credit req covering 19 trade reversals including Electric -$41,824, Tile -$12,100, HVAC -$8,545, Wood Flooring -$7,325, Drywall -$7,992, and Masonry -$9,903. Each reversal needs a corresponding AIA G702 credit memo and documented justification. This will be a primary focus for opposing counsel.
          </div>
        </div>
      </div>

      {/* Main reconciliation table */}
      <Card padding={0} style={{ marginBottom: 20 }}>
        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <thead>
            <tr>
              <th style={ThStyle}>REQ</th>
              <th style={ThStyle}>PERIOD</th>
              <th style={{ ...ThStyle, textAlign: "right", color: T.blue }}>EXCEL SUBTOTAL</th>
              <th style={{ ...ThStyle, textAlign: "right", color: T.blue }}>EXCEL FEE (25%)</th>
              <th style={{ ...ThStyle, textAlign: "right", color: T.blue }}>EXCEL TOTAL</th>
              <th style={{ ...ThStyle, textAlign: "right" }}>PDF CERTIFIED</th>
              <th style={{ ...ThStyle, textAlign: "right" }}>VARIANCE</th>
              <th style={{ ...ThStyle, textAlign: "center" }}>STATUS</th>
              <th style={{ ...ThStyle, textAlign: "center" }}>TRADES</th>
            </tr>
          </thead>
          <tbody>
            {reqs.slice(0, 15).map((req, i) => {
              const [excelTotal, excelSub, excelFee, month, pdfReqNum] = EXCEL_DATA[i];
              const pdf = req.totalBilled || 0;
              const variance = pdf - excelTotal;
              const vc = varColor(variance);
              const isNeg = excelTotal < 0;
              const isExpanded = expanded === i;
              const trades = EXCEL_TRADES[i + 1] || {};
              const tradeCount = Object.keys(trades).length;
              const pdfEntered = pdf > 0;

              return (
                <>
                  <tr key={i}
                    style={{ background: isExpanded ? T.accentBg : "transparent", cursor: tradeCount > 0 ? "pointer" : "default" }}
                    onClick={() => tradeCount > 0 && setExpanded(isExpanded ? null : i)}
                    onMouseEnter={e => { if (!isExpanded) e.currentTarget.style.background = T.surfaceHover; }}
                    onMouseLeave={e => { if (!isExpanded) e.currentTarget.style.background = "transparent"; }}>
                    <td style={{ ...TdStyle, fontFamily: T.mono, fontWeight: 500, color: isNeg ? T.red : T.accent }}>
                      {req.reqNumber}
                      {isNeg && <span style={{ fontSize: 10, color: T.red, marginLeft: 6, fontWeight: 700 }}>CREDIT</span>}
                    </td>
                    <td style={{ ...TdStyle, color: T.textMuted, fontSize: 12 }}>{month}</td>
                    <td style={{ ...TdStyle, textAlign: "right" }}>
                      <Money amount={Math.abs(excelSub)} color={isNeg ? T.red : T.textMid} size="sm" neg={isNeg} />
                    </td>
                    <td style={{ ...TdStyle, textAlign: "right" }}>
                      <Money amount={Math.abs(excelFee)} color={isNeg ? T.red : T.textMuted} size="sm" neg={isNeg} />
                    </td>
                    <td style={{ ...TdStyle, textAlign: "right" }}>
                      <Money amount={Math.abs(excelTotal)} color={isNeg ? T.red : T.blue} size="sm" neg={isNeg} />
                    </td>
                    <td style={{ ...TdStyle, textAlign: "right" }}>
                      {pdfEntered
                        ? <Money amount={pdf} color={T.text} size="sm" />
                        : <span style={{ fontSize: 12, color: T.textMuted, fontFamily: T.font, fontStyle: "italic" }}>not entered</span>}
                    </td>
                    <td style={{ ...TdStyle, textAlign: "right" }}>
                      {pdfEntered
                        ? <Money amount={Math.abs(variance)} color={vc} size="sm" neg={variance < 0} />
                        : <span style={{ color: T.textMuted, fontSize: 12 }}>—</span>}
                    </td>
                    <td style={{ ...TdStyle, textAlign: "center" }}>
                      {pdfEntered
                        ? <Badge label={variance === 0 ? "MATCH" : variance > 0 ? "PDF HIGH" : "EXCEL HIGH"}
                            style={variance === 0
                              ? { color: T.green, bg: T.greenBg, border: T.greenBorder }
                              : { color: vc, bg: vc === T.red ? T.redBg : T.amberBg, border: vc === T.red ? T.redBorder : T.amberBorder }} />
                        : <Badge label="PENDING" style={{ color: T.textMuted, bg: T.surfaceHover, border: T.border }} />}
                    </td>
                    <td style={{ ...TdStyle, textAlign: "center" }}>
                      {tradeCount > 0 && (
                        <span style={{ fontSize: 11, color: T.accent, fontFamily: T.font, cursor: "pointer" }}>
                          {tradeCount} {isExpanded ? "▲" : "▼"}
                        </span>
                      )}
                    </td>
                  </tr>
                  {isExpanded && (
                    <tr key={`${i}-detail`}>
                      <td colSpan={9} style={{ padding: 0, borderBottom: `1px solid ${T.border}` }}>
                        <div style={{ background: T.bg, padding: "14px 24px 14px 60px" }}>
                          <div style={{ fontSize: 11, fontWeight: 600, letterSpacing: 0.6, color: T.textMuted, marginBottom: 10, fontFamily: T.font }}>EXCEL TRADE LINE ITEMS — {req.reqNumber}</div>
                          <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: "4px 24px" }}>
                            {Object.entries(trades).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1])).map(([trade, val]) => (
                              <div key={trade} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "5px 0", borderBottom: `1px solid ${T.border}` }}>
                                <span style={{ fontSize: 12, color: val < 0 ? T.red : T.textMid, fontFamily: T.font }}>{trade}</span>
                                <Money amount={Math.abs(val)} color={val < 0 ? T.red : T.text} size="xs" neg={val < 0} />
                              </div>
                            ))}
                          </div>
                          {req.notes && (
                            <div style={{ marginTop: 12, padding: "10px 12px", background: T.amberBg, border: `1px solid ${T.amberBorder}`, borderRadius: 6 }}>
                              <div style={{ fontSize: 11, fontWeight: 600, color: T.amber, marginBottom: 4, fontFamily: T.font }}>AUDIT NOTES</div>
                              <div style={{ fontSize: 11, color: T.textMid, fontFamily: T.font, lineHeight: 1.6, whiteSpace: "pre-line" }}>{req.notes.substring(0, 400)}{req.notes.length > 400 ? "…" : ""}</div>
                            </div>
                          )}
                        </div>
                      </td>
                    </tr>
                  )}
                </>
              );
            })}
          </tbody>
          <tfoot>
            <tr style={{ background: T.bg }}>
              <td colSpan={2} style={{ ...TdStyle, fontSize: 11, fontWeight: 600, color: T.textMuted, borderBottom: "none", letterSpacing: 0.5 }}>GRAND TOTALS</td>
              <td style={{ ...TdStyle, textAlign: "right", borderBottom: "none" }}>
                <Money amount={Math.abs(EXCEL_DATA.reduce((s,r)=>s+r[1],0))} color={T.blue} size="sm" />
              </td>
              <td style={{ ...TdStyle, textAlign: "right", borderBottom: "none" }}>
                <Money amount={Math.abs(EXCEL_DATA.reduce((s,r)=>s+r[2],0))} color={T.textMuted} size="sm" />
              </td>
              <td style={{ ...TdStyle, textAlign: "right", borderBottom: "none" }}>
                <Money amount={Math.abs(excelGrand)} color={T.blue} size="sm" />
              </td>
              <td style={{ ...TdStyle, textAlign: "right", borderBottom: "none" }}>
                <Money amount={pdfGrand} color={T.text} size="sm" />
              </td>
              <td style={{ ...TdStyle, textAlign: "right", borderBottom: "none" }}>
                <Money amount={Math.abs(totalVariance)} color={varColor(totalVariance)} size="sm" neg={totalVariance < 0} />
              </td>
              <td colSpan={2} style={{ borderBottom: "none" }} />
            </tr>
          </tfoot>
        </table>
      </Card>

      {/* Variance explainer */}
      <Card>
        <CardLabel label="Known Variance Explanations" />
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12 }}>
          {[
            { req: "REQ-01", variance: "+$15,000.00", reason: "Kitchen Radiant CO (PCO#003) billed on AIA G702 at $15,000 but tracked as a separate change order line in Excel, not included in CM Tracker subtotal.", severity: "amber" },
            { req: "REQ-13R1", variance: "+$274,728.87", reason: "LARGEST variance: G703 TP $184,238.97 vs Excel -$90,489.90. REVISED requisition (R1) with base-to-CO conversion pattern — base credits ~$92K while massive new CO billing generates additional OH&P. A Touch of Glass estimate-as-invoice ($6,850) + allocation overbilling ($14,775 coded vs $6,650 invoice). Potential duplicate Dykes Lumber #2302-079368. Eastern Contractor invoice 6 months out-of-period. Korth painting at 182% of contract ($89,942 vs $49,450). No timecards for 3-month period.", severity: "red" },
            { req: "REQ-08", variance: "$0.00", reason: "PDF matches Excel exactly at $192,165.00. Largest single req — 13 active trades. Zero CO billing this period despite $252K scheduled. Four over-budget lines: Tile 135%, Framing Mat 165%, Framing Labor 119%, Roofing 113%.", severity: "green" },
            { req: "REQ-09", variance: "+$6,045.74", reason: "COs (PCO#049 Fireplace Demo $1,340.30 + PCO#052 Balcony Railings $3,496.29 + $1,209.15 unidentified) billed on G702 but not in Excel base total. Cooling $3,102.70 billed with $0 scheduled and no backup. H&J rate anomaly: $55/hr siding vs $75/hr framing.", severity: "amber" },
            { req: "REQ-10", variance: "+$52,342.29", reason: "MASSIVE CO component: G703 Grand Total $90,418.49 vs Excel $38,076.20. Same billing period as REQ-09 (both 10/01-10/30/22). Net COs jumped $82K. Anonymous $2,925 roofing sub, $15K firebox kit, Valley Mechanical HVAC $13,935. Framing Labor $675 with no backup.", severity: "red" },
            { req: "REQ-11", variance: "+$40,957.56", reason: "CO billing $32,766.05 plus hidden $8,191.51 CO OH&P (exactly 25% of CO total). First REQ with timecards — but supervision/general conditions coded as billable (overhead per §9.3.1). Korth painting $49,450 split base/CO. Multiple materials miscoded to Painting CO. Carpentry $9,825 with no labor/material breakdown.", severity: "red" },
            { req: "REQ-12", variance: "+$22,537.26", reason: "CO billing $18,029.81 plus hidden $4,507.46 CO OH&P (25% pattern — third consecutive REQ). Boards & Beams LLC submitted ESTIMATES as backup (not invoices — §15.3.2). Beckerle receipt dated 1/4/2023 in December billing. CO number discrepancies between backup and G703. Korth painting cumulative $63,742 exceeds $49,450 contract.", severity: "red" },
            { req: "REQ-14", variance: "+$116,226.72", reason: "G703 TP $256,313.93 vs Excel $140,087.21. HVAC $72,615 (108.98% over budget) includes $17K disputed payment ('previously rejected due to disagreements with client'). Korth #9922 reconciliation invoice: painting sub billing carpentry ($26,252 subtotal, credits $60,605 of prior REQ-11/12/13 invoices). Glen Rock Stair #59548 potential duplicate (also in REQ-13). Glen Rock #58852 six months out-of-period. 7 of 9 new COs at 100% immediately. No timecards.", severity: "red" },
            { req: "REQ-15", variance: "$0.00", reason: "ZERO VARIANCE — ONLY requisition where G703 TP ($6,451.64) matches Excel exactly. After 7-month gap. However: $135,385 in UNAPPLIED credit COs at 0% — PCO#130 'GC Owner Variance Split' ($66,389), PCO#129 'Allowance Reconciliation' ($24,248), plus 5 other credits never applied to owner. CO total DECREASED $90,637 — unprecedented. Only 2 backup pages; both invoices out-of-period (ABC Supply 19 months, DeLeonardis 5 months). No timecards.", severity: "amber" },
            { req: "REQ-16", variance: "N/A", reason: "FINAL INVOICE — LARGEST REQUISITION ($235,461.28). Project OVER-BILLED by $53,162 (102.97% of contract sum). 10+ G703 lines over budget: Insulation 200%, Custom Casework 155%, Framing Material 165%, Siding 118%, Roofing 116%. $135,385 in unapplied credit COs STILL at 0%. 131 PCOs on schedule. New COs added ($56,983 net) but owner credits remain unapplied. No timecards. OH&P $27,487 applied to over-budget lines.", severity: "red" },
          ].map(item => (
            <div key={item.req} style={{ padding: 14, background: item.severity === "red" ? T.redBg : T.amberBg, border: `1px solid ${item.severity === "red" ? T.redBorder : T.amberBorder}`, borderRadius: 8 }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
                <span style={{ fontFamily: T.mono, fontSize: 12, fontWeight: 600, color: item.severity === "red" ? T.red : T.amber }}>{item.req}</span>
                <Money amount={parseFloat(item.variance.replace(/[^0-9.]/g,"")) || 0} color={item.severity === "red" ? T.red : T.amber} size="xs" neg={item.variance.startsWith("-")} />
              </div>
              <div style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, lineHeight: 1.6 }}>{item.reason}</div>
            </div>
          ))}
        </div>
      </Card>

      {/* ── BACKUP DOCUMENTATION VARIANCE ─────────────────────────────────── */}
      <BackupVariance reqs={reqs} />
    </div>
  );
}

function BackupVariance({ reqs }) {
  const [expRow, setExpRow] = useState(null);

  // Build rows from BACKUP_VARIANCE + EXCEL_DATA
  const rows = reqs.slice(0, 16).map((req, i) => {
    const bv = BACKUP_VARIANCE[i + 1] || {};
    const amountBilled = bv.amountBilled || 0;
    const invoicesOnFile = bv.backupDocs || 0;
    const rawVariance = invoicesOnFile - amountBilled;
    const selfPerformed = bv.directLabor || 0;
    const totalSupported = invoicesOnFile + selfPerformed;
    const netVariance = totalSupported - amountBilled;
    const items = bv.items || [];
    // Arbitration-friendly status
    let status = "pending";
    if (i + 1 === 16 && invoicesOnFile === 0) status = "unsupported";
    else if (Math.abs(netVariance) < 1) status = "supported";
    else if (netVariance > 0) status = "supported";
    else if (selfPerformed > 0 && netVariance < 0) status = "partial";
    else if (Math.abs(netVariance) < 200) status = "supported";
    else status = "needs_docs";
    return { req, i, amountBilled, invoicesOnFile, rawVariance, selfPerformed, totalSupported, netVariance, items, status };
  });

  const totalBilled = rows.reduce((s, r) => s + r.amountBilled, 0);
  const totalInvoices = rows.reduce((s, r) => s + r.invoicesOnFile, 0);
  const totalSelfPerformed = rows.reduce((s, r) => s + r.selfPerformed, 0);
  const totalSupported = totalInvoices + totalSelfPerformed;
  const totalNetVar = rows.reduce((s, r) => s + r.netVariance, 0);
  const supportedCount = rows.filter(r => r.status === "supported").length;
  const needsDocsCount = rows.filter(r => r.status === "needs_docs" || r.status === "unsupported").length;
  const pctSupported = totalBilled > 0 ? Math.round((totalSupported / totalBilled) * 100) : 0;

  const statusBadge = (st) => {
    const m = {
      supported:   { label: "FULLY SUPPORTED", color: T.green, bg: T.greenBg, border: T.greenBorder },
      partial:     { label: "PARTIALLY EXPLAINED", color: T.amber, bg: T.amberBg, border: T.amberBorder },
      needs_docs:  { label: "DOCUMENTATION NEEDED", color: T.red, bg: T.redBg, border: T.redBorder },
      unsupported: { label: "DOCUMENTATION NEEDED", color: T.red, bg: T.redBg, border: T.redBorder },
      pending:     { label: "PENDING", color: T.textMuted, bg: T.surfaceHover, border: T.border },
    }[st] || { label: st, color: T.textMuted, bg: T.surfaceHover, border: T.border };
    return <Badge label={m.label} style={{ color: m.color, bg: m.bg, border: m.border }} />;
  };

  // Sort: supported first, then partial, then needs docs
  const sortOrder = { supported: 0, partial: 1, needs_docs: 2, unsupported: 3, pending: 4 };
  const sorted = [...rows].sort((a, b) => (sortOrder[a.status] || 9) - (sortOrder[b.status] || 9));
  const groups = [
    { label: "Fully Supported", color: T.green, bg: T.greenBg, border: T.greenBorder, rows: sorted.filter(r => r.status === "supported") },
    { label: "Partially Explained", color: T.amber, bg: T.amberBg, border: T.amberBorder, rows: sorted.filter(r => r.status === "partial") },
    { label: "Documentation Needed", color: T.red, bg: T.redBg, border: T.redBorder, rows: sorted.filter(r => r.status === "needs_docs" || r.status === "unsupported") },
  ].filter(g => g.rows.length > 0);

  const Th = { padding: "10px 14px", textAlign: "left", fontSize: 11, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, fontFamily: T.font, borderBottom: `1px solid ${T.border}`, background: T.bg, whiteSpace: "nowrap" };
  const Td = { padding: "10px 14px", fontSize: 13, fontFamily: T.font, color: T.text, borderBottom: `1px solid ${T.border}` };

  const renderRow = (row) => {
    const isExp = expRow === row.i;
    const hasItems = row.items.length > 0;
    const nvColor = Math.abs(row.netVariance) < 1 ? T.green : row.netVariance > 0 ? T.green : Math.abs(row.netVariance) < 200 ? T.amber : T.red;
    return (
      <React.Fragment key={row.i}>
        <tr
          style={{ background: isExp ? T.accentBg : "transparent", cursor: hasItems ? "pointer" : "default", transition: T.fast }}
          onClick={() => hasItems && setExpRow(isExp ? null : row.i)}
          onMouseEnter={e => { if (!isExp) e.currentTarget.style.background = T.surfaceHover; }}
          onMouseLeave={e => { if (!isExp) e.currentTarget.style.background = "transparent"; }}>
          <td style={{ ...Td, fontFamily: T.mono, fontWeight: 500, color: T.accent }}>
            {row.req.reqNumber}
            {hasItems && <span style={{ fontSize: 10, color: T.accent, marginLeft: 6 }}>{isExp ? "▲" : "▼"}</span>}
          </td>
          <td style={{ ...Td, textAlign: "right" }}><Money amount={row.amountBilled} color={T.textMid} size="sm" /></td>
          <td style={{ ...Td, textAlign: "right" }}>
            {row.invoicesOnFile > 0 ? <Money amount={row.invoicesOnFile} color={T.text} size="sm" /> : <span style={{ color: T.textMuted, fontSize: 12 }}>None</span>}
          </td>
          <td style={{ ...Td, textAlign: "right" }}>
            {row.selfPerformed > 0 ? <Money amount={row.selfPerformed} color={T.amber} size="sm" /> : <span style={{ color: T.textMuted, fontSize: 12 }}>—</span>}
          </td>
          <td style={{ ...Td, textAlign: "right" }}><Money amount={row.totalSupported} color={T.text} size="sm" /></td>
          <td style={{ ...Td, textAlign: "right" }}>
            <Money amount={Math.abs(row.netVariance)} color={nvColor} size="sm" neg={row.netVariance < 0} />
          </td>
          <td style={{ ...Td, textAlign: "center" }}>{statusBadge(row.status)}</td>
        </tr>
        {isExp && (
          <tr>
            <td colSpan={7} style={{ padding: 0, borderBottom: `1px solid ${T.border}` }}>
              <div style={{ background: T.bg, padding: "14px 24px 14px 60px" }}>
                <div style={{ fontSize: 11, fontWeight: 600, letterSpacing: 0.6, color: T.textMuted, marginBottom: 10, fontFamily: T.font }}>
                  SELF-PERFORMED WORK — {row.req.reqNumber}
                </div>
                {row.items.map((item, j) => (
                  <div key={j} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "7px 0", borderBottom: `1px solid ${T.border}` }}>
                    <div>
                      <span style={{ fontSize: 12, fontWeight: 500, color: T.text, fontFamily: T.font }}>{item.desc}</span>
                      <span style={{ fontSize: 11, color: T.textMuted, fontFamily: T.font, marginLeft: 10 }}>{item.trade} · {item.vendor}</span>
                    </div>
                    <Money amount={item.amount} color={T.amber} size="sm" />
                  </div>
                ))}
                <div style={{ display: "flex", justifyContent: "space-between", paddingTop: 8, marginTop: 4 }}>
                  <span style={{ fontSize: 12, fontWeight: 600, color: T.textMid, fontFamily: T.font }}>Total Self-Performed Work</span>
                  <Money amount={row.selfPerformed} color={T.amber} size="sm" />
                </div>
              </div>
            </td>
          </tr>
        )}
      </React.Fragment>
    );
  };

  return (
    <div style={{ marginTop: 28 }}>
      <SectionTitle
        title="Invoice Documentation Analysis"
        subtitle="Reconciliation of amounts billed (pre-fee) against invoices on file and self-performed work records"
      />

      {/* Narrative Summary */}
      <div style={{ background: T.surface, border: `1px solid ${T.border}`, borderRadius: 10, padding: 20, marginBottom: 20, lineHeight: 1.8 }}>
        <div style={{ fontSize: 14, color: T.text, fontFamily: T.font }}>
          Of <strong>${(totalBilled).toLocaleString("en-US", { minimumFractionDigits: 2 })}</strong> in cost-of-work billing across 16 payment applications,{" "}
          <strong>${(totalInvoices).toLocaleString("en-US", { minimumFractionDigits: 2 })}</strong> is supported by third-party invoices on file.{" "}
          An additional <strong>${(totalSelfPerformed).toLocaleString("en-US", { minimumFractionDigits: 2 })}</strong> represents{" "}
          self-performed work by Montana Contracting crews, documented in the CM Tracker but without third-party invoices (as expected for in-house labor).{" "}
          The remaining <strong>${(Math.abs(totalNetVar)).toLocaleString("en-US", { minimumFractionDigits: 2 })}</strong> in unreconciled variance is under review.{" "}
          <strong>{supportedCount} of 16</strong> requisitions are fully supported; <strong>{needsDocsCount}</strong> require additional documentation.
        </div>
      </div>

      {/* KPIs */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 20 }}>
        <KPI label="Documentation Coverage" value={`${pctSupported}%`} sub={`${totalSupported.toLocaleString("en-US", { style: "currency", currency: "USD" })} of ${totalBilled.toLocaleString("en-US", { style: "currency", currency: "USD" })}`} accent color={pctSupported >= 85 ? T.green : pctSupported >= 70 ? T.amber : T.red} />
        <KPI label="Invoices on File" isMoney rawAmount={totalInvoices} sub="Third-party vendor invoices" color={T.text} />
        <KPI label="Self-Performed Work" isMoney rawAmount={totalSelfPerformed} sub="Montana Contracting in-house labor" color={T.amber} />
        <KPI label="Unreconciled Variance" isMoney rawAmount={Math.abs(totalNetVar)} sub={`${needsDocsCount} requisitions need documentation`} color={totalNetVar < -1000 ? T.red : T.green} />
      </div>

      {/* Grouped Table */}
      {groups.map(group => (
        <Card key={group.label} padding={0} style={{ marginBottom: 16 }}>
          {/* Group header */}
          <div style={{ padding: "10px 14px", background: group.bg, borderBottom: `1px solid ${group.border}`, display: "flex", alignItems: "center", gap: 10 }}>
            <Ic name={group.color === T.green ? "check" : group.color === T.amber ? "alert" : "flag"} size={14} color={group.color} />
            <span style={{ fontSize: 12, fontWeight: 600, color: group.color, fontFamily: T.font, letterSpacing: 0.3 }}>
              {group.label}
            </span>
            <span style={{ fontSize: 11, color: T.textMuted, fontFamily: T.font }}>
              — {group.rows.length} requisition{group.rows.length !== 1 ? "s" : ""}
            </span>
          </div>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr>
                <th style={Th}>REQ</th>
                <th style={{ ...Th, textAlign: "right" }}>AMOUNT BILLED</th>
                <th style={{ ...Th, textAlign: "right" }}>INVOICES ON FILE</th>
                <th style={{ ...Th, textAlign: "right" }}>SELF-PERFORMED</th>
                <th style={{ ...Th, textAlign: "right" }}>TOTAL SUPPORTED</th>
                <th style={{ ...Th, textAlign: "right" }}>NET VARIANCE</th>
                <th style={{ ...Th, textAlign: "center" }}>STATUS</th>
              </tr>
            </thead>
            <tbody>
              {group.rows.map(renderRow)}
            </tbody>
          </table>
        </Card>
      ))}

      {/* Grand Totals */}
      <Card padding={0}>
        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <tbody>
            <tr style={{ background: T.bg }}>
              <td style={{ ...Td, fontSize: 11, fontWeight: 600, color: T.textMuted, borderBottom: "none", letterSpacing: 0.5, width: "15%" }}>GRAND TOTALS</td>
              <td style={{ ...Td, textAlign: "right", borderBottom: "none", width: "14%" }}><Money amount={totalBilled} color={T.blue} size="sm" /></td>
              <td style={{ ...Td, textAlign: "right", borderBottom: "none", width: "14%" }}><Money amount={totalInvoices} color={T.text} size="sm" /></td>
              <td style={{ ...Td, textAlign: "right", borderBottom: "none", width: "14%" }}><Money amount={totalSelfPerformed} color={T.amber} size="sm" /></td>
              <td style={{ ...Td, textAlign: "right", borderBottom: "none", width: "14%" }}><Money amount={totalSupported} color={T.text} size="sm" /></td>
              <td style={{ ...Td, textAlign: "right", borderBottom: "none", width: "14%" }}>
                <Money amount={Math.abs(totalNetVar)} color={totalNetVar < -1000 ? T.red : T.green} size="sm" neg={totalNetVar < 0} />
              </td>
              <td style={{ ...Td, textAlign: "center", borderBottom: "none", width: "15%" }}>
                <span style={{ fontSize: 11, fontFamily: T.mono, color: T.textMuted }}>{supportedCount} of {rows.length} supported</span>
              </td>
            </tr>
          </tbody>
        </table>
      </Card>
    </div>
  );
}

// ── ARBITRATION SIMULATOR (BALANCED) ─────────────────────────────────────────

const ARBITRATOR_PROFILES = [
  {
    id: "abramowitz", name: "Robin S. Abramowitz", subtitle: "Assigned Arbitrator — AAA Construction Panel",
    bio: "30+ years civil litigation. AAA Construction & Commercial Panels. Represents both owners and contractors. Presented on 'Neutralizing the Litigator Mentality' — values substance over adversarial posturing. Mediation philosophy: 'authentic commitment and participation.' Suffolk County Ethics & Civility Committee. AV Preeminent rated.",
    traits: { contractWeight: 0.70, docRequired: 0.75, ownerBias: 0.48, analyticalRigor: 0.72, industryStandard: 0.65, pragmatism: 0.70 },
    color: T.accent,
  },
  {
    id: "contract_purist", name: "The Contract Purist", subtitle: "Strict textual interpretation",
    bio: "Former transactional attorney. Reads every clause literally. If the contract says it, that's the law between the parties. Rarely considers industry custom or equitable arguments. Documentation must be airtight or claims fail.",
    traits: { contractWeight: 0.95, docRequired: 0.90, ownerBias: 0.40, analyticalRigor: 0.85, industryStandard: 0.15, pragmatism: 0.15 },
    color: T.blue,
  },
  {
    id: "owner_advocate", name: "The Homeowner's Shield", subtitle: "Consumer protection orientation",
    bio: "Background in consumer protection law. Believes homeowners are inherently disadvantaged against professional contractors. Scrutinizes contractor billing heavily. Sympathetic to owner frustration with defective work. Skeptical of contractor cost-plus markups.",
    traits: { contractWeight: 0.50, docRequired: 0.55, ownerBias: 0.78, analyticalRigor: 0.60, industryStandard: 0.30, pragmatism: 0.55 },
    color: T.red,
  },
  {
    id: "industry_veteran", name: "The Industry Veteran", subtitle: "Construction trade experience",
    bio: "Former GC turned construction attorney. Understands change orders, field conditions, and cost-plus realities. Gives benefit of the doubt to industry practices. Recognizes that construction is messy and documentation often imperfect. Values practical outcomes.",
    traits: { contractWeight: 0.55, docRequired: 0.45, ownerBias: 0.28, analyticalRigor: 0.55, industryStandard: 0.90, pragmatism: 0.70 },
    color: T.green,
  },
  {
    id: "forensic_accountant", name: "The Forensic Auditor", subtitle: "Numbers-driven analysis",
    bio: "CPA background with forensic accounting expertise. Follows the money trail relentlessly. Every dollar must be documented and justified. Cross-references invoices, timecards, and schedules. Catches discrepancies others miss. Less interested in who's sympathetic, more interested in what the numbers prove.",
    traits: { contractWeight: 0.65, docRequired: 0.95, ownerBias: 0.50, analyticalRigor: 0.98, industryStandard: 0.35, pragmatism: 0.25 },
    color: "#7C3AED",
  },
  {
    id: "pragmatist", name: "The Pragmatic Settler", subtitle: "Split-the-difference mediator mentality",
    bio: "Former mediator who believes most construction disputes have merit on both sides. Seeks the 'zone of possible agreement.' Will award partial amounts on close calls. Rarely gives 100% to either side. Values business relationship preservation and practical resolution.",
    traits: { contractWeight: 0.50, docRequired: 0.50, ownerBias: 0.50, analyticalRigor: 0.45, industryStandard: 0.55, pragmatism: 0.95 },
    color: T.amber,
  },
];

const TRAIT_LABELS = {
  contractWeight: { label: "Contract Adherence", desc: "Strict contract interpretation vs. equity/fairness" },
  docRequired: { label: "Documentation Rigor", desc: "How strictly backup documentation is required" },
  ownerBias: { label: "Owner Sympathy", desc: "Tendency toward homeowner (0=pro-GC, 0.5=neutral, 1=pro-owner)" },
  analyticalRigor: { label: "Analytical Depth", desc: "How deeply they audit numbers and accounting" },
  industryStandard: { label: "Industry Deference", desc: "Weight given to trade customs and practices" },
  pragmatism: { label: "Pragmatism", desc: "Tendency to split the difference vs. all-or-nothing" },
};

// Case-specific disputes — BALANCED assessment of both sides
const CASE_DISPUTES = [
  // ── OWNER CLAIMS (Owner seeking damages from MC) ──
  {
    id: "consequential", category: "owner_claim", title: "Consequential Damages — §21.11 Waiver",
    description: "Delay damages ($26,600) + insulation energy costs ($3,000). Contract contains mutual waiver of consequential damages.",
    amountAtStake: 29600,
    ownerStrength: "18-month project overrun is real harm. Owner lived elsewhere paying rent. Energy cost difference is quantifiable. Some courts narrow waiver to exclude direct consequential damages.",
    mcStrength: "§21.11 mutual waiver is unambiguous. 125 owner-initiated COs contributed to delay. Industry standard clause. Owner's own architect didn't object to timeline.",
    traitEffect: { contractWeight: -0.8, docRequired: -0.2, ownerBias: 0.5, analyticalRigor: -0.2, industryStandard: -0.3, pragmatism: 0.3 },
    baseOwnerRecovery: 0.08,
  },
  {
    id: "fireplace", category: "owner_claim", title: "Fireplace Defects — Stone/Blueboard/Chips",
    description: "Owner claims $45,000 for fireplace defects including visible blueboard, stone chips, and sloppy workmanship.",
    amountAtStake: 45000,
    ownerStrength: "Visible defects are documented in photos. Blueboard showing is objectively defective. Stone chipping suggests poor installation. $45K fireplace should meet basic aesthetic standards. Expert can testify to remediation cost.",
    mcStrength: "Manufacturer rep inspected and approved. Owner selected stone type and color. Durock installation per spec. MC offered corrective work — owner refused. Refusal to allow repair undermines damage claim.",
    traitEffect: { contractWeight: -0.3, docRequired: 0.1, ownerBias: 0.5, analyticalRigor: 0.0, industryStandard: -0.3, pragmatism: 0.4 },
    baseOwnerRecovery: 0.25,
  },
  {
    id: "air_returns", category: "owner_claim", title: "Air Returns & Air Handlers",
    description: "Air return misplacement ($15K) + quiet air handler upgrade demand ($14K). Owner claims comfort and functionality compromised.",
    amountAtStake: 29000,
    ownerStrength: "HVAC comfort directly impacts livability. Noise complaints are subjective but real. Owner paying $1.7M expects a quiet home. Air return placement affects air quality and efficiency.",
    mcStrength: "Existing framing prohibited original placement — documented at weekly architect meetings. No MEP spec ever provided by owner/architect. Air handlers installed under budget per contract. Owner refused professional mechanical engineer recommendation. Upgrade beyond contract scope.",
    traitEffect: { contractWeight: -0.4, docRequired: -0.1, ownerBias: 0.5, analyticalRigor: -0.1, industryStandard: -0.4, pragmatism: 0.4 },
    baseOwnerRecovery: 0.18,
  },
  {
    id: "defective_misc", category: "owner_claim", title: "Defective Work — Roofing/Shower/Drain/Doors/Warranty",
    description: "Roofing ($8.5K), shower glass ($3K), french drain ($10K), doors ($3K), warranty escrow ($10K), insulation ($2K), sink ($99).",
    amountAtStake: 36599,
    ownerStrength: "Curled shingles are visible and documented. Doors with gaps/rattles are objectively defective. French drain leaked for months. Multiple items suggest pattern of poor workmanship. Owner paid $1.7M and deserves completed punchlist.",
    mcStrength: "Roofing: manufacturer confirmed common nailing, minor fix sufficient. Shower: plans show 3 panes, not one-piece. Drain: existed pre-MC, installed upside down before MC arrived. Doors: punchlist items — will complete upon final payment. Warranty: per contract, issued upon final payment which owner withholds.",
    traitEffect: { contractWeight: -0.2, docRequired: 0.1, ownerBias: 0.4, analyticalRigor: 0.1, industryStandard: -0.2, pragmatism: 0.5 },
    baseOwnerRecovery: 0.32,
  },
  {
    id: "agreed_credits", category: "owner_claim", title: "Agreed Credits & Corrections",
    description: "Items MC already conceded: switches ($3,300), floor ($9,719), beam ($600), door trim ($2,260), painting/staining/ceiling ($4,690).",
    amountAtStake: 21569,
    ownerStrength: "MC's own concessions. Values reflect MC's agreed amounts. Non-contestable at this point.",
    mcStrength: "Credits already calculated at actual cost, not owner's inflated estimates. Shows MC's good faith willingness to address legitimate issues.",
    traitEffect: { contractWeight: 0.0, docRequired: 0.0, ownerBias: 0.0, analyticalRigor: 0.0, industryStandard: 0.0, pragmatism: 0.0 },
    baseOwnerRecovery: 1.0,
  },
  // ── MC COUNTERCLAIMS (MC seeking credits/offsets from Owner) ──
  {
    id: "unapplied_credits", category: "mc_counter", title: "Unapplied CO Credits on G703",
    description: "$135,385 in credit COs at 0% on REQ-15 G703: PCO#130 'GC-Owner Variance Split' ($66,389), PCO#129 'Allowance Reconciliation' ($24,248), plus 5 others.",
    amountAtStake: 135385,
    mcStrength: "Credits are ON MC's own G703 schedule. MC acknowledged variances. PCO#130 title literally says 'Owner Variance Split.' These are documented admissions of amounts owed to owner.",
    ownerWeakness: "Owner never demanded application of these credits. Credits remained at 0% for months. Owner's own review failed to catch this. Some credits may reflect incomplete change order accounting rather than amounts owed.",
    traitEffect: { contractWeight: 0.4, docRequired: 0.4, ownerBias: -0.2, analyticalRigor: 0.6, industryStandard: 0.1, pragmatism: 0.3 },
    baseMcRecovery: 0.35,
  },
  {
    id: "hidden_ohp", category: "mc_counter", title: "CO OH&P Markup Questions",
    description: "REQs 11-14 show 25% markup on change orders not separately itemized on G703. Pattern across 4 consecutive requisitions.",
    amountAtStake: 50000,
    mcStrength: "AIA A110 cost-plus contracts typically allow OH&P on all work including changes. 25% is the contractual rate. MC applied it consistently. Not 'hidden' — it's the contract rate.",
    ownerWeakness: "CO subtotals don't appear as separate G703 line items, making auditing difficult. Owner approved REQs without questioning. But lack of transparency on cost-plus contract is problematic — §15.3.2 requires clear documentation.",
    traitEffect: { contractWeight: 0.3, docRequired: 0.5, ownerBias: -0.1, analyticalRigor: 0.6, industryStandard: -0.3, pragmatism: 0.2 },
    baseMcRecovery: 0.25,
  },
  {
    id: "base_to_co", category: "mc_counter", title: "Base-to-CO Reclassification (REQ-13R1)",
    description: "REQ-13R1 shows ~$92K in base credits offset by new CO billing. Work originally billed as base contract appears reclassified as change orders, generating additional markup.",
    amountAtStake: 92000,
    mcStrength: "Reclassification generated additional OH&P on the same work. Pattern visible in the revised requisition. Credits in one column, new CO charges in another.",
    ownerWeakness: "Reclassification may reflect legitimate scope clarification — COs sometimes absorb base work when scope changes. Very complex forensic argument requiring expert testimony. Hard to prove intent vs. accounting correction. Owner approved the revised requisition.",
    traitEffect: { contractWeight: 0.4, docRequired: 0.3, ownerBias: -0.1, analyticalRigor: 0.5, industryStandard: -0.4, pragmatism: 0.3 },
    baseMcRecovery: 0.20,
  },
  {
    id: "korth_overbilling", category: "mc_counter", title: "Korth Painting — Over Contract Value",
    description: "Korth & Shannahan billed $89,942 vs $49,450 contract — 182%. Sub billed carpentry ($26,252) through painting line item.",
    amountAtStake: 40492,
    mcStrength: "Numbers are clear: 182% of contract value. Painting sub billing carpentry work is cross-trade contamination. Over-budget by $40K+.",
    ownerWeakness: "Cost-plus contract means actual costs are billed — if Korth did extra work, owner pays. MC approved and processed all Korth invoices. Some overbilling may reflect legitimate change order work. Owner's architect didn't flag the overrun during monthly reviews.",
    traitEffect: { contractWeight: 0.3, docRequired: 0.4, ownerBias: -0.1, analyticalRigor: 0.5, industryStandard: -0.2, pragmatism: 0.3 },
    baseMcRecovery: 0.35,
  },
  {
    id: "documentation_failures", category: "mc_counter", title: "MC Documentation Deficiencies (§15.3.2)",
    description: "Systemic issues: estimates as invoices, no timecards (13 of 15 REQs), anonymous subs, out-of-period invoices (up to 19 months), supervision as billable cost.",
    amountAtStake: 40000,
    mcStrength: "§15.3.2 requires documentation for all costs. MC failed systematically. Estimates are not invoices. Missing timecards means labor costs are unverifiable. Out-of-period billing suggests inaccurate accounting.",
    ownerWeakness: "Owner approved every requisition without objection. Owner's architect reviewed and didn't flag issues. Industry reality: residential construction documentation is often imperfect. Not every documentation gap equals overbilling — MC may have underbilled on some items too.",
    traitEffect: { contractWeight: 0.4, docRequired: 0.7, ownerBias: 0.0, analyticalRigor: 0.5, industryStandard: -0.5, pragmatism: 0.2 },
    baseMcRecovery: 0.22,
  },
];

// Party strengths/weaknesses for balanced display
const PARTY_ANALYSIS = {
  mc: {
    strengths: [
      "§21.11 consequential waiver is clear and enforceable",
      "Offered corrective work on multiple defect claims — owner refused",
      "125 owner-initiated change orders contributed to delays",
      "Manufacturer approved fireplace installation",
      "Framing constraints on air returns documented at weekly meetings",
      "Work substantially complete — owner occupying the home",
      "Agreed credits ($21.6K) show good faith on legitimate items",
    ],
    weaknesses: [
      "Systemic documentation failures across all 16 requisitions (§15.3.2)",
      "No timecards for 13 of 15 billing periods — labor costs unverifiable",
      "Out-of-period invoices: up to 19 months (ABC Supply in REQ-15)",
      "$135K in unapplied credits acknowledged but never credited to owner",
      "Korth painting at 182% of contract with cross-trade billing",
      "Estimates submitted as invoices (Boards & Beams in REQ-12)",
      "Hidden CO OH&P pattern across REQs 11-14",
      "Base-to-CO reclassification in REQ-13R1 generates extra markup",
      "Anonymous subs and missing backup on multiple line items",
    ],
  },
  owner: {
    strengths: [
      "Visible, documented defects (fireplace blueboard, curled shingles, door gaps)",
      "MC's own G703 shows $135K in unapplied credits — MC's admission",
      "Cost-plus contract requires full transparency — MC failed §15.3.2",
      "Paid $1.6M+ on a $1.18M base contract — significant investment",
      "Multiple MC-agreed credits validate pattern of issues",
      "Punchlist items remain incomplete after 2+ years",
      "Expert testimony potential on defect remediation costs",
    ],
    weaknesses: [
      "§21.11 waiver bars consequential/delay claims ($29.6K at risk)",
      "Approved every requisition without contemporaneous objection",
      "Refused MC's offers of corrective work on fireplace",
      "Refused mechanical engineer recommendation on HVAC",
      "125 change orders created scope changes and timeline impacts",
      "Architect failed to catch billing irregularities during reviews",
      "Withheld final payment, triggering warranty/punchlist standoff",
    ],
  },
};

// Legal team profiles
const LEGAL_TEAM_PROFILES = [
  {
    id: "elite_construction", name: "Elite Construction Litigator",
    description: "Deep AIA/cost-plus expertise. Methodical exhibit preparation. Strong with expert witnesses. Understands G702/G703 inside and out.",
    traits: { preparation: 0.90, constructionKnowledge: 0.95, advocacy: 0.80, crossExam: 0.85 },
  },
  {
    id: "aggressive_trial", name: "Aggressive Trial Attorney",
    description: "High-energy cross-examiner. Maximizes every claim. Strong courtroom presence but may overreach. Less construction-specific knowledge.",
    traits: { preparation: 0.70, constructionKnowledge: 0.45, advocacy: 0.90, crossExam: 0.95 },
  },
  {
    id: "settlement_oriented", name: "Settlement-Oriented Counsel",
    description: "Focused on practical resolution. Strong negotiator. Avoids risk. May leave money on the table to ensure a deal.",
    traits: { preparation: 0.65, constructionKnowledge: 0.60, advocacy: 0.55, crossExam: 0.50 },
  },
  {
    id: "methodical_document", name: "Methodical Document Attorney",
    description: "Builds case entirely on paper trail. Every exhibit labeled and cross-referenced. May lack courtroom flair but evidence is airtight.",
    traits: { preparation: 0.95, constructionKnowledge: 0.70, advocacy: 0.55, crossExam: 0.60 },
  },
  {
    id: "budget_solo", name: "Budget-Conscious Solo",
    description: "Competent but resource-constrained. Limited expert budget. May miss complex forensic accounting issues. Solid on straightforward claims.",
    traits: { preparation: 0.50, constructionKnowledge: 0.50, advocacy: 0.60, crossExam: 0.55 },
  },
];

const LEGAL_TRAIT_LABELS = {
  preparation: { label: "Preparation", desc: "Exhibit quality, witness prep, document organization" },
  constructionKnowledge: { label: "Construction Expertise", desc: "AIA contracts, G702/G703, cost-plus billing knowledge" },
  advocacy: { label: "Advocacy Strength", desc: "Persuasiveness, oral presentation, opening/closing" },
  crossExam: { label: "Cross-Examination", desc: "Ability to undermine opposing witnesses and evidence" },
};

function simulateCase(arb, mcLegal, ownerLegal) {
  // Legal team quality modifiers (0.85-1.15 range)
  const mcLegalMod = mcLegal ? 0.85 + (Object.values(mcLegal).reduce((s,v) => s + v, 0) / Object.values(mcLegal).length) * 0.30 : 1.0;
  const ownerLegalMod = ownerLegal ? 0.85 + (Object.values(ownerLegal).reduce((s,v) => s + v, 0) / Object.values(ownerLegal).length) * 0.30 : 1.0;

  const results = CASE_DISPUTES.map(d => {
    let recovery;
    if (d.category === "owner_claim") {
      recovery = d.baseOwnerRecovery;
      Object.entries(d.traitEffect).forEach(([trait, effect]) => {
        recovery += (arb.traits[trait] || 0.5) * effect * 0.12;
      });
      // Owner's legal team boosts their recovery; MC's legal team reduces it
      recovery = recovery * (ownerLegalMod / mcLegalMod);
      recovery = Math.max(0, Math.min(1, recovery));
      if (arb.traits.pragmatism > 0.7 && recovery > 0.1 && recovery < 0.9) {
        recovery = recovery * 0.7 + 0.15;
      }
      const awarded = Math.round(d.amountAtStake * recovery);
      return { ...d, recovery, awarded, direction: "owner", netMcImpact: -awarded };
    } else {
      recovery = d.baseMcRecovery;
      Object.entries(d.traitEffect).forEach(([trait, effect]) => {
        recovery += (arb.traits[trait] || 0.5) * effect * 0.12;
      });
      // MC's legal team boosts counter-recovery; Owner's legal team reduces it
      recovery = recovery * (mcLegalMod / ownerLegalMod);
      recovery = Math.max(0, Math.min(1, recovery));
      if (arb.traits.pragmatism > 0.7 && recovery > 0.1 && recovery < 0.9) {
        recovery = recovery * 0.7 + 0.15;
      }
      const awarded = Math.round(d.amountAtStake * recovery);
      return { ...d, recovery, awarded, direction: "mc", netMcImpact: awarded };
    }
  });

  const ownerTotal = results.filter(r => r.direction === "owner").reduce((s, r) => s + r.awarded, 0);
  const mcTotal = results.filter(r => r.direction === "mc").reduce((s, r) => s + r.awarded, 0);
  const netPosition = mcTotal - ownerTotal;

  return { results, ownerTotal, mcTotal, netPosition };
}

function ArbitrationSimulator({ reqs, claims }) {
  const [selectedIdx, setSelectedIdx] = useState(0);
  const [customMode, setCustomMode] = useState(false);
  const [customTraits, setCustomTraits] = useState({ contractWeight: 0.50, docRequired: 0.50, ownerBias: 0.50, analyticalRigor: 0.50, industryStandard: 0.50, pragmatism: 0.50 });
  const [customName, setCustomName] = useState("");
  const [compareMode, setCompareMode] = useState(false);
  const [mcLegalIdx, setMcLegalIdx] = useState(0);
  const [ownerLegalIdx, setOwnerLegalIdx] = useState(0);
  const [mcCustomLegal, setMcCustomLegal] = useState({ preparation: 0.65, constructionKnowledge: 0.65, advocacy: 0.65, crossExam: 0.65 });
  const [ownerCustomLegal, setOwnerCustomLegal] = useState({ preparation: 0.65, constructionKnowledge: 0.65, advocacy: 0.65, crossExam: 0.65 });
  const [mcLegalCustom, setMcLegalCustom] = useState(false);
  const [ownerLegalCustom, setOwnerLegalCustom] = useState(false);
  const [customResearch, setCustomResearch] = useState({ firm: "", yearsExp: "", practiceAreas: "", panelMemberships: "", publications: "", knownTendencies: "", notes: "" });

  const activeArb = customMode
    ? { id: "custom", name: customName || "Custom Arbitrator", subtitle: "User-defined personality", traits: customTraits, color: T.textMid, bio: "" }
    : ARBITRATOR_PROFILES[selectedIdx];

  const mcLegal = mcLegalCustom ? mcCustomLegal : LEGAL_TEAM_PROFILES[mcLegalIdx].traits;
  const ownerLegal = ownerLegalCustom ? ownerCustomLegal : LEGAL_TEAM_PROFILES[ownerLegalIdx].traits;

  const sim = simulateCase(activeArb, mcLegal, ownerLegal);

  // Run all profiles for comparison (with current legal teams)
  const allSims = ARBITRATOR_PROFILES.map(a => ({ arb: a, sim: simulateCase(a, mcLegal, ownerLegal) }));
  if (customMode) allSims.push({ arb: activeArb, sim });

  const pctBar = (val, max, color) => (
    <div style={{ width: "100%", height: 10, background: T.border, borderRadius: 5, overflow: "hidden" }}>
      <div style={{ width: `${Math.min(100, (val / max) * 100)}%`, height: "100%", background: color, borderRadius: 3, transition: "width 0.4s ease" }} />
    </div>
  );

  const traitSlider = (key, value, onChange, disabled) => (
    <div style={{ marginBottom: 10 }}>
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 3 }}>
        <span style={{ fontSize: 11, fontWeight: 500, color: T.text, fontFamily: T.font }}>{TRAIT_LABELS[key].label}</span>
        <span style={{ fontSize: 11, fontFamily: T.mono, color: T.accent }}>{(value * 100).toFixed(0)}%</span>
      </div>
      <input type="range" min="0" max="100" value={Math.round(value * 100)}
        disabled={disabled}
        onChange={e => onChange(parseInt(e.target.value) / 100)}
        style={{ width: "100%", accentColor: activeArb.color, cursor: disabled ? "default" : "pointer", opacity: disabled ? 0.6 : 1 }}
      />
      <div style={{ fontSize: 10, color: T.textMuted, fontFamily: T.font, marginTop: 1 }}>{TRAIT_LABELS[key].desc}</div>
    </div>
  );

  return (
    <div>
      <SectionTitle title="Arbitration Simulator" subtitle="Model case outcomes across different arbitrator personalities · Based on actual case data from 15 requisitions and 24 owner claims" />

      {/* Arbitrator Selection */}
      <Card>
        <CardLabel label="Select Arbitrator Profile" />
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 16 }}>
          {ARBITRATOR_PROFILES.map((a, i) => (
            <button key={a.id} onClick={() => { setSelectedIdx(i); setCustomMode(false); }} style={{
              padding: "8px 14px", borderRadius: 8, cursor: "pointer", fontFamily: T.font, fontSize: 12, fontWeight: 500,
              border: `1.5px solid ${!customMode && selectedIdx === i ? a.color : T.border}`,
              background: !customMode && selectedIdx === i ? (a.color + "12") : T.surface,
              color: !customMode && selectedIdx === i ? a.color : T.textMid,
              transition: "all 0.15s",
            }}>
              {a.id === "abramowitz" ? "\u2605 " : ""}{a.name}
            </button>
          ))}
          <button onClick={() => setCustomMode(true)} style={{
            padding: "8px 14px", borderRadius: 8, cursor: "pointer", fontFamily: T.font, fontSize: 12, fontWeight: 500,
            border: `1.5px dashed ${customMode ? T.accent : T.border}`,
            background: customMode ? T.accentBg : T.surface,
            color: customMode ? T.accent : T.textMid,
          }}>+ Custom Arbitrator</button>
        </div>

        {/* Profile Info */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 340px", gap: 20 }}>
          <div>
            <div style={{ display: "flex", alignItems: "baseline", gap: 10, marginBottom: 4 }}>
              <span style={{ fontSize: 18, fontWeight: 600, color: activeArb.color, fontFamily: T.font }}>{activeArb.name}</span>
            </div>
            <div style={{ fontSize: 12, color: T.textMuted, fontFamily: T.font, marginBottom: 10 }}>{activeArb.subtitle}</div>
            {activeArb.bio && <div style={{ fontSize: 12, color: T.textMid, fontFamily: T.font, lineHeight: 1.7, padding: "10px 14px", background: T.bg, borderRadius: 8 }}>{activeArb.bio}</div>}
            {customMode && (
              <div style={{ marginTop: 10 }}>
                <input type="text" placeholder="Enter arbitrator name..." value={customName} onChange={e => setCustomName(e.target.value)}
                  style={{ width: "100%", padding: "8px 12px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 13, fontFamily: T.font, color: T.text, background: T.surface }} />
              </div>
            )}
          </div>
          <div style={{ padding: "12px 16px", background: T.bg, borderRadius: 10, border: `1px solid ${T.border}` }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: T.textMuted, letterSpacing: 0.5, marginBottom: 12 }}>PERSONALITY TRAITS</div>
            {Object.keys(TRAIT_LABELS).map(key => traitSlider(
              key,
              activeArb.traits[key],
              (v) => customMode && setCustomTraits(prev => ({ ...prev, [key]: v })),
              !customMode
            ))}
          </div>
        </div>
      </Card>

      {/* Legal Teams */}
      <Card>
        <CardLabel label="Legal Team Profiles" />
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
          {[{ side: "MC Legal Team", profiles: LEGAL_TEAM_PROFILES, idx: mcLegalIdx, setIdx: setMcLegalIdx, isCustom: mcLegalCustom, setCustom: setMcLegalCustom, customTraits: mcCustomLegal, setCustomTraits: setMcCustomLegal, color: T.accent },
            { side: "Owner Legal Team", profiles: LEGAL_TEAM_PROFILES, idx: ownerLegalIdx, setIdx: setOwnerLegalIdx, isCustom: ownerLegalCustom, setCustom: setOwnerLegalCustom, customTraits: ownerCustomLegal, setCustomTraits: setOwnerCustomLegal, color: T.blue }]
          .map(({ side, profiles, idx, setIdx, isCustom, setCustom, customTraits: ct, setCustomTraits: setCt, color }) => (
            <div key={side} style={{ padding: "14px 16px", background: T.bg, borderRadius: 10, border: `1px solid ${T.border}` }}>
              <div style={{ fontSize: 12, fontWeight: 600, color, letterSpacing: 0.3, marginBottom: 10, fontFamily: T.font }}>{side}</div>
              <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 12 }}>
                {profiles.map((p, i) => (
                  <button key={p.id} onClick={() => { setIdx(i); setCustom(false); }} style={{
                    padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontFamily: T.font, fontSize: 10, fontWeight: 500,
                    border: `1px solid ${!isCustom && idx === i ? color : T.border}`,
                    background: !isCustom && idx === i ? color + "15" : T.surface,
                    color: !isCustom && idx === i ? color : T.textMuted,
                  }}>{p.name}</button>
                ))}
                <button onClick={() => setCustom(true)} style={{
                  padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontFamily: T.font, fontSize: 10, fontWeight: 500,
                  border: `1px dashed ${isCustom ? color : T.border}`,
                  background: isCustom ? color + "15" : T.surface, color: isCustom ? color : T.textMuted,
                }}>Custom</button>
              </div>
              <div style={{ fontSize: 11, color: T.textMid, marginBottom: 8, fontFamily: T.font }}>
                {isCustom ? "Adjust traits below:" : profiles[idx].description}
              </div>
              {Object.keys(LEGAL_TRAIT_LABELS).map(key => (
                <div key={key} style={{ marginBottom: 6 }}>
                  <div style={{ display: "flex", justifyContent: "space-between" }}>
                    <span style={{ fontSize: 10, color: T.textMid, fontFamily: T.font }}>{LEGAL_TRAIT_LABELS[key].label}</span>
                    <span style={{ fontSize: 10, fontFamily: T.mono, color }}>{((isCustom ? ct[key] : profiles[idx].traits[key]) * 100).toFixed(0)}%</span>
                  </div>
                  <input type="range" min="0" max="100" value={Math.round((isCustom ? ct[key] : profiles[idx].traits[key]) * 100)}
                    disabled={!isCustom} onChange={e => isCustom && setCt(prev => ({ ...prev, [key]: parseInt(e.target.value) / 100 }))}
                    style={{ width: "100%", accentColor: color, height: 4, cursor: isCustom ? "pointer" : "default", opacity: isCustom ? 1 : 0.5 }} />
                </div>
              ))}
            </div>
          ))}
        </div>
      </Card>

      {/* Party Strengths & Weaknesses */}
      <Card>
        <CardLabel label="Balanced Case Assessment — Both Parties" />
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
          {[{ party: "Montana Contracting (GC)", data: PARTY_ANALYSIS.mc, color: T.accent },
            { party: "Tharp/Bumgardner (Owner)", data: PARTY_ANALYSIS.owner, color: T.blue }].map(({ party, data, color }) => (
            <div key={party}>
              <div style={{ fontSize: 13, fontWeight: 600, color, fontFamily: T.font, marginBottom: 10 }}>{party}</div>
              <div style={{ padding: 12, background: T.greenBg, border: `1px solid ${T.greenBorder}`, borderRadius: 8, marginBottom: 8 }}>
                <div style={{ fontSize: 10, fontWeight: 600, color: T.green, letterSpacing: 0.5, marginBottom: 6 }}>STRENGTHS</div>
                {data.strengths.map((s, i) => (
                  <div key={i} style={{ fontSize: 11, color: T.textMid, fontFamily: T.font, lineHeight: 1.6, paddingLeft: 10, borderLeft: `2px solid ${T.greenBorder}`, marginBottom: 4 }}>{s}</div>
                ))}
              </div>
              <div style={{ padding: 12, background: T.redBg, border: `1px solid ${T.redBorder}`, borderRadius: 8 }}>
                <div style={{ fontSize: 10, fontWeight: 600, color: T.red, letterSpacing: 0.5, marginBottom: 6 }}>WEAKNESSES</div>
                {data.weaknesses.map((w, i) => (
                  <div key={i} style={{ fontSize: 11, color: T.textMid, fontFamily: T.font, lineHeight: 1.6, paddingLeft: 10, borderLeft: `2px solid ${T.redBorder}`, marginBottom: 4 }}>{w}</div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </Card>

      {/* Simulation Results */}
      <Card>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
          <CardLabel label="Simulated Case Outcome" />
          <button onClick={() => setCompareMode(!compareMode)} style={{
            padding: "6px 12px", borderRadius: 6, border: `1px solid ${T.border}`, background: compareMode ? T.accentBg : T.surface,
            cursor: "pointer", fontSize: 11, fontFamily: T.font, fontWeight: 500, color: compareMode ? T.accent : T.textMid,
          }}>{compareMode ? "Hide Comparison" : "Compare All"}</button>
        </div>

        {/* Net Position Summary */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 20 }}>
          <div style={{ padding: 16, background: T.redBg, border: `1px solid ${T.redBorder}`, borderRadius: 10, textAlign: "center" }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: T.red, letterSpacing: 0.5, marginBottom: 6 }}>OWNER RECOVERY</div>
            <div style={{ fontFamily: T.mono, fontSize: 22, fontWeight: 700, color: T.red }}>${sim.ownerTotal.toLocaleString()}</div>
            <div style={{ fontSize: 11, color: T.textMuted, marginTop: 4 }}>of ${CASE_DISPUTES.filter(d=>d.category==="owner_claim").reduce((s,d)=>s+d.amountAtStake,0).toLocaleString()} claimed</div>
          </div>
          <div style={{ padding: 16, background: T.greenBg, border: `1px solid ${T.greenBorder}`, borderRadius: 10, textAlign: "center" }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: T.green, letterSpacing: 0.5, marginBottom: 6 }}>MC COUNTER-RECOVERY</div>
            <div style={{ fontFamily: T.mono, fontSize: 22, fontWeight: 700, color: T.green }}>${sim.mcTotal.toLocaleString()}</div>
            <div style={{ fontSize: 11, color: T.textMuted, marginTop: 4 }}>of ${CASE_DISPUTES.filter(d=>d.category==="mc_counter").reduce((s,d)=>s+d.amountAtStake,0).toLocaleString()} at stake</div>
          </div>
          <div style={{ padding: 16, background: sim.netPosition >= 0 ? T.greenBg : T.redBg, border: `1px solid ${sim.netPosition >= 0 ? T.greenBorder : T.redBorder}`, borderRadius: 10, textAlign: "center" }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: sim.netPosition >= 0 ? T.green : T.red, letterSpacing: 0.5, marginBottom: 6 }}>MC NET POSITION</div>
            <div style={{ fontFamily: T.mono, fontSize: 22, fontWeight: 700, color: sim.netPosition >= 0 ? T.green : T.red }}>{sim.netPosition >= 0 ? "+" : "-"}${Math.abs(sim.netPosition).toLocaleString()}</div>
            <div style={{ fontSize: 11, color: T.textMuted, marginTop: 4 }}>{sim.netPosition >= 0 ? "MC net recovery" : "MC net liability"}</div>
          </div>
        </div>

        {/* Issue-by-issue breakdown */}
        <div style={{ fontSize: 11, fontWeight: 600, color: T.textMuted, letterSpacing: 0.5, marginBottom: 8 }}>OWNER CLAIMS — EXPOSURE ANALYSIS</div>
        <table style={{ width: "100%", borderCollapse: "collapse", marginBottom: 20 }}>
          <thead>
            <tr>
              {["ISSUE", "CLAIMED", "PROJECTED AWARD", "RECOVERY %", ""].map(h => (
                <th key={h} style={{ padding: "8px 12px", textAlign: "left", fontSize: 10, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, borderBottom: `1px solid ${T.border}`, fontFamily: T.font }}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {sim.results.filter(r => r.direction === "owner").map(r => (
              <tr key={r.id}>
                <td style={{ padding: "10px 12px", fontSize: 12, fontFamily: T.font, color: T.text, borderBottom: `1px solid ${T.border}`, maxWidth: 300 }}>
                  <div style={{ fontWeight: 500 }}>{r.title}</div>
                  <div style={{ fontSize: 11, color: T.textMuted, marginTop: 2 }}>{r.description}</div>
                  {r.ownerStrength && <div style={{ fontSize: 10, color: T.blue, marginTop: 3 }}><b>Owner:</b> {r.ownerStrength.substring(0, 100)}...</div>}
                  {r.mcStrength && <div style={{ fontSize: 10, color: T.accent, marginTop: 1 }}><b>MC:</b> {r.mcStrength.substring(0, 100)}...</div>}
                </td>
                <td style={{ padding: "10px 12px", fontFamily: T.mono, fontSize: 12, color: T.textMid, borderBottom: `1px solid ${T.border}` }}>${r.amountAtStake.toLocaleString()}</td>
                <td style={{ padding: "10px 12px", fontFamily: T.mono, fontSize: 13, fontWeight: 600, color: r.awarded > 0 ? T.red : T.green, borderBottom: `1px solid ${T.border}` }}>${r.awarded.toLocaleString()}</td>
                <td style={{ padding: "10px 12px", borderBottom: `1px solid ${T.border}`, width: 140 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontSize: 11, fontFamily: T.mono, color: T.textMid, minWidth: 32 }}>{(r.recovery * 100).toFixed(0)}%</span>
                    {pctBar(r.recovery, 1, r.recovery > 0.5 ? T.red : r.recovery > 0.25 ? T.amber : T.green)}
                  </div>
                </td>
                <td style={{ padding: "10px 12px", borderBottom: `1px solid ${T.border}` }}>
                  <Badge label={r.recovery > 0.5 ? "HIGH RISK" : r.recovery > 0.25 ? "MODERATE" : "LOW RISK"}
                    style={r.recovery > 0.5 ? { color: T.red, bg: T.redBg, border: T.redBorder } : r.recovery > 0.25 ? { color: T.amber, bg: T.amberBg, border: T.amberBorder } : { color: T.green, bg: T.greenBg, border: T.greenBorder }} />
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        <div style={{ fontSize: 11, fontWeight: 600, color: T.textMuted, letterSpacing: 0.5, marginBottom: 8 }}>MC COUNTERCLAIMS — RECOVERY PROJECTIONS</div>
        <table style={{ width: "100%", borderCollapse: "collapse", marginBottom: 20 }}>
          <thead>
            <tr>
              {["ISSUE", "AT STAKE", "PROJECTED RECOVERY", "PROBABILITY", ""].map(h => (
                <th key={h} style={{ padding: "8px 12px", textAlign: "left", fontSize: 10, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, borderBottom: `1px solid ${T.border}`, fontFamily: T.font }}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {sim.results.filter(r => r.direction === "mc").map(r => (
              <tr key={r.id}>
                <td style={{ padding: "10px 12px", fontSize: 12, fontFamily: T.font, color: T.text, borderBottom: `1px solid ${T.border}`, maxWidth: 300 }}>
                  <div style={{ fontWeight: 500 }}>{r.title}</div>
                  <div style={{ fontSize: 11, color: T.textMuted, marginTop: 2 }}>{r.description}</div>
                  {r.mcStrength && <div style={{ fontSize: 10, color: T.accent, marginTop: 3 }}><b>MC:</b> {r.mcStrength.substring(0, 100)}...</div>}
                  {r.ownerWeakness && <div style={{ fontSize: 10, color: T.blue, marginTop: 1 }}><b>Owner counter:</b> {r.ownerWeakness.substring(0, 100)}...</div>}
                </td>
                <td style={{ padding: "10px 12px", fontFamily: T.mono, fontSize: 12, color: T.textMid, borderBottom: `1px solid ${T.border}` }}>${r.amountAtStake.toLocaleString()}</td>
                <td style={{ padding: "10px 12px", fontFamily: T.mono, fontSize: 13, fontWeight: 600, color: T.green, borderBottom: `1px solid ${T.border}` }}>${r.awarded.toLocaleString()}</td>
                <td style={{ padding: "10px 12px", borderBottom: `1px solid ${T.border}`, width: 140 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontSize: 11, fontFamily: T.mono, color: T.textMid, minWidth: 32 }}>{(r.recovery * 100).toFixed(0)}%</span>
                    {pctBar(r.recovery, 1, r.recovery > 0.6 ? T.green : r.recovery > 0.35 ? T.amber : T.red)}
                  </div>
                </td>
                <td style={{ padding: "10px 12px", borderBottom: `1px solid ${T.border}` }}>
                  <Badge label={r.recovery > 0.6 ? "LIKELY" : r.recovery > 0.35 ? "POSSIBLE" : "UNLIKELY"}
                    style={r.recovery > 0.6 ? { color: T.green, bg: T.greenBg, border: T.greenBorder } : r.recovery > 0.35 ? { color: T.amber, bg: T.amberBg, border: T.amberBorder } : { color: T.red, bg: T.redBg, border: T.redBorder }} />
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </Card>

      {/* Comparison Mode */}
      {compareMode && (
        <Card>
          <CardLabel label="All Arbitrators — Side-by-Side Comparison" />
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr>
                {["ARBITRATOR", "OWNER RECOVERY", "MC COUNTER", "NET MC POSITION", "VERDICT"].map(h => (
                  <th key={h} style={{ padding: "10px 14px", textAlign: "left", fontSize: 10, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, borderBottom: `1px solid ${T.border}`, fontFamily: T.font }}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {allSims.sort((a, b) => b.sim.netPosition - a.sim.netPosition).map(({ arb: a, sim: s }) => (
                <tr key={a.id} style={{ background: a.id === activeArb.id ? T.accentBg : "transparent" }}>
                  <td style={{ padding: "12px 14px", borderBottom: `1px solid ${T.border}` }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: a.color, fontFamily: T.font }}>{a.id === "abramowitz" ? "\u2605 " : ""}{a.name}</div>
                    <div style={{ fontSize: 11, color: T.textMuted }}>{a.subtitle}</div>
                  </td>
                  <td style={{ padding: "12px 14px", fontFamily: T.mono, fontSize: 13, color: T.red, borderBottom: `1px solid ${T.border}` }}>-${s.ownerTotal.toLocaleString()}</td>
                  <td style={{ padding: "12px 14px", fontFamily: T.mono, fontSize: 13, color: T.green, borderBottom: `1px solid ${T.border}` }}>+${s.mcTotal.toLocaleString()}</td>
                  <td style={{ padding: "12px 14px", fontFamily: T.mono, fontSize: 14, fontWeight: 700, color: s.netPosition >= 0 ? T.green : T.red, borderBottom: `1px solid ${T.border}` }}>
                    {s.netPosition >= 0 ? "+" : "-"}${Math.abs(s.netPosition).toLocaleString()}
                  </td>
                  <td style={{ padding: "12px 14px", borderBottom: `1px solid ${T.border}` }}>
                    <Badge label={s.netPosition > 100000 ? "STRONG MC WIN" : s.netPosition > 30000 ? "MC FAVORABLE" : s.netPosition > 0 ? "SLIGHT MC EDGE" : s.netPosition > -30000 ? "TOSS-UP" : "OWNER FAVORABLE"}
                      style={s.netPosition > 30000 ? { color: T.green, bg: T.greenBg, border: T.greenBorder } : s.netPosition > 0 ? { color: T.amber, bg: T.amberBg, border: T.amberBorder } : { color: T.red, bg: T.redBg, border: T.redBorder }} />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>
      )}
    </div>
  );
}

// ── DOCUMENTS ────────────────────────────────────────────────────────────────

const DOC_CATEGORIES = [
  { id: "contract", label: "Contract Documents", ic: "file-text", color: T.accent },
  { id: "requisition", label: "Requisitions / Pay Apps", ic: "dollar", color: T.green },
  { id: "change_order", label: "Change Orders", ic: "refresh", color: T.blue },
  { id: "correspondence", label: "Correspondence", ic: "mail", color: T.purple },
  { id: "invoice", label: "Invoices & Backup", ic: "receipt", color: T.amber },
  { id: "inspection", label: "Inspections & Reports", ic: "search", color: T.red },
  { id: "photo", label: "Photos & Media", ic: "camera", color: T.textMid },
  { id: "arbitration", label: "Arbitration Filings", ic: "scale", color: T.accent },
  { id: "other", label: "Other", ic: "folder", color: T.textMuted },
];

const DOCS_INITIAL = [
  { id: "doc-001", category: "contract", name: "AIA A110-2021 — Standard Form of Agreement (Cost-Plus)", date: "2021-06-15", description: "Prime contract between Montana Contracting Corp and Tharp/Bumgardner. Cost of Work + 25% OH&P.", parties: "MC / Tharp", status: "final", notes: "" },
  { id: "doc-002", category: "contract", name: "AIA A201-2017 — General Conditions", date: "2021-06-15", description: "General Conditions of the Contract for Construction, incorporated by reference.", parties: "MC / Tharp", status: "final", notes: "" },
  { id: "doc-003", category: "contract", name: "Original Scope / Plans & Specifications", date: "2021-06-15", description: "Architectural drawings and specifications for 515 N. Midland Ave renovation.", parties: "", status: "final", notes: "" },
  { id: "doc-004", category: "requisition", name: "REQ-01 — September 2022", date: "2022-09-30", description: "First requisition. Base contract billing $113,282.46 + markup.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-005", category: "requisition", name: "REQ-02 — October 2022", date: "2022-10-31", description: "Second requisition. Cumulative billing through October 2022.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-006", category: "requisition", name: "REQ-03 — November 2022", date: "2022-11-30", description: "Third requisition. Includes early-stage subcontractor invoices.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-007", category: "requisition", name: "REQ-04 — December 2022", date: "2022-12-31", description: "Fourth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-008", category: "requisition", name: "REQ-05 — January 2023", date: "2023-01-31", description: "Fifth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-009", category: "requisition", name: "REQ-06 — February 2023", date: "2023-02-28", description: "Sixth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-010", category: "requisition", name: "REQ-07 — March 2023", date: "2023-03-31", description: "Seventh requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-011", category: "requisition", name: "REQ-08 — April 2023", date: "2023-04-30", description: "Eighth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-012", category: "requisition", name: "REQ-09 — May 2023", date: "2023-05-31", description: "Ninth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-013", category: "requisition", name: "REQ-10 — June 2023", date: "2023-06-30", description: "Tenth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-014", category: "requisition", name: "REQ-11 — July 2023", date: "2023-07-31", description: "Eleventh requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-015", category: "requisition", name: "REQ-12 — August 2023", date: "2023-08-31", description: "Twelfth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-016", category: "requisition", name: "REQ-13 — September 2023", date: "2023-09-30", description: "Thirteenth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-017", category: "requisition", name: "REQ-14 — October 2023", date: "2023-10-31", description: "Fourteenth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-018", category: "requisition", name: "REQ-15 — November 2023", date: "2023-11-30", description: "Fifteenth requisition.", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-018b", category: "requisition", name: "REQ-16 — January 2024", date: "2024-01-30", description: "Sixteenth requisition. Largest single requisition at $235,461. Project over-billed by $53,162. Multiple lines over budget (Insulation 200%, Custom Casework 155%, Framing Material 165%).", parties: "MC", status: "submitted", notes: "" },
  { id: "doc-019", category: "arbitration", name: "AAA Demand for Arbitration", date: "2024-01-15", description: "Filed under AAA Case No. 01-24-0004-6683. Construction Industry Arbitration Rules.", parties: "MC / Tharp", status: "filed", notes: "" },
  { id: "doc-020", category: "arbitration", name: "Arbitrator Appointment — Robin S. Abramowitz", date: "2024-03-01", description: "AAA Construction Panel arbitrator assigned. Bond, Schoeneck & King PLLC.", parties: "AAA", status: "confirmed", notes: "" },
  { id: "doc-021", category: "correspondence", name: "Owner Punch List / Deficiency Claims", date: "2023-12-01", description: "Owner's list of alleged construction deficiencies including fireplace, air returns, and misc items.", parties: "Tharp", status: "received", notes: "" },
  { id: "doc-022", category: "change_order", name: "Change Order Log — Summary", date: "2023-11-30", description: "Summary of all change orders issued during the project. Includes approved, pending, and disputed COs.", parties: "MC / Tharp", status: "active", notes: "" },
  { id: "doc-023", category: "invoice", name: "Korth Plumbing Invoice Package", date: "2023-09-15", description: "Korth plumbing invoices — subject to overbilling dispute. Owner alleges duplicate / inflated charges.", parties: "Korth / MC", status: "disputed", notes: "" },
];

function Documents({ docs, updateDoc, addDoc, removeDoc }) {
  const [filter, setFilter] = useState("all");
  const [tagFilter, setTagFilter] = useState(null);
  const [sel, setSel] = useState(null);
  const [adding, setAdding] = useState(false);
  const [newDoc, setNewDoc] = useState({ category: "other", name: "", date: "", description: "", parties: "", status: "draft", notes: "" });
  const [search, setSearch] = useState("");
  const [dragOver, setDragOver] = useState(false);
  const [uploading, setUploading] = useState([]); // [{name, progress, status}]
  const [uploadSummary, setUploadSummary] = useState(null);
  const [newTag, setNewTag] = useState("");
  const [previewUrl, setPreviewUrl] = useState(null);

  const filtered = docs.filter(d => {
    if (filter !== "all" && d.category !== filter) return false;
    if (tagFilter && !(d.tags || []).includes(tagFilter)) return false;
    if (search) {
      const q = search.toLowerCase();
      return d.name.toLowerCase().includes(q)
        || (d.description || "").toLowerCase().includes(q)
        || (d.notes || "").toLowerCase().includes(q)
        || (d.extractedText || "").toLowerCase().includes(q)
        || (d.tags || []).some(t => t.toLowerCase().includes(q))
        || (d.vendor || "").toLowerCase().includes(q)
        || (d.costCode || "").toLowerCase().includes(q)
        || (d.fileName || "").toLowerCase().includes(q);
    }
    return true;
  });

  const editing = sel ? docs.find(d => d.id === sel) : null;
  const catCounts = DOC_CATEGORIES.map(c => ({ ...c, count: docs.filter(d => d.category === c.id).length }));

  // Collect all unique tags across docs
  const allTags = [...new Set(docs.flatMap(d => d.tags || []))].sort();
  const uploadedCount = docs.filter(d => d.storagePath).length;

  const ThStyle = { padding: "10px 14px", textAlign: "left", fontSize: 11, fontWeight: 600, letterSpacing: 0.5, color: T.textMuted, fontFamily: T.font, borderBottom: `1px solid ${T.border}`, background: T.bg };
  const TdStyle = { padding: "10px 14px", fontSize: 13, fontFamily: T.font, color: T.text, borderBottom: `1px solid ${T.border}` };

  const catInfo = (catId) => DOC_CATEGORIES.find(c => c.id === catId) || DOC_CATEGORIES[DOC_CATEGORIES.length - 1];

  const handleAdd = () => {
    const id = "doc-" + String(docs.length + 1).padStart(3, "0") + "-" + Date.now().toString(36);
    addDoc({ ...newDoc, id, tags: [], linkedReqs: [], storagePath: null, fileName: null, fileSize: 0, mimeType: null, extractedText: null, vendor: null, costCode: null });
    setNewDoc({ category: "other", name: "", date: "", description: "", parties: "", status: "draft", notes: "" });
    setAdding(false);
  };

  // ── File Upload Handler ──
  const processFiles = async (files) => {
    if (!files || files.length === 0) return;
    if (!window._sb) {
      alert("File upload requires cloud mode (Supabase). The app is currently in local-only mode.");
      return;
    }

    const fileArr = Array.from(files);
    const summary = { total: fileArr.length, uploaded: 0, categorized: 0, tagged: 0 };
    setUploading(fileArr.map(f => ({ name: f.name, progress: 0, status: "pending" })));

    for (let i = 0; i < fileArr.length; i++) {
      const file = fileArr[i];
      setUploading(prev => prev.map((u, j) => j === i ? { ...u, status: "uploading", progress: 30 } : u));

      // Build storage path: category/filename (sanitized)
      const classify = autoClassifyFile(file.name);
      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
      const storagePath = classify.category + "/" + Date.now() + "-" + safeName;

      // Upload to Supabase Storage
      const path = await fileUpload(file, storagePath);
      if (!path) {
        setUploading(prev => prev.map((u, j) => j === i ? { ...u, status: "error", progress: 100 } : u));
        continue;
      }

      setUploading(prev => prev.map((u, j) => j === i ? { ...u, progress: 60, status: "parsing" } : u));

      // Parse file content for text extraction
      let extractedText = null;
      let textTags = [];
      const mime = file.type || "";
      if (mime === "application/pdf") {
        const url = fileGetUrl(path);
        if (url) extractedText = await extractPdfText(url);
      } else if (mime.includes("sheet") || mime.includes("excel") || file.name.match(/\.xlsx?$/i)) {
        extractedText = await extractXlsxData(file);
      }
      if (extractedText) {
        textTags = extractTagsFromText(extractedText);
      }

      // Merge filename tags + text-extracted tags
      const allFileTags = [...new Set([...classify.tags, ...textTags])];
      const allLinkedReqs = [...new Set([...classify.linkedReqs, ...textTags.filter(t => t.match(/^REQ-\d{2}$/))])];

      setUploading(prev => prev.map((u, j) => j === i ? { ...u, progress: 90, status: "saving" } : u));

      // Create document record
      const id = "doc-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 6);
      const newDocRecord = {
        id,
        category: classify.category,
        name: file.name.replace(/\.[^.]+$/, "").replace(/[_-]/g, " "),
        date: new Date().toISOString().slice(0, 10),
        description: classify.vendor ? `${classify.vendor} — auto-imported` : "Auto-imported",
        parties: classify.vendor || "",
        status: classify.status || "received",
        notes: "",
        storagePath: path,
        fileName: file.name,
        fileSize: file.size,
        mimeType: mime,
        tags: allFileTags,
        linkedReqs: allLinkedReqs,
        extractedText: extractedText,
        vendor: classify.vendor,
        costCode: classify.costCode,
      };

      addDoc(newDocRecord);
      summary.uploaded++;
      if (classify.category !== "other") summary.categorized++;
      if (allFileTags.length > 0) summary.tagged++;

      // AI auto-analysis (non-blocking)
      if (window._openaiKey && extractedText) {
        analyzeUploadedDoc(newDocRecord, extractedText, docs)
          .then(aiUpdates => { if (aiUpdates) updateDoc(id, aiUpdates); })
          .catch(err => console.warn("[AI] Upload analysis failed:", err.message));
      }

      setUploading(prev => prev.map((u, j) => j === i ? { ...u, progress: 100, status: "done" } : u));
    }

    setUploadSummary(summary);
    setTimeout(() => { setUploading([]); }, 3000);
    setTimeout(() => { setUploadSummary(null); }, 8000);
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    processFiles(e.dataTransfer.files);
  };

  const handleFileInput = (e) => {
    processFiles(e.target.files);
    e.target.value = "";
  };

  // Tag management
  const addTag = (docId, tag) => {
    const doc = docs.find(d => d.id === docId);
    if (!doc || !tag.trim()) return;
    const tags = [...(doc.tags || [])];
    if (!tags.includes(tag.trim())) tags.push(tag.trim());
    updateDoc(docId, { tags });
  };

  const removeTag = (docId, tag) => {
    const doc = docs.find(d => d.id === docId);
    if (!doc) return;
    updateDoc(docId, { tags: (doc.tags || []).filter(t => t !== tag) });
  };

  // Open file preview
  const openFile = (doc) => {
    if (!doc.storagePath) return;
    const url = fileGetUrl(doc.storagePath);
    if (url) window.open(url, "_blank");
  };

  return (
    <div style={{ display: "grid", gridTemplateColumns: editing || adding ? "1fr 420px" : "1fr", gap: 20, alignItems: "start" }}>
      <div>
        <SectionTitle title="Documents" subtitle={`${docs.length} documents · ${uploadedCount} with files · ${allTags.length} unique tags`} />

        {/* Upload Zone */}
        <div
          onDragOver={e => { e.preventDefault(); setDragOver(true); }}
          onDragLeave={() => setDragOver(false)}
          onDrop={handleDrop}
          style={{
            border: `2px dashed ${dragOver ? T.accent : T.border}`,
            borderRadius: 12,
            padding: uploading.length > 0 ? "12px 20px" : "24px 20px",
            marginBottom: 16,
            textAlign: "center",
            background: dragOver ? T.accentBg : T.surface,
            transition: "all 0.2s",
            cursor: "pointer",
          }}
          onClick={() => { if (uploading.length === 0) document.getElementById("doc-file-input")?.click(); }}
        >
          {uploading.length === 0 ? (
            <div>
              <div style={{ marginBottom: 8 }}><Ic name="upload" size={28} color={T.textMuted} /></div>
              <div style={{ fontSize: 13, fontWeight: 500, color: T.text, fontFamily: T.font }}>
                Drop files here to upload, or <span style={{ color: T.accent, textDecoration: "underline" }}>browse</span>
              </div>
              <div style={{ fontSize: 11, color: T.textMuted, marginTop: 4, fontFamily: T.font }}>
                PDF, XLSX, images, and other documents · Auto-categorizes and extracts tags
              </div>
              <input id="doc-file-input" type="file" multiple style={{ display: "none" }} onChange={handleFileInput} />
            </div>
          ) : (
            <div style={{ textAlign: "left" }}>
              {uploading.map((u, i) => (
                <div key={i} style={{ display: "flex", alignItems: "center", gap: 10, padding: "4px 0" }}>
                  <span style={{ fontSize: 12, fontFamily: T.font, color: T.textMid, flex: 1, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{u.name}</span>
                  <div style={{ width: 100, height: 4, borderRadius: 2, background: T.border, flexShrink: 0 }}>
                    <div style={{ width: u.progress + "%", height: "100%", borderRadius: 2, background: u.status === "error" ? T.red : u.status === "done" ? T.green : T.accent, transition: "width 0.3s" }} />
                  </div>
                  <span style={{ fontSize: 10, color: u.status === "error" ? T.red : u.status === "done" ? T.green : T.textMuted, fontFamily: T.font, width: 60, textAlign: "right" }}>
                    {u.status === "error" ? "Failed" : u.status === "done" ? "Done" : u.status === "parsing" ? "Parsing…" : u.status === "saving" ? "Saving…" : "Uploading…"}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Upload Summary Banner */}
        {uploadSummary && (
          <div style={{ padding: "10px 16px", borderRadius: 8, background: T.greenBg, border: `1px solid ${T.green}22`, marginBottom: 16, display: "flex", gap: 16, alignItems: "center" }}>
            <span style={{ fontSize: 18 }}>✅</span>
            <span style={{ fontSize: 12, fontFamily: T.font, color: T.green }}>
              <strong>{uploadSummary.uploaded}</strong> of {uploadSummary.total} files uploaded · <strong>{uploadSummary.categorized}</strong> auto-categorized · <strong>{uploadSummary.tagged}</strong> tagged
            </span>
          </div>
        )}

        {/* Category Chips */}
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 10 }}>
          <button onClick={() => { setFilter("all"); setTagFilter(null); }} style={{
            padding: "6px 14px", borderRadius: 20, cursor: "pointer", fontFamily: T.font, fontSize: 12, fontWeight: 500,
            border: `1.5px solid ${filter === "all" && !tagFilter ? T.accent : T.border}`,
            background: filter === "all" && !tagFilter ? T.accentBg : T.surface,
            color: filter === "all" && !tagFilter ? T.accent : T.textMid,
          }}>All ({docs.length})</button>
          {catCounts.filter(c => c.count > 0).map(c => (
            <button key={c.id} onClick={() => { setFilter(c.id); setTagFilter(null); }} style={{
              padding: "6px 14px", borderRadius: 20, cursor: "pointer", fontFamily: T.font, fontSize: 12, fontWeight: 500,
              border: `1.5px solid ${filter === c.id ? c.color : T.border}`,
              background: filter === c.id ? (c.color + "12") : T.surface,
              color: filter === c.id ? c.color : T.textMid,
            }}><Ic name={c.ic} size={13} color={filter === c.id ? c.color : T.textMid} style={{ marginRight: 5 }} />{c.label} ({c.count})</button>
          ))}
        </div>

        {/* Tag Filter Chips (top 20 most common) */}
        {allTags.length > 0 && (
          <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 16 }}>
            <span style={{ fontSize: 10, color: T.textMuted, fontFamily: T.font, padding: "4px 6px" }}>Tags:</span>
            {allTags.slice(0, 20).map(tag => (
              <button key={tag} onClick={() => { setTagFilter(tagFilter === tag ? null : tag); setFilter("all"); }} style={{
                padding: "3px 10px", borderRadius: 12, cursor: "pointer", fontFamily: T.font, fontSize: 10, fontWeight: 500,
                border: `1px solid ${tagFilter === tag ? T.accent : T.border}`,
                background: tagFilter === tag ? T.accentBg : T.bg,
                color: tagFilter === tag ? T.accent : T.textMid,
              }}>{tag}</button>
            ))}
          </div>
        )}

        {/* Search + Add */}
        <div style={{ display: "flex", gap: 10, marginBottom: 16 }}>
          <input type="text" placeholder="Search documents, tags, extracted text..." value={search} onChange={e => setSearch(e.target.value)}
            style={{ flex: 1, padding: "8px 14px", borderRadius: 8, border: `1px solid ${T.border}`, fontSize: 13, fontFamily: T.font, color: T.text, background: T.surface }} />
          <button onClick={() => { setAdding(true); setSel(null); }} style={{
            padding: "8px 18px", borderRadius: 8, cursor: "pointer", fontFamily: T.font, fontSize: 12, fontWeight: 600,
            border: "none", background: T.accent, color: "#fff",
          }}>+ Add Document</button>
        </div>

        {/* Document Table */}
        <Card padding={0}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr>
                {["", "Document Name", "Tags", "Date", "File", "Status"].map(h => (
                  <th key={h} style={ThStyle}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {filtered.map(doc => {
                const cat = catInfo(doc.category);
                const active = sel === doc.id;
                const hasFile = !!doc.storagePath;
                return (
                  <tr key={doc.id} onClick={() => { setSel(active ? null : doc.id); setAdding(false); }}
                    style={{ cursor: "pointer", background: active ? T.accentBg : "transparent", transition: "background 0.1s" }}
                    onMouseEnter={e => { if (!active) e.currentTarget.style.background = T.surfaceHover; }}
                    onMouseLeave={e => { if (!active) e.currentTarget.style.background = "transparent"; }}>
                    <td style={{ ...TdStyle, width: 36, textAlign: "center" }}>{hasFile ? getMimeIcon(doc.mimeType, 18, cat.color) : <Ic name={cat.ic} size={18} color={cat.color} />}</td>
                    <td style={TdStyle}>
                      <div style={{ fontWeight: 500 }}>{doc.name}</div>
                      <div style={{ fontSize: 11, color: T.textMuted, marginTop: 2 }}>
                        {doc.description}
                        {doc.vendor && <span style={{ marginLeft: 6, color: T.accent }}>· {doc.vendor}</span>}
                      </div>
                    </td>
                    <td style={{ ...TdStyle, maxWidth: 180 }}>
                      <div style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>
                        {(doc.tags || []).slice(0, 4).map(tag => (
                          <span key={tag} style={{
                            display: "inline-block", padding: "2px 7px", borderRadius: 8, fontSize: 9, fontWeight: 500, fontFamily: T.font,
                            background: tag.match(/^REQ-/) ? T.blueBg : tag.match(/^\$/) ? T.amberBg : T.bg,
                            color: tag.match(/^REQ-/) ? T.blue : tag.match(/^\$/) ? T.amber : T.textMid,
                            border: `1px solid ${tag.match(/^REQ-/) ? T.blueBorder : tag.match(/^\$/) ? T.amberBorder : T.border}`,
                          }}>{tag}</span>
                        ))}
                        {(doc.tags || []).length > 4 && (
                          <span style={{ fontSize: 9, color: T.textMuted, padding: "2px 4px" }}>+{(doc.tags || []).length - 4}</span>
                        )}
                      </div>
                    </td>
                    <td style={{ ...TdStyle, fontFamily: T.mono, fontSize: 12, whiteSpace: "nowrap" }}>{doc.date}</td>
                    <td style={{ ...TdStyle, fontSize: 11 }}>
                      {hasFile ? (
                        <div>
                          <div style={{ color: T.green, fontWeight: 500 }}>{formatFileSize(doc.fileSize)}</div>
                          <div style={{ fontSize: 9, color: T.textMuted }}>{(doc.fileName || "").split(".").pop()?.toUpperCase()}</div>
                        </div>
                      ) : (
                        <span style={{ color: T.textMuted }}>—</span>
                      )}
                    </td>
                    <td style={TdStyle}>
                      <span style={{
                        display: "inline-block", padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 600, fontFamily: T.font,
                        background: doc.status === "final" || doc.status === "confirmed" ? T.greenBg : doc.status === "disputed" ? T.redBg : doc.status === "filed" || doc.status === "submitted" ? T.blueBg : T.bg,
                        color: doc.status === "final" || doc.status === "confirmed" ? T.green : doc.status === "disputed" ? T.red : doc.status === "filed" || doc.status === "submitted" ? T.blue : T.textMid,
                      }}>{doc.status}</span>
                    </td>
                  </tr>
                );
              })}
              {filtered.length === 0 && (
                <tr><td colSpan={6} style={{ ...TdStyle, textAlign: "center", color: T.textMuted, padding: 40 }}>No documents match your filter</td></tr>
              )}
            </tbody>
          </table>
        </Card>
      </div>

      {/* Edit Sidebar */}
      {editing && (
        <div style={{ position: "sticky", top: 16 }}>
          <Card>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
              <CardLabel label="Edit Document" />
              <button onClick={() => setSel(null)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 18, color: T.textMuted, lineHeight: 1 }}>×</button>
            </div>

            {/* File info / actions */}
            {editing.storagePath && (
              <div style={{ marginBottom: 14, padding: "10px 12px", borderRadius: 8, background: T.bg, border: `1px solid ${T.border}` }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                  <span>{getMimeIcon(editing.mimeType, 20, T.accent)}</span>
                  <div style={{ flex: 1, overflow: "hidden" }}>
                    <div style={{ fontSize: 12, fontWeight: 500, fontFamily: T.font, color: T.text, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{editing.fileName}</div>
                    <div style={{ fontSize: 10, color: T.textMuted, fontFamily: T.font }}>{formatFileSize(editing.fileSize)} · {(editing.mimeType || "unknown").split("/").pop()}</div>
                  </div>
                </div>
                <div style={{ display: "flex", gap: 6 }}>
                  <button onClick={() => openFile(editing)} style={{
                    flex: 1, padding: "6px", borderRadius: 6, cursor: "pointer", fontFamily: T.font, fontSize: 11, fontWeight: 500,
                    border: `1px solid ${T.border}`, background: T.surface, color: T.accent,
                  }}>View File</button>
                  <button onClick={async () => {
                    if (confirm("Remove file from storage? The document record will remain.")) {
                      await fileDelete(editing.storagePath);
                      updateDoc(editing.id, { storagePath: null, fileName: null, fileSize: 0, mimeType: null });
                    }
                  }} style={{
                    padding: "6px 10px", borderRadius: 6, cursor: "pointer", fontFamily: T.font, fontSize: 11, fontWeight: 500,
                    border: `1px solid ${T.redBorder}`, background: T.redBg, color: T.red,
                  }}>Delete File</button>
                </div>
              </div>
            )}

            {/* Inline preview for images */}
            {editing.storagePath && editing.mimeType && editing.mimeType.startsWith("image/") && (
              <div style={{ marginBottom: 14, borderRadius: 8, overflow: "hidden", border: `1px solid ${T.border}` }}>
                <img src={fileGetUrl(editing.storagePath)} alt={editing.name} style={{ width: "100%", height: "auto", display: "block" }} />
              </div>
            )}

            {/* Tags */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 6, fontFamily: T.font }}>Tags</label>
              <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 6 }}>
                {(editing.tags || []).map(tag => (
                  <span key={tag} style={{
                    display: "inline-flex", alignItems: "center", gap: 4, padding: "3px 8px", borderRadius: 10, fontSize: 11, fontWeight: 500, fontFamily: T.font,
                    background: tag.match(/^REQ-/) ? T.blueBg : tag.match(/^\$/) ? T.amberBg : T.bg,
                    color: tag.match(/^REQ-/) ? T.blue : tag.match(/^\$/) ? T.amber : T.textMid,
                    border: `1px solid ${tag.match(/^REQ-/) ? T.blueBorder : tag.match(/^\$/) ? T.amberBorder : T.border}`,
                  }}>
                    {tag}
                    <span onClick={(e) => { e.stopPropagation(); removeTag(editing.id, tag); }} style={{ cursor: "pointer", fontSize: 13, lineHeight: 1, opacity: 0.6 }}>×</span>
                  </span>
                ))}
                {(editing.tags || []).length === 0 && <span style={{ fontSize: 11, color: T.textMuted, fontFamily: T.font }}>No tags</span>}
              </div>
              <div style={{ display: "flex", gap: 4 }}>
                <input type="text" placeholder="Add tag…" value={newTag} onChange={e => setNewTag(e.target.value)}
                  onKeyDown={e => { if (e.key === "Enter" && newTag.trim()) { addTag(editing.id, newTag); setNewTag(""); } }}
                  style={{ flex: 1, padding: "5px 8px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 11, fontFamily: T.font, color: T.text, background: T.surface }} />
                <button onClick={() => { if (newTag.trim()) { addTag(editing.id, newTag); setNewTag(""); } }} style={{
                  padding: "5px 10px", borderRadius: 6, cursor: "pointer", fontFamily: T.font, fontSize: 11, fontWeight: 500,
                  border: `1px solid ${T.border}`, background: T.surface, color: T.accent,
                }}>+</button>
              </div>
            </div>

            {/* Linked REQs */}
            {(editing.linkedReqs || []).length > 0 && (
              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Linked Requisitions</label>
                <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                  {(editing.linkedReqs || []).map(req => (
                    <span key={req} style={{
                      display: "inline-block", padding: "3px 10px", borderRadius: 10, fontSize: 11, fontWeight: 600, fontFamily: T.font,
                      background: T.blueBg, color: T.blue, border: `1px solid ${T.blueBorder}`,
                    }}>{req}</span>
                  ))}
                </div>
              </div>
            )}

            {/* Cost Code / Vendor */}
            {(editing.costCode || editing.vendor) && (
              <div style={{ marginBottom: 14, display: "flex", gap: 10 }}>
                {editing.vendor && (
                  <div style={{ flex: 1 }}>
                    <label style={{ display: "block", fontSize: 10, fontWeight: 600, color: T.textMuted, letterSpacing: 0.4, marginBottom: 2, fontFamily: T.font }}>VENDOR</label>
                    <div style={{ fontSize: 12, fontFamily: T.font, color: T.text }}>{editing.vendor}</div>
                  </div>
                )}
                {editing.costCode && (
                  <div style={{ flex: 1 }}>
                    <label style={{ display: "block", fontSize: 10, fontWeight: 600, color: T.textMuted, letterSpacing: 0.4, marginBottom: 2, fontFamily: T.font }}>COST CODE</label>
                    <div style={{ fontSize: 12, fontFamily: T.font, color: T.text }}>{editing.costCode}</div>
                  </div>
                )}
              </div>
            )}

            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Category</label>
              <select value={editing.category} onChange={e => updateDoc(editing.id, { category: e.target.value })}
                style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 12, fontFamily: T.font, color: T.text, background: T.surface }}>
                {DOC_CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
              </select>
            </div>
            <TextInput label="Document Name" value={editing.name} onChange={v => updateDoc(editing.id, { name: v })} />
            <TextInput label="Date" value={editing.date} onChange={v => updateDoc(editing.id, { date: v })} />
            <TextInput label="Parties" value={editing.parties} onChange={v => updateDoc(editing.id, { parties: v })} />
            <TextInput label="Description" value={editing.description} onChange={v => updateDoc(editing.id, { description: v })} />
            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Status</label>
              <select value={editing.status} onChange={e => updateDoc(editing.id, { status: e.target.value })}
                style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 12, fontFamily: T.font, color: T.text, background: T.surface }}>
                {["draft", "submitted", "received", "filed", "confirmed", "active", "disputed", "final"].map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Notes</label>
              <textarea value={editing.notes || ""} onChange={e => updateDoc(editing.id, { notes: e.target.value })}
                rows={3} style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 12, fontFamily: T.font, color: T.text, background: T.surface, resize: "vertical" }} />
            </div>

            {/* Extracted Text Preview */}
            {editing.extractedText && (
              <div style={{ marginBottom: 12 }}>
                <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Extracted Text (preview)</label>
                <div style={{ padding: "8px 10px", borderRadius: 6, border: `1px solid ${T.border}`, background: T.bg, fontSize: 10, fontFamily: T.mono, color: T.textMid, maxHeight: 120, overflow: "auto", whiteSpace: "pre-wrap", lineHeight: 1.4 }}>
                  {editing.extractedText.slice(0, 500)}{editing.extractedText.length > 500 ? "…" : ""}
                </div>
              </div>
            )}

            {/* Delete Document */}
            <button onClick={async () => {
              if (confirm("Delete this document record" + (editing.storagePath ? " and its uploaded file" : "") + "?")) {
                if (editing.storagePath) await fileDelete(editing.storagePath);
                removeDoc(editing.id);
                setSel(null);
              }
            }} style={{
              width: "100%", padding: "8px", borderRadius: 6, cursor: "pointer", fontFamily: T.font, fontSize: 11, fontWeight: 500,
              border: `1px solid ${T.redBorder}`, background: T.redBg, color: T.red, marginTop: 8,
            }}>Delete Document</button>
          </Card>
        </div>
      )}

      {/* Add Sidebar */}
      {adding && (
        <div style={{ position: "sticky", top: 16 }}>
          <Card>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
              <CardLabel label="Add New Document" />
              <button onClick={() => setAdding(false)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 18, color: T.textMuted, lineHeight: 1 }}>×</button>
            </div>
            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Category</label>
              <select value={newDoc.category} onChange={e => setNewDoc(prev => ({ ...prev, category: e.target.value }))}
                style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 12, fontFamily: T.font, color: T.text, background: T.surface }}>
                {DOC_CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
              </select>
            </div>
            <TextInput label="Document Name *" value={newDoc.name} onChange={v => setNewDoc(prev => ({ ...prev, name: v }))} />
            <TextInput label="Date" value={newDoc.date} onChange={v => setNewDoc(prev => ({ ...prev, date: v }))} />
            <TextInput label="Parties" value={newDoc.parties} onChange={v => setNewDoc(prev => ({ ...prev, parties: v }))} />
            <TextInput label="Description" value={newDoc.description} onChange={v => setNewDoc(prev => ({ ...prev, description: v }))} />
            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Status</label>
              <select value={newDoc.status} onChange={e => setNewDoc(prev => ({ ...prev, status: e.target.value }))}
                style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 12, fontFamily: T.font, color: T.text, background: T.surface }}>
                {["draft", "submitted", "received", "filed", "confirmed", "active", "disputed", "final"].map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div style={{ marginBottom: 12 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, letterSpacing: 0.4, marginBottom: 4, fontFamily: T.font }}>Notes</label>
              <textarea value={newDoc.notes} onChange={e => setNewDoc(prev => ({ ...prev, notes: e.target.value }))}
                rows={3} style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 12, fontFamily: T.font, color: T.text, background: T.surface, resize: "vertical" }} />
            </div>
            <button onClick={handleAdd} disabled={!newDoc.name.trim()} style={{
              width: "100%", padding: "10px", borderRadius: 8, cursor: newDoc.name.trim() ? "pointer" : "default", fontFamily: T.font, fontSize: 13, fontWeight: 600,
              border: "none", background: newDoc.name.trim() ? T.accent : T.border, color: newDoc.name.trim() ? "#fff" : T.textMuted,
            }}>Add Document</button>
          </Card>
        </div>
      )}
    </div>
  );
}

// ── AI ASSISTANT ─────────────────────────────────────────────────────────────
const fmtDollar = n => "$" + (n || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });

const AI_TOOLS = [
  { type: "function", function: {
    name: "navigate_tab",
    description: "Switch the app to a specific tab/view.",
    parameters: { type: "object", properties: {
      tab: { type: "string", enum: ["dashboard","requisitions","reconciliation","audit","claims","documents","simulator","strategy"], description: "Tab to navigate to" }
    }, required: ["tab"] }
  }},
  { type: "function", function: {
    name: "update_requisition",
    description: "Update fields on a requisition (REQ-01 through REQ-16). Can update amounts, backup status, notes, documentation flags.",
    parameters: { type: "object", properties: {
      reqId: { type: "integer", description: "Requisition ID (1-16)", minimum: 1, maximum: 16 },
      updates: { type: "object", properties: {
        totalBilled: { type: "number" }, retainageHeld: { type: "number" },
        laborCost: { type: "number" }, materialCost: { type: "number" }, subCost: { type: "number" },
        laborRate: { type: "number" }, backupStatus: { type: "string", enum: ["COMPLETE","PARTIAL","MISSING"] },
        hasPayrollSupport: { type: "boolean" }, hasInvoiceSupport: { type: "boolean" }, hasCheckVouchers: { type: "boolean" },
        notes: { type: "string" }, date: { type: "string" }
      }}
    }, required: ["reqId","updates"] }
  }},
  { type: "function", function: {
    name: "flag_requisition",
    description: "Add or remove an audit flag on a requisition. Flags: blended_rate, sub_as_labor, overhead_as_material, missing_invoice, markup_on_markup, duplicate, no_timesheet, rate_anomaly, no_scope_desc, owner_supplied, co_missing, retainage_error",
    parameters: { type: "object", properties: {
      reqId: { type: "integer", description: "Requisition ID (1-16)", minimum: 1, maximum: 16 },
      flag: { type: "string", enum: ["blended_rate","sub_as_labor","overhead_as_material","missing_invoice","markup_on_markup","duplicate","no_timesheet","rate_anomaly","no_scope_desc","owner_supplied","co_missing","retainage_error"] },
      action: { type: "string", enum: ["add","remove"] }
    }, required: ["reqId","flag","action"] }
  }},
  { type: "function", function: {
    name: "update_claim",
    description: "Update an owner claim (1-24). Can change status, strength, defense text, amounts.",
    parameters: { type: "object", properties: {
      claimId: { type: "integer", description: "Claim ID (1-24)", minimum: 1, maximum: 24 },
      updates: { type: "object", properties: {
        status: { type: "string", enum: ["DISPUTED","AGREED","WAIVED","PENDING"] },
        strength: { type: "string", enum: ["STRONG","MODERATE","WEAK","N/A"] },
        defense: { type: "string" }, ownerAmount: { type: "number" }, agreedAmount: { type: "number" }
      }}
    }, required: ["claimId","updates"] }
  }},
  { type: "function", function: {
    name: "add_document",
    description: "Create a new document record in the system.",
    parameters: { type: "object", properties: {
      name: { type: "string" },
      category: { type: "string", enum: ["contract","requisition","change_order","correspondence","invoice","inspection","photo","arbitration","other"] },
      date: { type: "string" }, description: { type: "string" }, parties: { type: "string" },
      status: { type: "string", enum: ["draft","submitted","received","filed","confirmed","active","disputed","final"] },
      tags: { type: "array", items: { type: "string" } },
      linkedReqs: { type: "array", items: { type: "string" } }, notes: { type: "string" }
    }, required: ["name","category"] }
  }},
  { type: "function", function: {
    name: "update_document",
    description: "Update fields on an existing document by its ID.",
    parameters: { type: "object", properties: {
      docId: { type: "string", description: "Document ID" },
      updates: { type: "object", properties: {
        category: { type: "string", enum: ["contract","requisition","change_order","correspondence","invoice","inspection","photo","arbitration","other"] },
        name: { type: "string" }, description: { type: "string" },
        status: { type: "string", enum: ["draft","submitted","received","filed","confirmed","active","disputed","final"] },
        tags: { type: "array", items: { type: "string" } },
        linkedReqs: { type: "array", items: { type: "string" } },
        notes: { type: "string" }, parties: { type: "string" }, vendor: { type: "string" }, costCode: { type: "string" }
      }}
    }, required: ["docId","updates"] }
  }},
  { type: "function", function: {
    name: "search_documents",
    description: "Search documents by text. Searches name, description, tags, extracted text, vendor, notes.",
    parameters: { type: "object", properties: {
      query: { type: "string" },
      category: { type: "string", enum: ["contract","requisition","change_order","correspondence","invoice","inspection","photo","arbitration","other"] }
    }, required: ["query"] }
  }},
  { type: "function", function: {
    name: "analyze_document",
    description: "Retrieve a document's metadata and extracted text for analysis.",
    parameters: { type: "object", properties: {
      docId: { type: "string" }
    }, required: ["docId"] }
  }},
  { type: "function", function: {
    name: "case_summary",
    description: "Generate a summary of the case status — financials, risk, claims, documents.",
    parameters: { type: "object", properties: {
      focus: { type: "string", enum: ["financial","risk","claims","documents","full"], description: "Aspect to focus on (default: full)" }
    }}
  }}
];

function buildSystemPrompt(tab, reqs, claims, docs) {
  const totalBilled = reqs.reduce((s, r) => s + (r.totalBilled || 0), 0);
  const totalExcel = reqs.reduce((s, r) => s + (r.excelTotal || 0), 0);
  const highRisk = reqs.filter(r => computeRisk(r) === "HIGH").length;
  const totalOwner = claims.reduce((s, c) => s + c.ownerAmount, 0);
  const totalAgreed = claims.reduce((s, c) => s + c.agreedAmount, 0);
  const disputed = claims.filter(c => c.status === "DISPUTED").length;
  const uploadedDocs = docs.filter(d => d.storagePath).length;

  return `You are an AI assistant for the Tharp Case Manager — a construction litigation tool for Montana Contracting Corp v. Tharp/Bumgardner (AAA Case No. 01-24-0004-6683).

CASE: Residential renovation at 515 N. Midland Ave, Upper Nyack NY. AIA A110-2021 (Cost of Work + 25% OH&P). Arbitrator: Robin S. Abramowitz.
MC (contractor, our client) billed ${fmtDollar(totalBilled)} across 16 requisitions. Excel tracker total: ${fmtDollar(totalExcel)}.
${highRisk} requisitions flagged HIGH RISK. Owners made 24 claims totaling ${fmtDollar(totalOwner)}; MC agreed to ${fmtDollar(totalAgreed)} in credits. ${disputed} claims DISPUTED.
${docs.length} documents (${uploadedDocs} with files). Currently viewing: "${tab}" tab.

KEY FACTS:
- REQ-16 (Jan 2024) is the FINAL INVOICE. Largest single requisition at $235,461.
- Project is OVER-BILLED by $53,162 (total completed $1,839,331 vs contract sum $1,786,169 = 102.97%).
- $135,385 in unapplied credit COs remain at 0% across REQ-15 and REQ-16 (PCO#130 $66,389, PCO#129 $24,248, plus 5 others).
- 10+ G703 lines over budget: Insulation 200%, Custom Casework 155%, Framing Material 165%.
- Zero employee timecards across all 16 requisitions.

RULES:
1. Map "REQ-3", "req 3", "#3" etc. to the correct reqId (1-16). REQ-16 is the final invoice.
2. Match claims by description keywords or ID number.
3. Be concise — this is legal case management, precision over verbosity.
4. Execute multiple tool calls when needed.
5. After actions, briefly confirm what you did.`;
}

function buildContextHints(msg, reqs, claims, docs) {
  const hints = [];
  const reqRefs = msg.match(/req[quistion]*[- _#.]?(\d{1,2})/gi);
  if (reqRefs) {
    reqRefs.forEach(ref => {
      const num = parseInt(ref.match(/(\d{1,2})/)[1]);
      const req = reqs.find(r => r.id === num);
      if (req) hints.push(`[REQ-${String(num).padStart(2,"0")}: billed=${fmtDollar(req.totalBilled)}, flags=[${req.flags.join(",")}], backup=${req.backupStatus}]`);
    });
  }
  const claimRefs = msg.match(/claim[- #]?(\d{1,2})/gi);
  if (claimRefs) {
    claimRefs.forEach(ref => {
      const num = parseInt(ref.match(/(\d{1,2})/)[1]);
      const claim = claims.find(c => c.id === num);
      if (claim) hints.push(`[Claim #${num}: "${claim.description}", status=${claim.status}, owner=${fmtDollar(claim.ownerAmount)}]`);
    });
  }
  return hints.length > 0 ? "\n\nREFERENCED DATA:\n" + hints.join("\n") : "";
}

async function callOpenAI(messages, tools, systemPrompt) {
  const apiKey = window._openaiKey;
  if (!apiKey) throw new Error("OpenAI API key not configured. Add your key to supabase-config.json and rebuild.");
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
    body: JSON.stringify({
      model: "gpt-4o", messages: [{ role: "system", content: systemPrompt }, ...messages],
      tools, tool_choice: "auto", temperature: 0.3, max_tokens: 1024
    })
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || "OpenAI API error " + res.status);
  }
  return await res.json();
}

function executeToolCall(name, args, appState, callbacks, actions) {
  const { reqs, claims, docs } = appState;
  const { setTab, updateReq, updateClaim, updateDoc, addDoc, removeDoc } = callbacks;

  switch (name) {
    case "navigate_tab":
      setTab(args.tab);
      actions.push({ icon: "map-pin", summary: "Navigated to " + args.tab + " tab" });
      return { success: true, navigatedTo: args.tab };

    case "update_requisition": {
      const req = reqs.find(r => r.id === args.reqId);
      if (!req) return { error: "REQ-" + args.reqId + " not found" };
      updateReq(args.reqId, args.updates);
      actions.push({ icon: "dollar", summary: "Updated REQ-" + String(args.reqId).padStart(2, "0") + ": " + Object.keys(args.updates).join(", ") });
      return { success: true, updated: "REQ-" + args.reqId };
    }

    case "flag_requisition": {
      const req = reqs.find(r => r.id === args.reqId);
      if (!req) return { error: "REQ-" + args.reqId + " not found" };
      let flags = [...req.flags];
      if (args.action === "add" && !flags.includes(args.flag)) flags.push(args.flag);
      if (args.action === "remove") flags = flags.filter(f => f !== args.flag);
      updateReq(args.reqId, { flags });
      actions.push({ icon: "flag", summary: (args.action === "add" ? "Added" : "Removed") + ' flag "' + args.flag + '" on REQ-' + String(args.reqId).padStart(2, "0") });
      return { success: true, flags };
    }

    case "update_claim": {
      const claim = claims.find(c => c.id === args.claimId);
      if (!claim) return { error: "Claim #" + args.claimId + " not found" };
      updateClaim(args.claimId, args.updates);
      actions.push({ icon: "scale", summary: "Updated claim #" + args.claimId + ": " + Object.keys(args.updates).join(", ") });
      return { success: true };
    }

    case "add_document": {
      const id = "doc-ai-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 6);
      addDoc({
        id, category: args.category || "other", name: args.name,
        date: args.date || new Date().toISOString().slice(0, 10),
        description: args.description || "", parties: args.parties || "",
        status: args.status || "draft", notes: args.notes || "",
        tags: args.tags || [], linkedReqs: args.linkedReqs || [],
        storagePath: null, fileName: null, fileSize: 0, mimeType: null,
        extractedText: null, vendor: null, costCode: null
      });
      actions.push({ icon: "file-text", summary: 'Added document "' + args.name + '" (' + (args.category || "other") + ")" });
      return { success: true, docId: id };
    }

    case "update_document": {
      const doc = docs.find(d => d.id === args.docId);
      if (!doc) return { error: "Document " + args.docId + " not found" };
      updateDoc(args.docId, args.updates);
      actions.push({ icon: "edit", summary: 'Updated "' + doc.name + '": ' + Object.keys(args.updates).join(", ") });
      return { success: true };
    }

    case "search_documents": {
      const q = (args.query || "").toLowerCase();
      const results = docs.filter(d => {
        if (args.category && d.category !== args.category) return false;
        return d.name.toLowerCase().includes(q) || (d.description || "").toLowerCase().includes(q)
          || (d.tags || []).some(t => t.toLowerCase().includes(q))
          || (d.extractedText || "").toLowerCase().includes(q)
          || (d.vendor || "").toLowerCase().includes(q) || (d.notes || "").toLowerCase().includes(q);
      }).slice(0, 10).map(d => ({ id: d.id, name: d.name, category: d.category, date: d.date, tags: (d.tags || []).slice(0, 5), hasFile: !!d.storagePath, status: d.status }));
      return { results, totalMatches: results.length };
    }

    case "analyze_document": {
      const doc = docs.find(d => d.id === args.docId);
      if (!doc) return { error: "Document " + args.docId + " not found" };
      return { id: doc.id, name: doc.name, category: doc.category, date: doc.date, parties: doc.parties, status: doc.status, tags: doc.tags, linkedReqs: doc.linkedReqs, vendor: doc.vendor, costCode: doc.costCode, extractedText: (doc.extractedText || "").slice(0, 2000), notes: doc.notes };
    }

    case "case_summary": {
      const focus = args.focus || "full";
      const summary = {};
      if (focus === "full" || focus === "financial") {
        summary.financial = { totalBilled: reqs.reduce((s, r) => s + (r.totalBilled || 0), 0), totalExcel: reqs.reduce((s, r) => s + (r.excelTotal || 0), 0), totalRetainage: reqs.reduce((s, r) => s + (r.retainageHeld || 0), 0) };
      }
      if (focus === "full" || focus === "risk") {
        const dist = { HIGH: 0, MEDIUM: 0, LOW: 0, CLEAR: 0 };
        reqs.forEach(r => dist[computeRisk(r)]++);
        summary.risk = dist;
      }
      if (focus === "full" || focus === "claims") {
        summary.claims = { total: claims.length, totalOwner: claims.reduce((s, c) => s + c.ownerAmount, 0), totalAgreed: claims.reduce((s, c) => s + c.agreedAmount, 0), disputed: claims.filter(c => c.status === "DISPUTED").length, agreed: claims.filter(c => c.status === "AGREED").length };
      }
      if (focus === "full" || focus === "documents") {
        summary.documents = { total: docs.length, withFiles: docs.filter(d => d.storagePath).length };
      }
      return summary;
    }

    default:
      return { error: "Unknown tool: " + name };
  }
}

async function handleAIRequest(userMessage, appState, callbacks) {
  const { tab, reqs, claims, docs } = appState;
  const systemPrompt = buildSystemPrompt(tab, reqs, claims, docs);
  const contextHints = buildContextHints(userMessage, reqs, claims, docs);
  let messages = [{ role: "user", content: userMessage + contextHints }];
  const actions = [];

  for (let round = 0; round < 5; round++) {
    const result = await callOpenAI(messages, AI_TOOLS, systemPrompt);
    const choice = result.choices[0];

    if (choice.finish_reason === "stop" || !choice.message.tool_calls) {
      return { text: choice.message.content || "Done.", actions };
    }

    messages.push(choice.message);
    for (const tc of choice.message.tool_calls) {
      const args = JSON.parse(tc.function.arguments);
      const toolResult = executeToolCall(tc.function.name, args, appState, callbacks, actions);
      messages.push({ role: "tool", tool_call_id: tc.id, content: JSON.stringify(toolResult) });
    }
  }
  return { text: "Completed all requested actions.", actions };
}

// ── AI Auto-Analysis on Upload ───────────────────────────────────────────────
async function analyzeUploadedDoc(doc, extractedText, reqs) {
  const apiKey = window._openaiKey;
  if (!apiKey || !extractedText) return null;

  const reqSummary = reqs.map(r => "REQ-" + String(r.id).padStart(2, "0") + ": " + (r.date || "no date") + ", " + fmtDollar(r.totalBilled)).join("\n");

  const prompt = `Analyze this document for a construction case (Montana Contracting v. Tharp, AIA A110 Cost-Plus). REQ-16 (Jan 2024) is the FINAL INVOICE.

DOCUMENT: "${doc.name}" (category: ${doc.category}, current status: ${doc.status})
Current tags: [${(doc.tags || []).join(", ")}]

TEXT (first 2000 chars):
${extractedText.slice(0, 2000)}

REQUISITION PERIODS:
${reqSummary}

Return JSON with applicable enhancements:
{"category":"best fit","status":"best status","description":"1-line description","tags":["additional tags"],"linkedReqs":["REQ-XX"],"vendor":"vendor name","costCode":"XX — Name","notes":"audit observations"}

STATUS OPTIONS: "draft" (working doc), "submitted" (sent by MC), "received" (from other party/sub), "filed" (formally filed/recorded), "confirmed" (verified by both sides), "active" (ongoing/in-use), "disputed" (contested), "final" (locked/complete).
Choose the status that best fits what this document IS — not "draft" unless it truly is an unfinished document.
Only include fields you can confidently determine. Return valid JSON only.`;

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
      body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], temperature: 0.2, max_tokens: 512, response_format: { type: "json_object" } })
    });
    if (!res.ok) return null;
    const data = await res.json();
    const ai = JSON.parse(data.choices[0].message.content);

    const updates = {};
    if (ai.category && ai.category !== doc.category && doc.category === "other") updates.category = ai.category;
    const validStatuses = ["draft","submitted","received","filed","confirmed","active","disputed","final"];
    if (ai.status && validStatuses.includes(ai.status)) updates.status = ai.status;
    if (ai.description) updates.description = ai.description;
    const mergedTags = [...new Set([...(doc.tags || []), ...(ai.tags || [])])];
    if (mergedTags.length > (doc.tags || []).length) updates.tags = mergedTags;
    const mergedReqs = [...new Set([...(doc.linkedReqs || []), ...(ai.linkedReqs || [])])];
    if (mergedReqs.length > (doc.linkedReqs || []).length) updates.linkedReqs = mergedReqs;
    if (ai.vendor && !doc.vendor) updates.vendor = ai.vendor;
    if (ai.costCode && !doc.costCode) updates.costCode = ai.costCode;
    if (ai.notes) updates.notes = (doc.notes ? doc.notes + "\n\n" : "") + "AI: " + ai.notes;
    return Object.keys(updates).length > 0 ? updates : null;
  } catch (err) {
    console.warn("[AI] Upload analysis failed:", err.message);
    return null;
  }
}

// ── AI Command Bar ───────────────────────────────────────────────────────────
function CommandBar({ tab, setTab, reqs, updateReq, claims, updateClaim, docs, updateDoc, addDoc, removeDoc }) {
  const [open, setOpen] = useState(false);
  const [input, setInput] = useState("");
  const [messages, setMessages] = useState([]);
  const [loading, setLoading] = useState(false);
  const [apiKey, setApiKey] = useState(window._openaiKey || "");
  const [keyInput, setKeyInput] = useState("");
  const [showSettings, setShowSettings] = useState(false);
  const messagesEndRef = React.useRef(null);

  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

  useEffect(() => {
    const handler = (e) => { if ((e.ctrlKey || e.metaKey) && e.key === "k") { e.preventDefault(); setOpen(prev => !prev); } };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, []);

  const saveApiKey = (key) => {
    const k = key.trim();
    localStorage.setItem("tharp-openai-key", k);
    window._openaiKey = k;
    setApiKey(k);
    setKeyInput("");
    setShowSettings(false);
  };

  const handleSend = async () => {
    if (!input.trim() || loading) return;
    const userMsg = input.trim();
    setInput("");
    setMessages(prev => [...prev, { role: "user", content: userMsg }]);
    setLoading(true);
    try {
      const result = await handleAIRequest(userMsg,
        { tab, reqs, claims, docs },
        { setTab, updateReq, updateClaim, updateDoc, addDoc, removeDoc }
      );
      setMessages(prev => [...prev, { role: "assistant", content: result.text, actions: result.actions }]);
    } catch (err) {
      setMessages(prev => [...prev, { role: "assistant", content: "Error: " + err.message, actions: [] }]);
    } finally {
      setLoading(false);
    }
  };

  if (!open) {
    return (
      <button onClick={() => setOpen(true)} style={{
        position: "fixed", bottom: 24, right: 28, zIndex: 1000,
        padding: "12px 22px", borderRadius: 28,
        background: T.navBg, color: "#fff", border: "none",
        cursor: "pointer", fontFamily: T.font, fontSize: 13, fontWeight: 500,
        boxShadow: T.sh3,
        display: "flex", alignItems: "center", gap: 8, transition: T.med,
      }}>
        <Ic name="zap" size={15} color="#fff" /> Ask AI
        <span style={{ fontSize: 10, color: T.navText, marginLeft: 4 }}>Ctrl+K</span>
      </button>
    );
  }

  return (
    <div style={{
      position: "fixed", bottom: 24, right: 28, zIndex: 1000,
      width: 420, maxHeight: 540, borderRadius: 16,
      background: T.surface, border: `1px solid ${T.border}`,
      boxShadow: T.sh3,
      display: "flex", flexDirection: "column", fontFamily: T.font,
    }}>
      {/* Header */}
      <div style={{
        padding: "12px 16px", borderBottom: `1px solid ${T.border}`,
        display: "flex", justifyContent: "space-between", alignItems: "center",
      }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <Ic name="zap" size={14} color={T.accent} />
          <span style={{ fontSize: 13, fontWeight: 600, color: T.text }}>AI Assistant</span>
          <span style={{ fontSize: 10, color: T.textMuted }}>· {tab}</span>
        </div>
        <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
          <button onClick={() => setShowSettings(!showSettings)} title="Settings" style={{
            background: "none", border: "none", cursor: "pointer", fontSize: 14,
            color: T.textMuted, lineHeight: 1, padding: "2px 6px",
          }}><Ic name="settings" size={14} color={T.textMuted} /></button>
          <button onClick={() => setOpen(false)} style={{
            background: "none", border: "none", cursor: "pointer", fontSize: 18,
            color: T.textMuted, lineHeight: 1, padding: "2px 6px",
          }}>×</button>
        </div>
      </div>

      {/* Settings Panel */}
      {showSettings && (
        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${T.border}`, background: T.bg }}>
          <label style={{ display: "block", fontSize: 11, fontWeight: 600, color: T.textMid, marginBottom: 6, fontFamily: T.font }}>OpenAI API Key</label>
          <div style={{ display: "flex", gap: 6 }}>
            <input type="password" value={keyInput || (apiKey ? "••••••••" + apiKey.slice(-8) : "")}
              onChange={e => setKeyInput(e.target.value)}
              onFocus={() => { if (!keyInput) setKeyInput(""); }}
              placeholder="sk-..."
              style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: `1px solid ${T.border}`, fontSize: 12, fontFamily: T.mono, color: T.text, background: T.surface }} />
            <button onClick={() => saveApiKey(keyInput)} disabled={!keyInput.trim()} style={{
              padding: "6px 12px", borderRadius: 6, cursor: keyInput.trim() ? "pointer" : "default", fontFamily: T.font, fontSize: 11, fontWeight: 600,
              border: "none", background: keyInput.trim() ? T.accent : T.border, color: keyInput.trim() ? "#fff" : T.textMuted,
            }}>Save</button>
          </div>
          <div style={{ fontSize: 10, color: T.textMuted, marginTop: 4, fontFamily: T.font }}>Stored in your browser only — never sent to our servers.</div>
          {apiKey && (
            <button onClick={() => { saveApiKey(""); setKeyInput(""); }} style={{
              marginTop: 6, padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontFamily: T.font, fontSize: 10,
              border: `1px solid ${T.redBorder}`, background: T.redBg, color: T.red,
            }}>Remove Key</button>
          )}
        </div>
      )}

      {/* No API Key Prompt */}
      {!apiKey && !showSettings && (
        <div style={{ padding: "24px 16px", textAlign: "center" }}>
          <div style={{ marginBottom: 10 }}><Ic name="key" size={28} color={T.accent} /></div>
          <div style={{ fontSize: 13, fontWeight: 500, color: T.text, marginBottom: 4, fontFamily: T.font }}>Connect OpenAI</div>
          <div style={{ fontSize: 11, color: T.textMuted, marginBottom: 12, fontFamily: T.font, lineHeight: 1.5 }}>
            Enter your OpenAI API key to enable AI-powered commands, document analysis, and case insights.
          </div>
          <button onClick={() => setShowSettings(true)} style={{
            padding: "8px 20px", borderRadius: 8, cursor: "pointer", fontFamily: T.font, fontSize: 12, fontWeight: 600,
            border: "none", background: T.accent, color: "#fff",
          }}>Add API Key</button>
        </div>
      )}

      {/* Messages */}
      <div style={{
        flex: 1, overflow: "auto", padding: "12px 16px",
        display: "flex", flexDirection: "column", gap: 10,
        maxHeight: 360,
      }}>
        {messages.length === 0 && (
          <div style={{ textAlign: "center", padding: "20px 0", color: T.textMuted, fontSize: 12 }}>
            <div style={{ marginBottom: 8 }}>Ask me anything about the case.</div>
            <div style={{ fontSize: 11, lineHeight: 1.6 }}>
              Try: "Flag REQ-3 as duplicate billing"<br />
              "What's the total disputed amount?"<br />
              "Add a document for the Korth subcontract"
            </div>
          </div>
        )}
        {messages.map((msg, i) => (
          <div key={i}>
            <div style={{
              maxWidth: "85%",
              marginLeft: msg.role === "user" ? "auto" : 0,
              marginRight: msg.role === "assistant" ? "auto" : 0,
              padding: "8px 12px", borderRadius: 12,
              background: msg.role === "user" ? T.accentBg : T.bg,
              border: `1px solid ${msg.role === "user" ? T.accentBorder : T.border}`,
              fontSize: 12, color: T.text, lineHeight: 1.5, whiteSpace: "pre-wrap",
            }}>
              {msg.content}
            </div>
            {msg.actions && msg.actions.length > 0 && (
              <div style={{ marginTop: 6, display: "flex", flexDirection: "column", gap: 3 }}>
                {msg.actions.map((action, j) => (
                  <div key={j} style={{
                    padding: "6px 10px", borderRadius: 8,
                    background: T.greenBg, border: `1px solid ${T.green}22`,
                    fontSize: 10, color: T.green,
                    display: "flex", gap: 6, alignItems: "center",
                  }}>
                    <Ic name={action.icon} size={12} color={T.green} />
                    <span>{action.summary}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        ))}
        {loading && (
          <div style={{ fontSize: 12, color: T.textMuted, padding: "8px 0" }}>Thinking...</div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Input */}
      {apiKey && <div style={{
        padding: "12px 16px", borderTop: `1px solid ${T.border}`,
        display: "flex", gap: 8,
      }}>
        <input
          type="text" value={input}
          onChange={e => setInput(e.target.value)}
          onKeyDown={e => { if (e.key === "Enter") handleSend(); }}
          placeholder="Ask about the case..."
          autoFocus
          style={{
            flex: 1, padding: "8px 12px", borderRadius: 8,
            border: `1px solid ${T.border}`, fontSize: 13,
            fontFamily: T.font, color: T.text, background: T.bg,
          }}
        />
        <button onClick={handleSend} disabled={loading || !input.trim()} style={{
          padding: "8px 16px", borderRadius: 8, cursor: loading ? "default" : "pointer",
          fontFamily: T.font, fontSize: 12, fontWeight: 600,
          border: "none", background: loading ? T.border : T.accent,
          color: loading ? T.textMuted : "#fff",
        }}>
          {loading ? "..." : "Send"}
        </button>
      </div>}
    </div>
  );
}

// ── ROOT ──────────────────────────────────────────────────────────────────────
function App() {
  const [tab, setTab] = useState("dashboard");
  const [reqs, setReqs] = useState(REQS_INITIAL);
  const [claims, setClaims] = useState(OWNER_CLAIMS_INITIAL);
  const [docs, setDocs] = useState(DOCS_INITIAL);
  const [loaded, setLoaded] = useState(false);
  const [saved, setSaved] = useState(false);

  useEffect(() => {
    (async () => {
      const r = await storageGet("tharp-reqs-v3");
      const c = await storageGet("tharp-claims-v3");
      const d = await storageGet("tharp-docs-v1");
      if (r) setReqs(r);
      if (c) setClaims(c);
      if (d) setDocs(d);
      setLoaded(true);
    })();
  }, []);

  const saveReqs = useCallback(async (next) => {
    await storageSet("tharp-reqs-v3", next);
    setSaved(true); setTimeout(() => setSaved(false), 2000);
  }, []);
  const saveClaims = useCallback(async (next) => {
    await storageSet("tharp-claims-v3", next);
    setSaved(true); setTimeout(() => setSaved(false), 2000);
  }, []);
  const saveDocs = useCallback(async (next) => {
    await storageSet("tharp-docs-v1", next);
    setSaved(true); setTimeout(() => setSaved(false), 2000);
  }, []);

  const updateReq = useCallback((id, updates) => {
    setReqs(prev => {
      const next = prev.map(r => r.id === id ? { ...r, ...updates } : r);
      saveReqs(next);
      return next;
    });
  }, [saveReqs]);

  const updateClaim = useCallback((id, updates) => {
    setClaims(prev => {
      const next = prev.map(c => c.id === id ? { ...c, ...updates } : c);
      saveClaims(next);
      return next;
    });
  }, [saveClaims]);

  const updateDoc = useCallback((id, updates) => {
    setDocs(prev => {
      const next = prev.map(d => d.id === id ? { ...d, ...updates } : d);
      saveDocs(next);
      return next;
    });
  }, [saveDocs]);

  const addDoc = useCallback((doc) => {
    setDocs(prev => {
      const next = [...prev, doc];
      saveDocs(next);
      return next;
    });
  }, [saveDocs]);

  const removeDoc = useCallback((id) => {
    setDocs(prev => {
      const next = prev.filter(d => d.id !== id);
      saveDocs(next);
      return next;
    });
  }, [saveDocs]);

  if (!loaded) return (
    <div style={{ background: T.bg, minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: T.font }}>
      <div style={{ fontSize: 14, color: T.textMuted, letterSpacing: 0.5 }}>Loading…</div>
    </div>
  );

  const TABS = [
    { id: "dashboard", label: "Dashboard" },
    { id: "requisitions", label: "Requisitions" },
    { id: "reconciliation", label: "Reconciliation" },
    { id: "audit", label: "Audit Risk" },
    { id: "claims", label: "Owner Claims" },
    { id: "documents", label: "Documents" },
    { id: "simulator", label: "Simulator" },
    { id: "strategy", label: "Strategy" },
  ];

  return (
    <div style={{ background: T.bg, minHeight: "100vh", fontFamily: T.font }}>
      {/* Top Bar */}
      <div style={{ background: T.navBg, padding: "0 32px", display: "flex", alignItems: "center", justifyContent: "space-between", height: 52 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <Ic name="shield" size={16} color={T.accent} />
          <span style={{ fontSize: 14, fontWeight: 600, color: "#FFFFFF", letterSpacing: -0.2, fontFamily: T.font }}>Montana Contracting</span>
          <span style={{ width: 1, height: 16, background: "#333028", display: "inline-block" }}></span>
          <span style={{ fontSize: 12, color: T.navText, fontFamily: T.font }}>Tharp / Bumgardner</span>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
          {saved && <span style={{ fontSize: 11, color: T.green, fontFamily: T.font, display: "flex", alignItems: "center", gap: 4 }}><Ic name="check" size={12} color={T.green} />{"Saved" + (window._storageMode === "cloud" ? " to cloud" : "")}</span>}
          <span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 10, background: window._storageMode === "cloud" ? "#16A34A15" : "#D9770615", color: window._storageMode === "cloud" ? T.green : T.amber, fontFamily: T.font, display: "inline-flex", alignItems: "center", gap: 5 }}><Ic name="cloud" size={12} color={window._storageMode === "cloud" ? T.green : T.amber} />{window._storageMode === "cloud" ? "Cloud" : "Local"}</span>
          <span style={{ fontSize: 11, color: "#5a5648", fontFamily: T.font }}>515 N. Midland Ave, Upper Nyack NY</span>
        </div>
      </div>

      {/* Nav */}
      <div style={{ background: T.surface, borderBottom: `1px solid ${T.border}`, padding: "0 32px", display: "flex", gap: 2 }}>
        {TABS.map(t => (
          <button key={t.id} onClick={() => setTab(t.id)} style={{
            background: "none", border: "none", cursor: "pointer", padding: "14px 18px",
            fontSize: 13, fontWeight: tab === t.id ? 600 : 400, fontFamily: T.font,
            color: tab === t.id ? T.text : T.textMuted,
            borderBottom: tab === t.id ? `3px solid ${T.accent}` : "3px solid transparent",
            marginBottom: -1, transition: T.fast, letterSpacing: -0.1,
          }}>{t.label}</button>
        ))}
      </div>

      {/* Content */}
      <div style={{ padding: "32px 32px", maxWidth: 1400, margin: "0 auto" }}>
        {tab === "dashboard" && <Dashboard reqs={reqs} claims={claims} />}
        {tab === "requisitions" && <Requisitions reqs={reqs} updateReq={updateReq} docs={docs} updateDoc={updateDoc} addDoc={addDoc} />}
        {tab === "reconciliation" && <Reconciliation reqs={reqs} />}
        {tab === "audit" && <AuditRisk reqs={reqs} />}
        {tab === "claims" && <Claims claims={claims} updateClaim={updateClaim} />}
        {tab === "documents" && <Documents docs={docs} updateDoc={updateDoc} addDoc={addDoc} removeDoc={removeDoc} />}
        {tab === "simulator" && <ArbitrationSimulator reqs={reqs} claims={claims} />}
        {tab === "strategy" && <Strategy claims={claims} reqs={reqs} />}
      </div>

      {/* AI Assistant */}
      <CommandBar
        tab={tab} setTab={setTab}
        reqs={reqs} updateReq={updateReq}
        claims={claims} updateClaim={updateClaim}
        docs={docs} updateDoc={updateDoc} addDoc={addDoc} removeDoc={removeDoc}
      />
    </div>
  );
}


ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>